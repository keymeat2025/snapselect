<!DOCTYPE html photographer-dashboard.html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SnapSelect - Photographer Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/variables.css">
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/dashboard.css">
    <link rel="stylesheet" href="../assets/css/responsive.css">
    <link rel="stylesheet" href="../assets/css/user-menu.css">
    <link rel="stylesheet" href="../assets/css/animations.css">
    <link rel="stylesheet" href="../assets/css/features.css">
    <link rel="stylesheet" href="../assets/css/payment.css">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>
<body>
    <header>
        <div class="container">
            <nav>
                <a href="../index.html" class="logo">
                    <div class="logo-text">SnapSelect</div>
                </a>
                <ul class="nav-links">
                    <li><a href="../index.html#features">Features</a></li>
                    <li><a href="../index.html#how-it-works">How It Works</a></li>
                    <li><a href="../index.html#pricing">Pricing</a></li>
                </ul>
                <div class="right-nav">
                    <div class="auth-user" id="userNav">
                        <div class="user-menu">
                            <button class="user-menu-btn" id="userMenuBtn">
                                <div class="avatar-placeholder">U</div>
                                <span class="user-name" id="userName">User</span>
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <div class="user-dropdown" id="userDropdown">
                                <a href="photographer-dashboard.html" class="active">Dashboard</a>
                                <a href="analytics.html">Analytics</a>
                                <a href="account-settings.html">Account Settings</a>
                                <a href="#" id="logoutBtn">Logout</a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="hamburger">
                    <i class="fas fa-bars"></i>
                </div>
            </nav>
        </div>
    </header>

    <main class="dashboard-main">
        <div class="container">
            <section class="plan-info animate-in">
                <div class="plan-card">
                    <div class="plan-header">
                        <h3>Current Plan: <span id="currentPlanName">Free</span></h3>
                        <span class="plan-badge" id="planBadge">Free</span>
                    </div>
                    <div class="plan-details">
                        <div class="plan-usage">
                            <div class="usage-item">
                                <span class="usage-label">Storage:</span>
                                <div class="usage-bar">
                                    <div class="usage-progress" id="storageUsageBar" style="width: 0%"></div>
                                </div>
                                <span class="usage-text" id="storageUsageText">0/1 GB</span>
                            </div>
                            <div class="usage-item">
                                <span class="usage-label">Galleries:</span>
                                <div class="usage-bar">
                                    <div class="usage-progress" id="galleryUsageBar" style="width: 0%"></div>
                                </div>
                                <span class="usage-text" id="galleryUsageText">0/3</span>
                            </div>
                        </div>
                        <button id="upgradePlanBtn" class="btn upgrade-btn">Upgrade Plan</button>
                    </div>
                </div>
            </section>

            <!-- Plan Upgrade Modal -->
            <div id="upgradePlanModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Upgrade Your Plan</h2>
                        <button class="close-modal">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="plan-comparison">
                            <div class="plan-tabs">
                                <button class="plan-tab" data-plan="basic">Basic</button>
                                <button class="plan-tab" data-plan="pro">Pro</button>
                                <button class="plan-tab" data-plan="premium">Premium</button>
                            </div>
                            
                            <div id="planDetailsSection" class="current-vs-selected">
                                <div class="plan-column current">
                                    <h3>Current Plan</h3>
                                    <div class="plan-name" id="currentPlanDisplay">Free</div>
                                    <div class="plan-price" id="currentPlanPrice">₹0/month</div>
                                    <ul class="plan-features" id="currentPlanFeatures">
                                        <li>1 GB Storage</li>
                                        <li>3 Galleries</li>
                                        <li>50 Photos per gallery</li>
                                        <li>3-day client selection window</li>
                                    </ul>
                                </div>
                                <div class="plan-column selected">
                                    <h3>Selected Plan</h3>
                                    <div class="plan-name" id="selectedPlanName">Basic</div>
                                    <div class="plan-price" id="selectedPlanPrice">₹499</div>
                                    <ul class="plan-features" id="planFeaturesList">
                                        <li>15 GB Storage</li>
                                        <li>10 Galleries</li>
                                        <li>500 Photos per gallery</li>
                                        <li>30-day client selection window</li>
                                        <li>Advanced uploads</li>
                                        <li>Password protection</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div class="payment-section">
                                <div class="payment-success alert-success" style="display: none;"></div>
                                <div class="payment-error alert-danger" style="display: none;"></div>
                                
                                <h3>Complete Your Upgrade</h3>
                                <p class="payment-info">Click the button below to proceed securely with Razorpay.</p>
                                
                                <form id="paymentForm">
                                    <div class="payment-options">
                                        <div class="payment-option">
                                            <div class="payment-logo-icon">
                                                <i class="fas fa-credit-card"></i>
                                            </div>
                                            <div class="payment-description">
                                                <p>Secure payment via Razorpay</p>
                                                <div class="payment-methods">
                                                    <i class="fas fa-credit-card"></i>
                                                    <i class="fas fa-university"></i>
                                                    <i class="fab fa-cc-visa"></i>
                                                    <i class="fab fa-cc-mastercard"></i>
                                                    <i class="fab fa-google-pay"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-actions">
                                        <button type="button" class="btn secondary" id="cancelUpgradeBtn">Cancel</button>
                                        <button type="submit" class="btn primary" id="confirmUpgradeBtn">Upgrade Now</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="dashboard-footer">
        <div class="container">
            <div class="footer-bottom">
                <p class="copyright">&copy; 2025 SnapSelect. All rights reserved.</p>
                <div class="footer-links">
                    <a href="#">Privacy Policy</a>
                    <a href="#">Terms of Service</a>
                    <a href="#" id="footerHelpLink">Help Center</a>
                </div>
            </div>
        </div>
    </footer>

    <!-- Streamlined Razorpay Implementation -->
    <script>
        // Store email in localStorage for Razorpay
        localStorage.setItem('userEmail', 'test.user@example.com');
        
        // Subscription plans
        const SUBSCRIPTION_PLANS = {
            basic: {
                name: 'Basic',
                price: 499,
                features: ['15 GB Storage', '10 Galleries', '500 Photos per gallery', '30-day client selection window', 'Advanced uploads', 'Password protection']
            },
            pro: {
                name: 'Pro',
                price: 999,
                features: ['50 GB Storage', 'Unlimited Galleries', '1000 Photos per gallery', '60-day client selection window', 'Advanced uploads', 'Password protection', 'Priority support']
            },
            premium: {
                name: 'Premium',
                price: 1999,
                features: ['100 GB Storage', 'Unlimited Galleries', 'Unlimited Photos', '90-day client selection window', 'Advanced uploads', 'Password protection', 'Priority support', 'Advanced analytics']
            }
        };

        // Global variables
        let selectedPlan = null;
        let currentPlan = 'Free';

        // Main initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Firebase services with correct region
            if (window.firebaseServices && window.firebaseServices.functions) {
                // Set the region to asia-south1 (India)
                window.firebaseServices.functions = firebase.app().functions("asia-south1");
            }
            
            // DOM elements for Razorpay
            const upgradePlanBtn = document.getElementById('upgradePlanBtn');
            const upgradePlanModal = document.getElementById('upgradePlanModal');
            const closeModalBtn = document.querySelector('#upgradePlanModal .close-modal');
            const planTabs = document.querySelectorAll('.plan-tab');
            const selectedPlanNameEl = document.getElementById('selectedPlanName');
            const selectedPlanPriceEl = document.getElementById('selectedPlanPrice');
            const planFeaturesListEl = document.getElementById('planFeaturesList');
            const confirmUpgradeBtn = document.getElementById('confirmUpgradeBtn');
            const cancelUpgradeBtn = document.getElementById('cancelUpgradeBtn');
            const currentPlanNameEl = document.getElementById('currentPlanName');
            const paymentSuccessEl = document.querySelector('.payment-success');
            const paymentErrorEl = document.querySelector('.payment-error');
            
            // Update plan display
            function updatePlanDisplay(planType) {
                const plan = SUBSCRIPTION_PLANS[planType];
                if (!plan) return;
                
                // Update plan name and price
                if (selectedPlanNameEl) selectedPlanNameEl.textContent = plan.name;
                if (selectedPlanPriceEl) selectedPlanPriceEl.textContent = `₹${plan.price}`;
                
                // Update features list
                if (planFeaturesListEl) {
                    planFeaturesListEl.innerHTML = '';
                    plan.features.forEach(feature => {
                        const li = document.createElement('li');
                        li.textContent = feature;
                        planFeaturesListEl.appendChild(li);
                    });
                }
            }

            // Show payment progress
            function showPaymentProgress(message) {
                if (paymentSuccessEl) paymentSuccessEl.style.display = 'none';
                if (paymentErrorEl) paymentErrorEl.style.display = 'none';
                
                if (confirmUpgradeBtn) {
                    confirmUpgradeBtn.disabled = true;
                    confirmUpgradeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                }
            }

            // Show payment success
            function showPaymentSuccess(message) {
                if (paymentSuccessEl) {
                    paymentSuccessEl.textContent = message;
                    paymentSuccessEl.style.display = 'block';
                }
                
                if (paymentErrorEl) {
                    paymentErrorEl.style.display = 'none';
                }
                
                if (confirmUpgradeBtn) {
                    confirmUpgradeBtn.disabled = false;
                    confirmUpgradeBtn.innerHTML = 'Upgrade Complete!';
                }
            }

            // Show payment error
            function showPaymentError(message) {
                if (paymentErrorEl) {
                    paymentErrorEl.textContent = message;
                    paymentErrorEl.style.display = 'block';
                }
                
                if (paymentSuccessEl) {
                    paymentSuccessEl.style.display = 'none';
                }
                
                if (confirmUpgradeBtn) {
                    confirmUpgradeBtn.disabled = false;
                    confirmUpgradeBtn.innerHTML = 'Try Again';
                }
            }

            // Reset payment buttons
            function resetPaymentButtons() {
                if (confirmUpgradeBtn) {
                    confirmUpgradeBtn.disabled = false;
                    confirmUpgradeBtn.innerHTML = 'Upgrade Now';
                }
            }

            // Process payment - FIXED FUNCTION 
            async function processPayment(planType) {
                try {
                    // Show loading state
                    showPaymentProgress('Processing your request...');
                    
                    // Check if user is authenticated
                    if (!firebase.auth().currentUser) {
                        showPaymentError("You must be logged in to make a payment");
                        setTimeout(resetPaymentButtons, 3000);
                        return;
                    }
                    
                    // Check if plan type exists
                    if (!SUBSCRIPTION_PLANS || !SUBSCRIPTION_PLANS[planType]) {
                        throw new Error(`Invalid plan selected: ${planType}`);
                    }
                    
                    // Get plan details
                    const plan = SUBSCRIPTION_PLANS[planType];
                    
                    // FIXED: Correctly initialize functions with region
                    const functions = firebase.app().functions("asia-south1");
                    
                    // Log for debugging
                    console.log("Calling createPaymentOrder with::", { planType, amount: plan.price });
                    
                    // Call the Firebase function
                    const createPaymentOrder = functions.httpsCallable('createPaymentOrder');
                    const orderResponse = await createPaymentOrder({
                        planType,
                        amount: plan.price
                    });
                    
                    // Log the response for debugging
                    console.log("CreatePaymentOrder response:", orderResponse.data);
                    
                    // Get order data from response
                    const orderData = orderResponse.data;
                    
                    if (!orderData || !orderData.orderId) {
                        throw new Error('Invalid response from payment order creation');
                    }
                    
                    // Configure Razorpay options
                    const options = {
                        key: 'rzp_test_k2If7sWFzrbatR',
                        amount: orderData.amount * 100, // Make sure this is in paise
                        currency: orderData.currency || 'INR',
                        name: 'SnapSelect',
                        description: `${plan.name} Plan Subscription`,
                        order_id: orderData.orderId,
                        handler: function(response) {
                            // After payment is complete, verify the payment
                            const verifyPaymentFunction = functions.httpsCallable('verifyPayment');
                            verifyPaymentFunction({
                                orderId: orderData.orderId,
                                paymentId: response.razorpay_payment_id,
                                signature: response.razorpay_signature
                            }).then(verifyResponse => {
                                const responseData = verifyResponse.data;
                                if (responseData.success) {
                                    showPaymentSuccess(`Payment successful! Your subscription has been upgraded to ${selectedPlan}.`);
                                    
                                    // Update UI after a short delay
                                    setTimeout(() => {
                                        if (upgradePlanModal) upgradePlanModal.style.display = 'none';
                                        
                                        // Update current plan
                                        if (currentPlanNameEl) currentPlanNameEl.textContent = SUBSCRIPTION_PLANS[selectedPlan].name;
                                        
                                        // Update plan badge
                                        const planBadge = document.getElementById('planBadge');
                                        if (planBadge) planBadge.textContent = SUBSCRIPTION_PLANS[selectedPlan].name;
                                        
                                        currentPlan = SUBSCRIPTION_PLANS[selectedPlan].name;
                                    }, 2000);
                                } else {
                                    throw new Error('Payment verification failed');
                                }
                            }).catch(error => {
                                console.error('Payment verification error:', error);
                                showPaymentError(`Payment verification failed: ${error.message}`);
                                setTimeout(resetPaymentButtons, 3000);
                            });
                        },
                        prefill: {
                            name: document.getElementById('userName').textContent,
                            email: localStorage.getItem('userEmail') || '',
                        },
                        theme: {
                            color: '#4A90E2'
                        },
                        modal: {
                            ondismiss: function() {
                                resetPaymentButtons();
                            }
                        }
                    };
                    
                    // Open Razorpay checkout
                    const razorpay = new Razorpay(options);
                    razorpay.open();
                    
                } catch (error) {
                    console.error('Payment process error:', error);
                    // Log the full error details for debugging
                    if (error.code) console.error('Error code:', error.code);
                    if (error.details) console.error('Error details:', error.details);
                    
                    showPaymentError(`Payment failed: ${error.message}`);
                    setTimeout(resetPaymentButtons, 3000);
                }
            }

            // Verify payment - FIXED FUNCTION
            async function verifyPayment(orderId, paymentId, signature) {
                try {
                    showPaymentProgress('Verifying payment...');
                    
                    // FIXED: Correctly initialize functions with region
                    const functions = firebase.app().functions("asia-south1");
                    
                    // Call the Firebase function to verify payment
                    const verifyPaymentFunction = functions.httpsCallable('verifyPayment');
                    const verifyResponse = await verifyPaymentFunction({
                        orderId: orderId,
                        paymentId: paymentId,
                        signature: signature
                    });
                    
                    // Check response
                    const responseData = verifyResponse.data;
                    
                    if (responseData.success) {
                        // Payment successful
                        showPaymentSuccess(`Payment successful! Your subscription has been upgraded to ${selectedPlan}.`);
                        
                        // Update UI after a short delay
                        setTimeout(() => {
                            if (upgradePlanModal) upgradePlanModal.style.display = 'none';
                            
                            // Update current plan
                            if (currentPlanNameEl) currentPlanNameEl.textContent = SUBSCRIPTION_PLANS[selectedPlan].name;
                            
                            // Update plan badge
                            const planBadge = document.getElementById('planBadge');
                            if (planBadge) planBadge.textContent = SUBSCRIPTION_PLANS[selectedPlan].name;
                            
                            currentPlan = SUBSCRIPTION_PLANS[selectedPlan].name;
                        }, 2000);
                    } else {
                        throw new Error('Payment verification failed');
                    }
                    
                } catch (error) {
                    console.error('Payment verification error:', error);
                    showPaymentError(`Payment verification failed: ${error.message}`);
                    setTimeout(resetPaymentButtons, 3000);
                }
            }

            // Plan tabs click
            planTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remove active class from all tabs
                    planTabs.forEach(t => t.classList.remove('active'));
                    // Add active class to clicked tab
                    this.classList.add('active');
                    
                    // Update selected plan
                    selectedPlan = this.getAttribute('data-plan');
                    updatePlanDisplay(selectedPlan);
                });
            });

            // Upgrade button click - shows the modal
            if (upgradePlanBtn) {
                upgradePlanBtn.addEventListener('click', function() {
                    if (upgradePlanModal) {
                        upgradePlanModal.style.display = 'block';
                        
                        // Set default selected plan (Basic)
                        const basicPlanTab = document.querySelector('.plan-tab[data-plan="basic"]');
                        if (basicPlanTab) {
                            basicPlanTab.click();
                        }
                    }
                });
            }

            // Close button click - hides the modal
            if (closeModalBtn) {
                closeModalBtn.addEventListener('click', function() {
                    if (upgradePlanModal) {
                        upgradePlanModal.style.display = 'none';
                    }
                });
            }

            // Cancel button click - hides the modal
            if (cancelUpgradeBtn) {
                cancelUpgradeBtn.addEventListener('click', function() {
                    if (upgradePlanModal) {
                        upgradePlanModal.style.display = 'none';
                    }
                });
            }

            // Confirm upgrade button click - starts payment process
            if (confirmUpgradeBtn) {
                confirmUpgradeBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (selectedPlan) {
                        processPayment(selectedPlan);
                    }
                });
            }
            
            // Set default selected plan on load
            if (document.querySelector('.plan-tab[data-plan="basic"]')) {
                document.querySelector('.plan-tab[data-plan="basic"]').click();
            }
        }); 
    </script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>
    <script src="../assets/js/firebase-config.js"></script>
    <script src="../assets/js/firebase-auth.js"></script>
    <script src="../assets/js/firebase-db.js"></script>
    <script src="../assets/js/header-auth.js"></script>
    <script src="../assets/js/razorpay.js"></script>
</body>
</html>
