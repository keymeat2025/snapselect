clientSelect.addEventListener('change', function() {
                    if (this.value === 'new') {
                        newClientForm.style.display = 'block';
                    } else {
                        newClientForm.style.display = 'none';
                    }
                });
            }
            
            // Modal close buttons
            document.querySelectorAll('.close-modal').forEach(button => {
                button.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    if (modal) {
                        modal.style.display = 'none';
                    }
                });
            });
            
            // Click outside modal to close
            window.addEventListener('click', function(event) {
                if (event.target.classList.contains('modal')) {
                    event.target.style.display = 'none';
                }
            });
            
            // Empty state buttons
            const emptyStateUpgradeBtn = document.getElementById('emptyStateUpgradeBtn');
            if (emptyStateUpgradeBtn) {
                emptyStateUpgradeBtn.addEventListener('click', function() {
                    const upgradePlanModal = document.getElementById('upgradePlanModal');
                    if (upgradePlanModal) {
                        upgradePlanModal.style.display = 'block';
                    }
                });
            }
            
            const emptyStateCreateClientBtn = document.getElementById('emptyStateCreateClientBtn');
            if (emptyStateCreateClientBtn) {
                emptyStateCreateClientBtn.addEventListener('click', function() {
                    const createClientModal = document.getElementById('createClientModal');
                    if (createClientModal) {
                        createClientModal.style.display = 'block';
                    }
                });
            }
            
            const emptyStateCreateGalleryBtn = document.getElementById('emptyStateCreateGalleryBtn');
            if (emptyStateCreateGalleryBtn) {
                emptyStateCreateGalleryBtn.addEventListener('click', function() {
                    // Use the new function from subscription manager
                    if (window.subscriptionManager && window.subscriptionManager.showCreateGalleryModal) {
                        window.subscriptionManager.showCreateGalleryModal();
                    } else {
                        // Fallback if function not available
                        const createGalleryModal = document.getElementById('createGalleryModal');
                        if (createGalleryModal) {
                            createGalleryModal.style.display = 'block';
                        }
                    }
                });
            }
            
            // Create client form submission
            const createClientForm = document.getElementById('createClientForm');
            if (createClientForm) {
                createClientForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const clientName = document.getElementById('clientName').value;
                    const clientEmail = document.getElementById('clientEmail').value;
                    const clientPhone = document.getElementById('clientPhone').value;
                    const clientNotes = document.getElementById('clientNotes').value;
                    
                    try {
                        // Show loading
                        const loadingOverlay = document.getElementById('loadingOverlay');
                        if (loadingOverlay) {
                            loadingOverlay.querySelector('.loading-text').textContent = 'Creating client...';
                            loadingOverlay.style.display = 'flex';
                        }
                        
                        // Check if subscription manager exists
                        if (window.subscriptionManager && window.subscriptionManager.createClient) {
                            // Create client
                            const clientId = await window.subscriptionManager.createClient(
                                clientName,
                                clientEmail,
                                { phone: clientPhone, notes: clientNotes }
                            );
                            
                            if (clientId) {
                                // Close modal
                                const createClientModal = document.getElementById('createClientModal');
                                if (createClientModal) {
                                    createClientModal.style.display = 'none';
                                }
                                
                                // Use the notification system instead of direct DOM manipulation
                                if (window.NotificationSystem) {
                                    window.NotificationSystem.createNotificationFromEvent({
                                        type: 'client_created',
                                        clientName: clientName
                                    });
                                }
                                
                                // Refresh client data
                                if (window.subscriptionManager.refreshSubscription) {
                                    window.subscriptionManager.refreshSubscription();
                                }
                            }
                        } else {
                            throw new Error('Client management functionality is not available');
                        }
                    } catch (error) {
                        console.error('Error creating client:', error);
                        
                        // Use notification system for errors too
                        if (window.NotificationSystem) {
                            window.NotificationSystem.showNotification(
                                'error',
                                'Error',
                                `Error creating client: ${error.message}`
                            );
                        }
                    } finally {
                        // Hide loading
                        const loadingOverlay = document.getElementById('loadingOverlay');
                        if (loadingOverlay) {
                            loadingOverlay.style.display = 'none';
                        }
                    }
                });
            }
            
            // Gallery creation button
            const createGalleryBtn = document.getElementById('createGalleryBtn');
            if (createGalleryBtn) {
                createGalleryBtn.addEventListener('click', function() {
                    // Use the new function from subscription manager
                    if (window.subscriptionManager && window.subscriptionManager.showCreateGalleryModal) {
                        window.subscriptionManager.showCreateGalleryModal();
                    } else {
                        // Fallback if function not available
                        const createGalleryModal = document.getElementById('createGalleryModal');
                        if (createGalleryModal) {
                            createGalleryModal.style.display = 'block';
                        }
                    }
                });
            }
            
            // Reset form on modal close
            document.querySelectorAll('.modal .close-modal, .modal .btn.secondary').forEach(button => {
                button.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    if (modal) {
                        const form = modal.querySelector('form');
                        if (form) {
                            form.reset();
                        }
                        
                        // Hide new client form if in upgrade modal
                        if (modal.id === 'upgradePlanModal') {
                            const newClientForm = document.getElementById('newClientForm');
                            if (newClientForm) {
                                newClientForm.style.display = 'none';
                            }
                        }
                    }
                });
            });
            
            // Refresh buttons
            const refreshPlansBtn = document.getElementById('refreshPlansBtn');
            if (refreshPlansBtn) {
                refreshPlansBtn.addEventListener('click', function() {
                    this.classList.add('rotating');
                    
                    // Check if subscription manager exists before calling
                    if (window.subscriptionManager && window.subscriptionManager.refreshSubscription) {
                        window.subscriptionManager.refreshSubscription();
                        
                        // Also refresh galleries if gallery manager exists
                        if (window.galleryManager && window.galleryManager.loadGalleries) {
                            window.galleryManager.loadGalleries();
                        }
                        
                        // Use notification system to show refresh confirmation
                        if (window.NotificationSystem) {
                            window.NotificationSystem.showNotification(
                                'success',
                                'Success',
                                'Data refreshed successfully'
                            );
                        }
                    }
                    
                    // Remove rotating class after animation completes
                    setTimeout(() => {
                        this.classList.remove('rotating');
                    }, 1000);
                });
            }
            
            // Link to galleries page
            const viewAllGalleriesBtn = document.getElementById('viewAllGalleriesBtn');
            if (viewAllGalleriesBtn) {
                viewAllGalleriesBtn.addEventListener('click', function() {
                    window.location.href = 'galleries.html';
                });
            }
            
            // Initialize gallery-specific elements now that the DOM is ready
            
            // Upload Photos form file selection
            const photoFilesInput = document.getElementById('photoFiles');
            if (photoFilesInput) {
                photoFilesInput.addEventListener('change', function(e) {
                    const fileCount = this.files.length;
                    const fileCountEl = document.querySelector('.file-count');
                    if (fileCountEl) {
                        fileCountEl.textContent = fileCount > 0 ? 
                            `${fileCount} file${fileCount !== 1 ? 's' : ''} selected` : '';
                    }
                    
                    // Enable upload button if files selected
                    const uploadBtn = document.getElementById('confirmUploadBtn');
                    if (uploadBtn) {
                        uploadBtn.disabled = fileCount === 0;
                    }
                });
            }
            
            // Make upload area act as a drop zone
            const uploadDropzone = document.getElementById('uploadDropzone');
            if (uploadDropzone) {
                // Prevent default behavior to allow drop
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    uploadDropzone.addEventListener(eventName, preventDefaults, false);
                });
                
                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                
                // Highlight drop area when item is dragged over it
                ['dragenter', 'dragover'].forEach(eventName => {
                    uploadDropzone.addEventListener(eventName, highlight, false);
                });
                
                ['dragleave', 'drop'].forEach(eventName => {
                    uploadDropzone.addEventListener(eventName, unhighlight, false);
                });
                
                function highlight() {
                    uploadDropzone.classList.add('highlight');
                }
                
                function unhighlight() {
                    uploadDropzone.classList.remove('highlight');
                }
                
                // Handle dropped files
                uploadDropzone.addEventListener('drop', handleDrop, false);
                
                function handleDrop(e) {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    
                    // Update file input with dropped files
                    const fileInput = document.getElementById('photoFiles');
                    if (fileInput) {
                        // Note: We can't directly set FileList to a file input
                        // This is a limitation of the browser API
                        // Instead, we need to trigger the file dialog or use a different approach
                        
                        // For simplicity, we'll just display the count and enable the button
                        const fileCount = files.length;
                        const fileCountEl = document.querySelector('.file-count');
                        if (fileCountEl) {
                            fileCountEl.textContent = fileCount > 0 ? 
                                `${fileCount} file${fileCount !== 1 ? 's' : ''} selected (dropped)` : '';
                        }
                        
                        // Enable upload button if files selected
                        const uploadBtn = document.getElementById('confirmUploadBtn');
                        if (uploadBtn) {
                            uploadBtn.disabled = fileCount === 0;
                        }
                        
                        // Store the files in a global variable for later use
                        window.droppedFiles = files;
                    }
                }
            }
            
            // Handle uploadPhotosForm submission
            const uploadPhotosForm = document.getElementById('uploadPhotosForm');
            if (uploadPhotosForm) {
                uploadPhotosForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    // Get gallery ID
                    const galleryId = this.getAttribute('data-gallery-id');
                    if (!galleryId) {
                        console.error('No gallery ID found on upload form');
                        return;
                    }
                    
                    // Get files (either from input or dropped)
                    let files = null;
                    const fileInput = document.getElementById('photoFiles');
                    
                    if (fileInput && fileInput.files && fileInput.files.length > 0) {
                        files = fileInput.files;
                    } else if (window.droppedFiles && window.droppedFiles.length > 0) {
                        files = window.droppedFiles;
                    }
                    
                    if (!files || files.length === 0) {
                        if (window.NotificationSystem) {
                            window.NotificationSystem.showNotification(
                                'warning',
                                'No Files',
                                'Please select or drop files to upload'
                            );
                        }
                        return;
                    }
                    
                    // Get options
                    const autoSelectCover = document.getElementById('autoSelectCover').checked;
                    const compressImages = document.getElementById('compressImages').checked;
                    
                    try {
                        // Process the upload using galleryManager
                        if (window.galleryManager && window.galleryManager.handlePhotoUpload) {
                            await window.galleryManager.handlePhotoUpload(galleryId, files, {
                                autoSelectCover,
                                compressImages
                            });
                            
                            // Reset the form and close the modal on success
                            this.reset();
                            document.querySelector('.file-count').textContent = '';
                            document.getElementById('confirmUploadBtn').disabled = true;
                            window.droppedFiles = null;
                            
                            const modal = this.closest('.modal');
                            if (modal) {
                                modal.style.display = 'none';
                            }
                        } else {
                            throw new Error('Gallery upload functionality is not available');
                        }
                    } catch (error) {
                        console.error('Error uploading photos:', error);
                        
                        // Use notification system for errors
                        if (window.NotificationSystem) {
                            window.NotificationSystem.showNotification(
                                'error',
                                'Upload Failed',
                                error.message || 'Failed to upload photos. Please try again.'
                            );
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>
