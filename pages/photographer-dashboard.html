<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SnapSelect - Photographer Dashboard</title>
    <!-- Prevent caching for protected pages -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- CSS Files -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/variables.css">
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/dashboard.css">
    <link rel="stylesheet" href="../assets/css/responsive.css">
    <link rel="stylesheet" href="../assets/css/user-menu.css">
    <link rel="stylesheet" href="../assets/css/animations.css">
    <link rel="stylesheet" href="../assets/css/features.css">
    <link rel="stylesheet" href="../assets/css/payment.css">
    <link rel="stylesheet" href="../assets/css/notification.css">
    <link rel="stylesheet" href="../assets/css/status-bar.css">
    
    <!-- Load critical Firebase scripts first -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="../assets/js/firebase-config.js"></script>
    
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>
<body>
    <!-- Centralized Authentication Check -->
    <script>
    // Enhanced authentication check on page load
    (function() {
        console.log("Running enhanced authentication check on dashboard page load");
        
        // Basic session checks first (these don't need Firebase)
        const userLoggedOut = sessionStorage.getItem('userLoggedOut') === 'true';
        if (userLoggedOut) {
            console.log("User previously logged out - preventing access via back button");
            sessionStorage.removeItem('userLoggedOut');
            window.location.replace('studiopanel-login.html');
            return;
        }
        
        // Check authorization flag
        const hasAuthorizationFlag = sessionStorage.getItem('authorizedAccess') === 'true';
        if (!hasAuthorizationFlag) {
            console.log("No authorization flag found - redirecting to login");
            window.location.replace('studiopanel-login.html');
            return;
        }
        
        // Check for authentication timestamp
        const authTimestamp = sessionStorage.getItem('authTimestamp');
        if (authTimestamp) {
            const elapsedTime = Date.now() - parseInt(authTimestamp);
            const maxSessionTime = 24 * 60 * 60 * 1000; // 24 hours
            
            if (elapsedTime > maxSessionTime) {
                console.log("Session expired - redirecting to login");
                sessionStorage.removeItem('authorizedAccess');
                sessionStorage.removeItem('authTimestamp');
                window.location.replace('studiopanel-login.html');
                return;
            }
        }
        
        // Setup visibility change event listener
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible') {
                // Check authentication when tab becomes visible again
                if (typeof firebase !== 'undefined' && firebase.auth) {
                    const currentUser = firebase.auth().currentUser;
                    if (!currentUser) {
                        console.log("No authenticated user found on visibility change - redirecting to login");
                        sessionStorage.removeItem('authorizedAccess');
                        sessionStorage.removeItem('authTimestamp');
                        window.location.replace('studiopanel-login.html');
                    }
                }
            }
        });
        
        // Setup Firebase auth check using the centralized approach
        if (!window.onFirebaseReady) {
            window.onFirebaseReady = [];
        }
        
        // Add our authentication verification to the queue
        window.onFirebaseReady.push(function() {
            console.log("Firebase ready - performing auth check");
            
            firebase.auth().onAuthStateChanged(function(user) {
                if (!user) {
                    console.log("Firebase auth check failed - no current user");
                    sessionStorage.removeItem('authorizedAccess');
                    sessionStorage.removeItem('authTimestamp');
                    window.location.replace('studiopanel-login.html');
                } else {
                    console.log("Firebase auth verified with user:", user.email);
                    sessionStorage.setItem('authTimestamp', Date.now().toString());
                }
            });
        });
        
        // If Firebase is already initialized, run the auth check
        if (window.firebaseServices && window.firebaseServices.auth) {
            console.log("Firebase already available - running auth check immediately");
            firebase.auth().onAuthStateChanged(function(user) {
                if (!user) {
                    console.log("Firebase auth check failed - no current user");
                    sessionStorage.removeItem('authorizedAccess');
                    sessionStorage.removeItem('authTimestamp');
                    window.location.replace('studiopanel-login.html');
                } else {
                    console.log("Firebase auth verified with user:", user.email);
                    sessionStorage.setItem('authTimestamp', Date.now().toString());
                }
            });
        }
    })();
    </script>

    <!-- Toast Container for Notifications -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading...</div>
    </div>

    <header>
        <div class="container">
            <nav>
                <a href="../index.html" class="logo">
                    <div class="logo-text">SnapSelect</div>
                </a>
                <ul class="nav-links">
                    <li><a href="../index.html#features">Features</a></li>
                    <li><a href="../index.html#how-it-works">How It Works</a></li>
                    <li><a href="../index.html#pricing">Pricing</a></li>
                </ul>
                <div class="right-nav">
                    <div class="auth-user" id="userNav">
                        <div class="user-menu">
                            <button class="user-menu-btn" id="userMenuBtn">
                                <div class="avatar-placeholder">U</div>
                                <span class="user-name" id="userName">User</span>
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <div class="user-dropdown" id="userDropdown">
                                <a href="photographer-dashboard.html" class="active">Dashboard</a>
                                <a href="client-management.html">Clients</a>
                                <a href="analytics.html">Analytics</a>
                                <a href="account-settings.html">Account Settings</a>
                                <a href="admin-dashboard.html" class="admin-only" style="display: none;">Admin Dashboard</a>
                                <a href="#" id="logoutBtn">Logout</a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="hamburger">
                    <i class="fas fa-bars"></i>
                </div>
                <!-- Notification Bell -->
                <div class="notification-container">
                  <button id="notificationBtn" class="notification-btn">
                    <i class="fas fa-bell"></i>
                    <span id="notificationCount" class="notification-badge">0</span>
                  </button>
                  
                  <div id="notificationDropdown" class="notification-dropdown">
                    <div class="notification-header">
                      <h3>Notifications</h3>
                      <button id="markAllReadBtn" class="mark-all-read">Mark all as read</button>
                    </div>
                    <div id="notificationList" class="notification-list">
                      <!-- Notifications will be loaded here -->
                    </div>
                  </div>
                </div>
            </nav>
        </div>
    </header>

    <!-- Account Status Bar - Added for Phase 1 -->
    <div id="accountStatusBar" class="account-status-bar"></div>

    <main class="dashboard-main">
        <div class="container">
            <!-- Dashboard Overview -->
            <section class="dashboard-header">
                <div class="dashboard-title">
                    <h1>Photographer Dashboard</h1>
                    <p>Manage your client plans and galleries</p>
                </div>
                <div class="dashboard-stats">
                    <div class="stat-card animate-in">
                        <div class="stat-icon">
                            <i class="fas fa-images"></i>
                        </div>
                        <div class="stat-info">
                            <span class="stat-value" id="activeGalleriesCount">0</span>
                            <span class="stat-label">Active Galleries</span>
                        </div>
                    </div>
                    <div class="stat-card animate-in" style="animation-delay: 0.1s;">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <span class="stat-value" id="activeClientsCount">0</span>
                            <span class="stat-label">Active Clients</span>
                        </div>
                    </div>
                    <div class="stat-card animate-in" style="animation-delay: 0.2s;">
                        <div class="stat-icon">
                            <i class="fas fa-database"></i>
                        </div>
                        <div class="stat-info">
                            <span class="stat-value" id="storageUsed">0 MB</span>
                            <span class="stat-label">Storage Used</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Storage Usage Section -->
            <section class="plan-info animate-in" style="animation-delay: 0.25s;">
                <div class="plan-card">
                    <div class="plan-header">
                        <h3>Storage Usage</h3>
                    </div>
                    <div class="plan-details">
                        <div class="plan-usage">
                            <div class="usage-item">
                                <span class="usage-label">Total Storage:</span>
                                <div class="usage-bar">
                                    <div class="usage-progress" id="storageUsageBar" style="width: 0%"></div>
                                </div>
                                <span class="usage-text" id="storageUsageText">0/1 GB</span>
                            </div>
                        </div>
                        <button id="addStorageBtn" class="btn secondary-btn">Purchase Additional Storage</button>
                    </div>
                </div>
            </section>

            <!-- Quick Actions Bar -->
            <section class="quick-actions animate-in" style="animation-delay: 0.3s;">
                <button id="createClientBtn" class="action-btn">
                    <i class="fas fa-user-plus"></i> New Client
                </button>
                <button id="upgradePlanBtn" class="action-btn primary">
                    <i class="fas fa-plus"></i> Purchase Plan
                </button>
                <button id="createGalleryBtn" class="action-btn">
                    <i class="fas fa-images"></i> New Gallery
                </button>
                <button id="viewAnalyticsBtn" class="action-btn">
                    <i class="fas fa-chart-bar"></i> Analytics
                </button>
                <button id="helpBtn" class="action-btn help">
                    <i class="fas fa-question-circle"></i> Help
                </button>
            </section>

            <!-- Active Plans Section - Updated with status indicators -->
            <section class="active-plans-section animate-in" style="animation-delay: 0.4s;">
                <div class="section-header">
                    <h2>Active Client Plans</h2>
                    <div class="plan-status-indicators">
                        <span class="status-indicator active">Active</span>
                        <span class="status-indicator expiring">Expiring Soon</span>
                        <span class="status-indicator expired">Expired</span>
                    </div>
                    <button id="refreshPlansBtn" class="refresh-btn">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div id="activePlans" class="active-plans-grid">
                    <!-- Plans will be loaded dynamically -->
                    <div class="empty-state">
                        <i class="fas fa-ticket-alt empty-icon"></i>
                        <h3>No active plans</h3>
                        <p>Purchase a plan for a client to get started</p>
                        <button class="btn" id="emptyStateUpgradeBtn">Purchase Plan</button>
                    </div>
                </div>
            </section>

            <!-- Client Management Section -->
            <section class="clients-section animate-in" style="animation-delay: 0.5s;">
                <div class="section-header">
                    <h2>Your Clients</h2>
                    <button id="viewAllClientsBtn" class="view-all-btn">View All</button>
                </div>
                <div id="clientList" class="client-grid">
                    <!-- Clients will be loaded dynamically -->
                    <div class="empty-state">
                        <i class="fas fa-users empty-icon"></i>
                        <h3>No clients yet</h3>
                        <p>Add your first client to get started</p>
                        <button class="btn" id="emptyStateCreateClientBtn">Add Client</button>
                    </div>
                </div>
            </section>

            <!-- Gallery Management Section -->
            <section class="galleries-section animate-in" style="animation-delay: 0.6s;">
                <div class="section-header">
                    <h2>Recent Galleries</h2>
                    <button id="viewAllGalleriesBtn" class="view-all-btn">View All</button>
                </div>
                <div id="recentGalleries" class="gallery-grid">
                    <!-- Galleries will be loaded dynamically -->
                    <div class="empty-state">
                        <i class="fas fa-images empty-icon"></i>
                        <h3>No galleries yet</h3>
                        <p>Create your first gallery to get started</p>
                        <button class="btn" id="emptyStateCreateGalleryBtn">Create Gallery</button>
                    </div>
                </div>
            </section>

            <!-- Plan Upgrade Modal -->
            <div id="upgradePlanModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Purchase Client Plan</h2>
                        <button class="close-modal">&times;</button>
                    </div>
                    <div class="modal-body">
                        <!-- Client Selection -->
                        <div class="client-selection">
                            <h3>Select Client</h3>
                            <select id="clientSelect" class="client-select">
                                <option value="">Select a client</option>
                                <option value="new">+ Create New Client</option>
                                <!-- Existing clients will be loaded dynamically -->
                            </select>
                        </div>

                        <!-- New Client Form (Hidden initially) -->
                        <div id="newClientForm" class="new-client-form" style="display: none;">
                            <h3>New Client Details</h3>
                            <div class="form-group">
                                <label for="newClientName">Client Name *</label>
                                <input type="text" id="newClientName" placeholder="Enter client name" required>
                            </div>
                            <div class="form-group">
                                <label for="newClientEmail">Client Email</label>
                                <input type="email" id="newClientEmail" placeholder="Enter client email (optional)">
                            </div>
                        </div>

                        <div class="plan-comparison">
                            <div class="plan-tabs">
                                <button class="plan-tab" data-plan="lite">Lite</button>
                                <button class="plan-tab" data-plan="mini">Mini</button>
                                <button class="plan-tab" data-plan="basic">Basic</button>
                                <button class="plan-tab" data-plan="pro">Pro</button>
                                <button class="plan-tab" data-plan="premium">Premium</button>
                                <button class="plan-tab" data-plan="ultimate">Ultimate</button>
                            </div>
                            
                            <div id="planDetailsSection" class="plan-details-section">
                                <div class="plan-column selected">
                                    <h3>Selected Plan</h3>
                                    <div class="plan-name" id="selectedPlanName">Basic</div>
                                    <div class="plan-price" id="selectedPlanPrice">â‚¹399/client</div>
                                    <div class="plan-validity" id="validityInfo">Valid for 30 days</div>
                                    <ul class="plan-features" id="planFeaturesList">
                                        <li>15 GB Storage</li>
                                        <li>1 Gallery</li>
                                        <li>500 Photos per gallery</li>
                                        <li>30-day client selection window</li>
                                        <li>Advanced uploads</li>
                                        <li>Password protection</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div class="payment-section">
                                <div class="payment-progress alert-info" style="display: none;"></div>
                                <div class="payment-success alert-success" style="display: none;"></div>
                                <div class="payment-error alert-danger" style="display: none;"></div>
                                
                                <h3>Complete Your Purchase</h3>
                                <p class="payment-info">This plan will be associated with the selected client and valid for the duration specified above.</p>
                                
                                <form id="paymentForm">
                                    <div class="payment-options">
                                        <div class="payment-option">
                                            <div class="payment-logo-icon">
                                                <i class="fas fa-credit-card"></i>
                                            </div>
                                            <div class="payment-description">
                                                <p>Secure payment via Razorpay</p>
                                                <div class="payment-methods">
                                                    <i class="fas fa-credit-card"></i>
                                                    <i class="fas fa-university"></i>
                                                    <i class="fab fa-cc-visa"></i>
                                                    <i class="fab fa-cc-mastercard"></i>
                                                    <i class="fab fa-google-pay"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-actions">
                                        <button type="button" class="btn secondary" id="cancelUpgradeBtn">Cancel</button>
                                        <button type="submit" class="btn primary" id="confirmUpgradeBtn">Purchase Plan</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Create Client Modal -->
            <div id="createClientModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Create New Client</h2>
                        <button class="close-modal">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="createClientForm">
                            <div class="form-group">
                                <label for="clientName">Client Name *</label>
                                <input type="text" id="clientName" placeholder="Enter client name" required>
                            </div>
                            <div class="form-group">
                                <label for="clientEmail">Client Email</label>
                                <input type="email" id="clientEmail" placeholder="Enter client email (optional)">
                            </div>
                            <div class="form-group">
                                <label for="clientPhone">Client Phone</label>
                                <input type="tel" id="clientPhone" placeholder="Enter client phone (optional)">
                            </div>
                            <div class="form-group">
                                <label for="clientNotes">Notes</label>
                                <textarea id="clientNotes" placeholder="Any additional notes about this client"></textarea>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn secondary" id="cancelClientBtn">Cancel</button>
                                <button type="submit" class="btn primary" id="saveClientBtn">Save Client</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Create Gallery Modal -->
            <div id="createGalleryModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Create New Gallery</h2>
                        <button class="close-modal">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="createGalleryForm">
                            <div class="form-group">
                                <label for="galleryName">Gallery Name *</label>
                                <input type="text" id="galleryName" placeholder="Enter gallery name" required>
                            </div>
                            <div class="form-group">
                                <label for="galleryClient">Client *</label>
                                <select id="galleryClient" required>
                                    <option value="">Select a client</option>
                                    <!-- Clients will be loaded dynamically -->
                                </select>
                                <p class="form-help">Only clients with active plans can have galleries created.</p>
                            </div>
                            <div class="form-group">
                                <label for="galleryDescription">Description</label>
                                <textarea id="galleryDescription" placeholder="Describe this gallery (optional)"></textarea>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn secondary" id="cancelGalleryBtn">Cancel</button>
                                <button type="submit" class="btn primary" id="saveGalleryBtn">Create Gallery</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Locked Plan Overlay Template (Will be cloned and used when needed) -->
            <div id="lockedPlanTemplate" style="display: none;">
                <div class="locked-overlay">
                    <div class="locked-icon">
                        <i class="fas fa-lock"></i>
                    </div>
                    <div class="locked-message">
                        This gallery is locked because your plan has expired.
                    </div>
                    <button class="unlock-btn">Unlock Gallery</button>
                </div>
            </div>
        </div>
    </main>

    <footer class="dashboard-footer">
        <div class="container">
            <div class="footer-bottom">
                <p class="copyright">&copy; 2025 SnapSelect. All rights reserved.</p>
                <div class="footer-links">
                    <a href="#">Privacy Policy</a>
                    <a href="#">Terms of Service</a>
                    <a href="#" id="footerHelpLink">Help Center</a>
                </div>
            </div>
        </div>
    </footer>

    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <!-- Remaining Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>
    <script src="../assets/js/firebase-auth.js"></script>
    <script src="../assets/js/firebase-db.js"></script>
    <script src="../assets/js/header-auth.js"></script>
    <script src="../assets/js/subscription-manager.js"></script>
    <script src="../assets/js/notification-system.js"></script>
    
    <!-- Phase 1 New Scripts -->
    <script src="../assets/js/auth-protection.js"></script>
    <script src="../assets/js/plan-validator.js"></script>
    <script src="../assets/js/account-status-bar.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Firebase region
            if (firebase && firebase.functions) {
                firebase.app().functions("asia-south1");
            }
            
            // Modified secondary authentication check to avoid multiple redirects
            if (!sessionStorage.getItem('authorizedAccess')) {
                console.log("Warning: No authorization flag found during DOM load");
                // Don't redirect here - the initial check already handles this
            }
            
            // Check if user previously logged out - just log warning, don't redirect
            const userLoggedOut = sessionStorage.getItem('userLoggedOut') === 'true';
            if (userLoggedOut) {
                console.log("Warning: User previously logged out - this should have been caught earlier");
            }
            
            // Setup role-based UI when Firebase is ready
            if (window.firebaseServices && firebase.auth().currentUser) {
                setupRoleBasedUI();
            } else if (window.onFirebaseReady) {
                // Add to the Firebase ready queue
                if (typeof window.onFirebaseReady === 'function') {
                    window.onFirebaseReady(setupRoleBasedUI);
                } else if (Array.isArray(window.onFirebaseReady)) {
                    window.onFirebaseReady.push(setupRoleBasedUI);
                }
            }
            
            // Show/hide new client form in upgrade modal
            const clientSelect = document.getElementById('clientSelect');
            const newClientForm = document.getElementById('newClientForm');
            
            if (clientSelect && newClientForm) {
                clientSelect.addEventListener('change', function() {
                    if (this.value === 'new') {
                        newClientForm.style.display = 'block';
                    } else {
                        newClientForm.style.display = 'none';
                    }
                });
            }
            
            // Modal close buttons
            document.querySelectorAll('.close-modal').forEach(button => {
                button.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    if (modal) {
                        modal.style.display = 'none';
                    }
                });
            });
            
            // Click outside modal to close
            window.addEventListener('click', function(event) {
                if (event.target.classList.contains('modal')) {
                    event.target.style.display = 'none';
                }
            });
            
            // Empty state buttons
            const emptyStateUpgradeBtn = document.getElementById('emptyStateUpgradeBtn');
            if (emptyStateUpgradeBtn) {
                emptyStateUpgradeBtn.addEventListener('click', function() {
                    const upgradePlanModal = document.getElementById('upgradePlanModal');
                    if (upgradePlanModal) {
                        upgradePlanModal.style.display = 'block';
                    }
                });
            }
            
            const emptyStateCreateClientBtn = document.getElementById('emptyStateCreateClientBtn');
            if (emptyStateCreateClientBtn) {
                emptyStateCreateClientBtn.addEventListener('click', function() {
                    const createClientModal = document.getElementById('createClientModal');
                    if (createClientModal) {
                        createClientModal.style.display = 'block';
                    }
                });
            }
            
            const emptyStateCreateGalleryBtn = document.getElementById('emptyStateCreateGalleryBtn');
            if (emptyStateCreateGalleryBtn) {
                emptyStateCreateGalleryBtn.addEventListener('click', function() {
                    validateFeatureAccess('create_gallery', function() {
                        const createGalleryModal = document.getElementById('createGalleryModal');
                        if (createGalleryModal) {
                            createGalleryModal.style.display = 'block';
                        }
                    });
                });
            }
            
            // Create client form submission with validation
            const createClientForm = document.getElementById('createClientForm');
            if (createClientForm) {
                createClientForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    // Verify authentication again before performing action
                    if (!sessionStorage.getItem('authorizedAccess') || !firebase.auth().currentUser) {
                        alert("Your session has expired. Please log in again.");
                        window.location.replace('studiopanel-login.html');
                        return;
                    }
                    
                    // Validate client creation access
                    validateFeatureAccess('create_client', async function() {
                        const clientName = document.getElementById('clientName').value;
                        const clientEmail = document.getElementById('clientEmail').value;
                        const clientPhone = document.getElementById('clientPhone').value;
                        const clientNotes = document.getElementById('clientNotes').value;
                        
                        try {
                            // Show loading
                            const loadingOverlay = document.getElementById('loadingOverlay');
                            if (loadingOverlay) {
                                loadingOverlay.querySelector('.loading-text').textContent = 'Creating client...';
                                loadingOverlay.style.display = 'flex';
                            }
                            
                            // Check if subscription manager exists
                            if (window.subscriptionManager && window.subscriptionManager.createClient) {
                                // Create client
                                const clientId = await window.subscriptionManager.createClient(
                                    clientName,
                                    clientEmail,
                                    { phone: clientPhone, notes: clientNotes }
                                );
                                
                                if (clientId) {
                                    // Close modal
                                    const createClientModal = document.getElementById('createClientModal');
                                    if (createClientModal) {
                                        createClientModal.style.display = 'none';
                                    }
                                    
                                    // Show success message
                                    showToast('success', 'Client created successfully!');
                                    
                                    // Refresh client data
                                    if (window.subscriptionManager.refreshSubscription) {
                                        window.subscriptionManager.refreshSubscription();
                                    }
                                    
                                    // Log feature usage
                                    if (window.PlanValidator) {
                                        window.PlanValidator.logFeatureUsage(
                                            firebase.auth().currentUser.uid,
                                            null,
                                            'create_client',
                                            true
                                        );
                                    }
                                }
                            } else {
                                throw new Error('Client management functionality is not available');
                            }
                        } catch (error) {
                            console.error('Error creating client:', error);
                            // If authentication error, redirect to login
                            if (error.code === 'auth/user-token-expired' || 
                                error.code === 'auth/user-token-revoked' || 
                                error.code === 'auth/user-not-found' || 
                                !firebase.auth().currentUser) {
                                sessionStorage.removeItem('authorizedAccess');
                                window.location.replace('studiopanel-login.html');
                                return;
                            }
                            
                            // Show error message
                            showToast('error', `Error creating client: ${error.message}`);
                        } finally {
                            // Hide loading overlay
                            const loadingOverlay = document.getElementById('loadingOverlay');
                            if (loadingOverlay) {
                                loadingOverlay.style.display = 'none';
                            }
                        }
                    });
                });
            }
            
            // Reset form on modal close
            document.querySelectorAll('.modal .close-modal, .modal .btn.secondary').forEach(button => {
                button.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    if (modal) {
                        const form = modal.querySelector('form');
                        if (form) {
                            form.reset();
                        }
                        
                        // Hide new client form if in upgrade modal
                        if (modal.id === 'upgradePlanModal') {
                            const newClientForm = document.getElementById('newClientForm');
                            if (newClientForm) {
                                newClientForm.style.display = 'none';
                            }
                        }
                    }
                });
            });
            
            // Refresh buttons
            const refreshPlansBtn = document.getElementById('refreshPlansBtn');
            if (refreshPlansBtn) {
                refreshPlansBtn.addEventListener('click', function() {
                    // Verify authentication again before performing action
                    if (!sessionStorage.getItem('authorizedAccess') || !firebase.auth().currentUser) {
                        alert("Your session has expired. Please log in again.");
                        window.location.replace('studiopanel-login.html');
                        return;
                    }
                    
                    this.classList.add('rotating');
                    
                    // Check if subscription manager exists before calling
                    if (window.subscriptionManager && window.subscriptionManager.refreshSubscription) {
                        window.subscriptionManager.refreshSubscription();
                    }
                    
                    // Remove rotating class after animation completes
                    setTimeout(() => {
                        this.classList.remove('rotating');
                    }, 1000);
                });
            }
            
            // Create Gallery button with plan validation
            const createGalleryBtn = document.getElementById('createGalleryBtn');
            if (createGalleryBtn) {
                createGalleryBtn.addEventListener('click', function() {
                    validateFeatureAccess('create_gallery', function() {
                        const createGalleryModal = document.getElementById('createGalleryModal');
                        if (createGalleryModal) {
                            createGalleryModal.style.display = 'block';
                        }
                    });
                });
            }
            
            // Validate feature access using PlanValidator
            async function validateFeatureAccess(feature, callback) {
                try {
                    // Check if PlanValidator exists
                    if (!window.PlanValidator) {
                        console.error('PlanValidator not initialized');
                        callback(); // Proceed anyway if validation not available
                        return;
                    }
                    
                    // Get current user
                    const user = firebase.auth().currentUser;
                    if (!user) {
                        alert('You must be logged in to access this feature.');
                        return;
                    }
                    
                    // Check feature access
                    const featureAccess = await window.PlanValidator.checkFeatureAccess(
                        user.uid,
                        null, // No specific client for general gallery creation
                        feature
                    );
                    
                    if (!featureAccess.allowed) {
                        // Show upgrade modal or error message
                        const planMessage = featureAccess.planType ? 
                            `Your current plan (${featureAccess.planType}) does not include this feature.` : 
                            'You need an active plan to use this feature.';
                        
                        const message = `${featureAccess.reason}. ${planMessage} Would you like to upgrade?`;
                        
                        if (confirm(message)) {
                            // Show upgrade modal
                            const upgradePlanModal = document.getElementById('upgradePlanModal');
                            if (upgradePlanModal) {
                                upgradePlanModal.style.display = 'block';
                            }
                        }
                        return;
                    }
                    
                    // Feature is allowed, proceed
                    if (callback && typeof callback === 'function') {
                        callback();
                    }
                    
                    // Log feature usage
                    window.PlanValidator.logFeatureUsage(
                        user.uid,
                        null,
                        feature,
                        true
                    );
                } catch (error) {
                    console.error('Error validating feature access:', error);
                    
                    // Proceed in development environment, block in production
                    const isProduction = window.location.hostname !== 'localhost';
                    if (!isProduction) {
                        if (callback && typeof callback === 'function') {
                            callback();
                        }
                    } else {
                        alert('Error validating feature access. Please try again later.');
                    }
                }
            }
            
            // Setup role-based UI
            function setupRoleBasedUI() {
                // Get current user
                const user = firebase.auth().currentUser;
                if (!user) return;
                
                // Check if user is admin
                firebase.firestore().collection('admin')
                    .doc(user.uid)
                    .get()
                    .then(doc => {
                        const isAdmin = doc.exists;
                        
                        // Show/hide admin-only elements
                        document.querySelectorAll('.admin-only').forEach(el => {
                            el.style.display = isAdmin ? 'block' : 'none';
                        });
                        
                        // Show admin badge if user is admin
                        if (isAdmin) {
                            const userMenu = document.getElementById('userMenuBtn');
                            if (userMenu) {
                                const adminBadge = document.createElement('span');
                                adminBadge.className = 'admin-badge';
                                adminBadge.textContent = 'Admin';
                                userMenu.appendChild(adminBadge);
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error checking admin role:', error);
                    });
            }
            
            // Show toast notification
            function showToast(type, message) {
                const toastContainer = document.getElementById('toastContainer');
                if (!toastContainer) return;
                
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                
                let icon = 'fas fa-info-circle';
                if (type === 'success') icon = 'fas fa-check-circle';
                if (type === 'error') icon = 'fas fa-exclamation-circle';
                if (type === 'warning') icon = 'fas fa-exclamation-triangle';
                
                toast.innerHTML = `
                    <i class="${icon}"></i>
                    <span>${message}</span>
                `;
                
                toastContainer.appendChild(toast);
                
                // Remove toast after 3 seconds
                setTimeout(() => {
                    toast.classList.add('hide');
                    setTimeout(() => {
                        toast.remove();
                    }, 300);
                }, 3000);
            }
            
            // Periodic check for authentication status
            setInterval(function() {
                if (!firebase.auth().currentUser) {
                    // User is no longer authenticated
                    sessionStorage.removeItem('authorizedAccess');
                    sessionStorage.removeItem('authTimestamp');
                    
                    console.log("User authentication expired - redirecting to login");
                    window.location.replace('studiopanel-login.html');
                }
            }, 5 * 60 * 1000); // Check every 5 minutes
            
            // Handle direct navigation detection
            window.addEventListener('pageshow', function(event) {
                // Check if this is a back-forward cache restoration (bfcache)
                if (event.persisted) {
                    console.log("Page restored from back-forward cache - verifying authentication");
                    
                    // Verify authorization when coming from bfcache
                    if (!sessionStorage.getItem('authorizedAccess')) {
                        console.log("No authorization found after bfcache restoration");
                        window.location.replace('studiopanel-login.html');
                    } else if (sessionStorage.getItem('userLoggedOut') === 'true') {
                        console.log("User previously logged out - preventing bfcache access");
                        sessionStorage.removeItem('userLoggedOut');
                        window.location.replace('studiopanel-login.html');
                    }
                }
            });
            
            // Style additions for locked plan overlay
            const style = document.createElement('style');
            style.textContent = `
                .locked-overlay {
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background-color: rgba(0, 0, 0, 0.7);
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    z-index: 100;
                    color: white;
                    text-align: center;
                    padding: 20px;
                }
                
                .locked-icon {
                    font-size: 48px;
                    margin-bottom: 16px;
                }
                
                .locked-message {
                    margin-bottom: 24px;
                    font-size: 18px;
                }
                
                .unlock-btn {
                    background-color: #4A90E2;
                    color: white;
                    border: none;
                    padding: 8px 24px;
                    border-radius: 4px;
                    font-weight: 600;
                    cursor: pointer;
                }
                
                .unlock-btn:hover {
                    background-color: #3A7BC8;
                }
                
                .admin-badge {
                    background-color: #F44336;
                    color: white;
                    font-size: 10px;
                    padding: 2px 6px;
                    border-radius: 10px;
                    margin-left: 8px;
                    text-transform: uppercase;
                }
                
                .status-indicator {
                    display: inline-block;
                    padding: 2px 8px;
                    border-radius: 10px;
                    font-size: 12px;
                    margin-right: 8px;
                }
                
                .status-indicator.active {
                    background-color: #e6f7e6;
                    color: #2e7d32;
                }
                
                .status-indicator.expiring {
                    background-color: #fff8e1;
                    color: #f57c00;
                }
                
                .status-indicator.expired {
                    background-color: #ffebee;
                    color: #c62828;
                }
                
                .plan-status-indicators {
                    display: flex;
                    align-items: center;
                    margin-left: auto;
                    margin-right: 16px;
                }
                
                @media (max-width: 768px) {
                    .plan-status-indicators {
                        display: none;
                    }
                }
            `;
            document.head.appendChild(style);
        });
    </script>
</body>
</html>
