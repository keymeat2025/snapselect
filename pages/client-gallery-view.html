<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer" />

   <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    img-src * data: https://*.firebasestorage.app https://firebasestorage.googleapis.com;
    style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com;
    script-src 'self' 'unsafe-inline' https://www.gstatic.com;
    font-src 'self' https://cdnjs.cloudflare.com;
    connect-src 'self' https://firestore.googleapis.com https://*.googleapis.com https://*.firebasestorage.app https://firebasestorage.googleapis.com;
    font-src 'self' https://cdnjs.cloudflare.com https://use.fontawesome.com;
    ">
    <title>Shared Gallery - SnapSelect</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Your existing CSS styles remain the same */
        /* Basic styles */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        /* ...all your existing CSS... */
        
        /* Add a style for the sync button */
        .sync-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 18px;
        }
        
        /* Add style for the total ratings display */
        .total-ratings {
            position: fixed;
            top: 70px;
            left: 20px;
            background-color: rgba(52, 152, 219, 0.8);
            padding: 10px 15px;
            border-radius: 8px;
            display: flex;
            gap: 15px;
            z-index: 999;
        }
    </style>
</head>
<body>
    <!-- Welcome Dashboard (initially hidden) -->
    <div id="welcomeDashboard" class="welcome-dashboard" style="display: none;">
        <!-- Your existing welcome dashboard HTML remains the same -->
    </div>

    <div id="toastContainer" class="toast-container"></div>
    <div id="ratingSummary" class="rating-summary" style="display: none;">
        <div class="rating-count"><span>‚ù§Ô∏è</span><span id="heartCount">0</span></div>
        <div class="rating-count"><span>üëç</span><span id="thumbsUpCount">0</span></div>
        <div class="rating-count"><span>ü§î</span><span id="thinkingCount">0</span></div>
        <div class="rating-count"><span>üëé</span><span id="thumbsDownCount">0</span></div>
    </div>


    <header>
        <div class="container">
            <nav>
                <a href="../../index.html" class="logo">
                    <div class="logo-text">SnapSelect</div>
                </a>
            </nav>
        </div>
    </header>

    <main>
        <!-- Your existing HTML elements remain the same -->
    </main>

    <footer>
        <div class="container">
            <p>&copy; <span id="currentYear">2025</span> SnapSelect. All rights reserved.</p>
        </div>
    </footer>
<!-- Firebase SDK Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <!-- Inline script to load the gallery -->
    <script>
        // Variable to store all gallery photos and ratings
        let allGalleryPhotos = [];
        let slideshowInterval = null; // For slideshow feature
        let photoRatings = {}; // Store ratings for each photo
        let ratingCounts = {
            heart: 0,
            thumbsUp: 0,
            thinking: 0,
            thumbsDown: 0
        };
        
        // Firebase synchronization variables
        let syncTimeout = null;
        let syncInterval = null;
        let pendingSync = false;
        let lastSyncTime = null;
        
        // Function to generate or retrieve a user identifier
        function getUserIdentifier() {
            let userId = localStorage.getItem('user_id');
            if (!userId) {
                userId = 'user_' + Math.random().toString(36).substring(2, 15);
                localStorage.setItem('user_id', userId);
            }
            return userId;
        }
        
        // Function to get gallery ID from URL or session storage
        function getGalleryId() {
            const urlParams = new URLSearchParams(window.location.search);
            const shareId = urlParams.get('share');
            const directGalleryId = urlParams.get('id') || urlParams.get('galleryId');
            
            if (directGalleryId) return directGalleryId;
            
            // Try to get from session storage if not in URL
            return sessionStorage.getItem('actual_gallery_id');
        }

        
        // Welcome dashboard functions
        function showWelcomeDashboard() {
            const welcomeDashboard = document.getElementById('welcomeDashboard');
            if (welcomeDashboard) {
                welcomeDashboard.style.display = 'flex';
            }
        }

        function hideWelcomeDashboard() {
            const welcomeDashboard = document.getElementById('welcomeDashboard');
            if (welcomeDashboard) {
                welcomeDashboard.style.display = 'none';
            }
        }

        function checkWelcomeDashboardPreference() {
            // Check if user has opted out of seeing the welcome screen
            return localStorage.getItem('dontShowWelcomeDashboard') !== 'true';
        }

        function setupWelcomeDashboard() {
            const startGalleryBtn = document.getElementById('startGalleryBtn');
            const dontShowAgainCheckbox = document.getElementById('dontShowAgain');
            
            if (startGalleryBtn) {
                startGalleryBtn.addEventListener('click', function() {
                    // Check if "don't show again" is checked
                    if (dontShowAgainCheckbox && dontShowAgainCheckbox.checked) {
                        localStorage.setItem('dontShowWelcomeDashboard', 'true');
                    }
                    
                    // Hide welcome dashboard
                    hideWelcomeDashboard();
                    
                    // Continue with gallery loading
                    if (checkGalleryAccess()) {
                        loadSharedGallery();
                    }
                });
            }
        }
        
        // Disable right-click
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            return false;
        }, false);

        // Disable keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Prevent Ctrl+S, Ctrl+U, Ctrl+P, Ctrl+Shift+I, F12
            if ((e.ctrlKey && ['s','u','p'].includes(e.key.toLowerCase())) || 
                (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'i') || 
                e.key === 'F12') {
                e.preventDefault();
                return false;
            }
        });

        // Disable drag and drop
        document.addEventListener('dragstart', function(e) {
            e.preventDefault();
            return false;
        });
        
        // Access control for client gallery
        function checkGalleryAccess() {
            // Get gallery parameters
            const urlParams = new URLSearchParams(window.location.search);
            
            // Look for different possible ID parameters
            const galleryId = urlParams.get('id') || urlParams.get('galleryId');
            const shareId = urlParams.get('share');
            
            // If no ID is present, can't proceed
            if (!galleryId && !shareId) {
                showPageError("Invalid gallery link. No gallery ID or share ID provided.");
                return false;
            }
            
            // If we have a direct gallery ID
            if (galleryId) {
                // Check if access has been granted via password
                const accessToken = sessionStorage.getItem(`gallery_access_${galleryId}`);
                
                if (!accessToken) {
                    console.log("Direct gallery access attempted without authentication");
                    // Look for the studio name and share ID
                    try {
                        const actualGalleryId = sessionStorage.getItem('actual_gallery_id') || galleryId;
                        findStudioAndShareInfo(actualGalleryId);
                        return false;
                    } catch (error) {
                        console.error("Error redirecting to password page:", error);
                        showPageError("Authentication error. Please try accessing through the shared link.");
                        return false;
                    }
                }
            }
            
            // If we have a share ID, we'll verify it during regular loading
            return true;
        }

        
        // Rating system functions
        function loadSavedRatings() {
            try {
                const savedRatings = localStorage.getItem('photoRatings');
                if (savedRatings) {
                    photoRatings = JSON.parse(savedRatings);
                    updateRatingCounts();
                }
            } catch (err) {
                console.error("Error loading saved ratings:", err);
            }
        }
        
        function updateRatingCounts() {
            // Reset counts
            ratingCounts = {
                heart: 0,
                thumbsUp: 0,
                thinking: 0,
                thumbsDown: 0
            };
            
            // Count each rating type
            Object.values(photoRatings).forEach(rating => {
                if (rating && ratingCounts[rating] !== undefined) {
                    ratingCounts[rating]++;
                }
            });
            
            // Update display
            document.getElementById('heartCount').textContent = ratingCounts.heart;
            document.getElementById('thumbsUpCount').textContent = ratingCounts.thumbsUp;
            document.getElementById('thinkingCount').textContent = ratingCounts.thinking;
            document.getElementById('thumbsDownCount').textContent = ratingCounts.thumbsDown;
            
            // Show summary if we have any ratings
            const totalRatings = Object.values(ratingCounts).reduce((a, b) => a + b, 0);
            document.getElementById('ratingSummary').style.display = totalRatings > 0 ? 'flex' : 'none';
        }

     
        function setPhotoRating(photoId, rating) {
            // If same rating is clicked again, we'll unselect it
            if (photoRatings[photoId] === rating) {
                delete photoRatings[photoId]; // Remove rating locally
                showToast(`Rating removed`, 'info');
            } else {
                photoRatings[photoId] = rating;
                showToast(`Photo marked as ${getRatingLabel(rating)}`, 'success');
            }
            
            // Save to localStorage immediately
            try {
                localStorage.setItem('photoRatings', JSON.stringify(photoRatings));
            } catch (err) {
                console.error("Error saving ratings to localStorage:", err);
            }
            
            // Update counts locally
            updateRatingCounts();
            
            // Update UI in open lightbox if it exists
            const lightbox = document.getElementById('photoLightbox');
            if (lightbox) {
                const ratingButtons = lightbox.querySelectorAll('.rating-btn');
                ratingButtons.forEach(btn => {
                    btn.classList.remove('selected');
                    if (photoRatings[photoId] === btn.getAttribute('data-rating')) {
                        btn.classList.add('selected');
                    }
                });
            }
            
            // Schedule a delayed sync (debounced)
            scheduleSyncToFirebase();
        }
        
        // Create a function to schedule a delayed sync
        function scheduleSyncToFirebase() {
            // Clear any existing timeout
            if (syncTimeout) {
                clearTimeout(syncTimeout);
            }
            
            // Set a flag that changes are pending
            pendingSync = true;
            
            // Schedule a new sync with a 3-second delay
            syncTimeout = setTimeout(() => {
                syncRatingsToFirebase();
            }, 3000); // 3 second delay
        }
        
        // Function to batch save ratings to Firebase
        function syncRatingsToFirebase() {
            const userId = getUserIdentifier();
            const galleryId = getGalleryId();
            
            if (!galleryId || !userId || !pendingSync) return;
            
            pendingSync = false; // Reset the pending flag
            
            // Update sync button status if it exists
            updateSyncButtonStatus('syncing');
            
            const db = firebase.firestore();
            
            // Start a batch operation
            const batch = db.batch();
            
            // First, get existing ratings for this gallery and user
            db.collection('photoRatings')
                .where('galleryId', '==', galleryId)
                .where('userId', '==', userId)
                .get()
                .then((snapshot) => {
                    // Track if any changes are needed
                    let changesMade = false;
                    
                    // Create a map of existing ratings
                    const existingRatings = {};
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        existingRatings[data.photoId] = {
                            rating: data.rating,
                            docId: doc.id
                        };
                    });
                    
                    // Compare with local ratings and batch changes
                    for (const photoId in photoRatings) {
                        const localRating = photoRatings[photoId];
                        
                        // If rating exists but is different, update it
                        if (existingRatings[photoId] && existingRatings[photoId].rating !== localRating) {
                            const docRef = db.collection('photoRatings').doc(existingRatings[photoId].docId);
                            batch.update(docRef, { 
                                rating: localRating,
                                timestamp: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            changesMade = true;
                        }
                        // If rating doesn't exist, create it
                        else if (!existingRatings[photoId]) {
                            const docRef = db.collection('photoRatings').doc();
                            batch.set(docRef, {
                                userId: userId,
                                photoId: photoId,
                                galleryId: galleryId,
                                rating: localRating,
                                timestamp: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            changesMade = true;
                        }
                        
                        // Remove from existingRatings to track deletions
                        delete existingRatings[photoId];
                    }
                    
                    // Handle deletions (ratings in Firebase but not in local)
                    for (const photoId in existingRatings) {
                        const docRef = db.collection('photoRatings').doc(existingRatings[photoId].docId);
                        batch.delete(docRef);
                        changesMade = true;
                    }
                    
                    // Commit the batch if changes were made
                    if (changesMade) {
                        return batch.commit()
                            .then(() => {
                                lastSyncTime = new Date();
                                console.log("Ratings synchronized with Firebase");
                                updateSyncButtonStatus('success');
                                // Update counters after successful sync
                                updateGalleryRatingCounters(galleryId);
                            })
                            .catch(error => {
                                console.error("Error syncing ratings:", error);
                                pendingSync = true; // Mark for retry
                                updateSyncButtonStatus('error');
                            });
                    } else {
                        lastSyncTime = new Date();
                        console.log("No changes to sync");
                        updateSyncButtonStatus('success');
                    }
                })
                .catch(error => {
                    console.error("Error checking existing ratings:", error);
                    pendingSync = true; // Mark for retry
                    updateSyncButtonStatus('error');
                });
        }
        
        // Function to update gallery rating counters
        function updateGalleryRatingCounters(galleryId) {
            if (!galleryId) return;
            
            const db = firebase.firestore();
            
            // Count all ratings for this gallery
            db.collection('photoRatings')
                .where('galleryId', '==', galleryId)
                .get()
                .then((snapshot) => {
                    if (snapshot.empty) return;
                    
                    const counts = {
                        heart: 0,
                        thumbsUp: 0,
                        thinking: 0,
                        thumbsDown: 0,
                        totalUsers: new Set(),
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (counts[data.rating] !== undefined) {
                            counts[data.rating]++;
                        }
                        if (data.userId) {
                            counts.totalUsers.add(data.userId);
                        }
                    });
                    
                    // Convert Set to count before saving
                    const totalUsersCount = counts.totalUsers.size;
                    counts.totalUsers = totalUsersCount;
                    
                    // Store the counts in a counter document
                    db.collection('galleryRatingCounts')
                        .doc(galleryId)
                        .set(counts)
                        .catch(error => {
                            console.error("Error updating rating counts:", error);
                        });
                });
        }


        // Function to load ratings from Firebase
        function loadRatingsFromFirebase() {
            const userId = getUserIdentifier();
            const galleryId = getGalleryId();
            
            if (!galleryId || !userId) {
                console.log("Cannot load ratings without gallery ID and user ID");
                return;
            }
            
            const db = firebase.firestore();
            
            // Show a loading indicator if you want
            console.log("Loading ratings from Firebase...");
            
            db.collection('photoRatings')
                .where('galleryId', '==', galleryId)
                .where('userId', '==', userId)
                .get()
                .then((snapshot) => {
                    if (snapshot.empty) {
                        console.log("No ratings found in Firebase, using localStorage");
                        return;
                    }
                    
                    // Create a map of Firebase ratings
                    const firebaseRatings = {};
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        firebaseRatings[data.photoId] = data.rating;
                    });
                    
                    // Merge with local ratings - prioritize Firebase for conflicts
                    const savedRatings = localStorage.getItem('photoRatings');
                    let localRatings = {};
                    
                    if (savedRatings) {
                        try {
                            localRatings = JSON.parse(savedRatings);
                            
                            // For any ratings that are in localStorage but not in Firebase,
                            // we'll consider them pending changes
                            let pendingChanges = false;
                            
                            for (const photoId in localRatings) {
                                if (!firebaseRatings[photoId]) {
                                    firebaseRatings[photoId] = localRatings[photoId];
                                    pendingChanges = true;
                                }
                            }
                            
                            if (pendingChanges) {
                                pendingSync = true;
                                scheduleSyncToFirebase();
                            }
                        } catch (err) {
                            console.error("Error parsing local ratings:", err);
                        }
                    }
                    
                    // Update the global ratings object
                    photoRatings = firebaseRatings;
                    
                    // Save the merged result back to localStorage
                    try {
                        localStorage.setItem('photoRatings', JSON.stringify(photoRatings));
                    } catch (err) {
                        console.error("Error saving ratings to localStorage:", err);
                    }
                    
                    // Update UI
                    updateRatingCounts();
                    console.log("Ratings loaded from Firebase");
                })
                .catch(error => {
                    console.error("Error loading ratings from Firebase:", error);
                });
        }
        
        // Function to add a sync button to the UI
        function addSyncButton() {
            const syncButton = document.createElement('button');
            syncButton.id = 'syncButton';
            syncButton.className = 'sync-btn';
            syncButton.innerHTML = '<i class="fas fa-sync-alt"></i>';
            syncButton.setAttribute('aria-label', 'Sync ratings');
            syncButton.title = 'Sync ratings with server';
            
            syncButton.addEventListener('click', function() {
                // Show syncing indicator
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                
                // Force immediate sync
                pendingSync = true;
                syncRatingsToFirebase();
            });
            
            document.body.appendChild(syncButton);
            return syncButton;
        }
        
        
// Function to update the sync button status
        function updateSyncButtonStatus(status) {
            const syncButton = document.getElementById('syncButton');
            if (!syncButton) return;
            
            switch (status) {
                case 'syncing':
                    syncButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    syncButton.style.backgroundColor = '#3498db';
                    break;
                case 'success':
                    syncButton.innerHTML = '<i class="fas fa-check"></i>';
                    syncButton.style.backgroundColor = '#27ae60';
                    setTimeout(() => {
                        syncButton.innerHTML = '<i class="fas fa-sync-alt"></i>';
                        syncButton.style.backgroundColor = '#3498db';
                    }, 2000);
                    break;
                case 'error':
                    syncButton.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
                    syncButton.style.backgroundColor = '#e74c3c';
                    setTimeout(() => {
                        syncButton.innerHTML = '<i class="fas fa-sync-alt"></i>';
                        syncButton.style.backgroundColor = '#3498db';
                    }, 2000);
                    break;
                default:
                    syncButton.innerHTML = '<i class="fas fa-sync-alt"></i>';
                    syncButton.style.backgroundColor = '#3498db';
            }
            
            // Update the tooltip to show last sync time
            if (lastSyncTime) {
                syncButton.title = `Last synced: ${lastSyncTime.toLocaleTimeString()}`;
            }
        }
        
        // Function to set up periodic sync
        function setupPeriodicSync() {
            if (syncInterval) {
                clearInterval(syncInterval);
            }
            
            // Sync every 5 minutes
            syncInterval = setInterval(() => {
                if (pendingSync) {
                    syncRatingsToFirebase();
                }
            }, 5 * 60 * 1000); // 5 minutes
        }
        
        // Initialize the ratings synchronization system
        function initRatingSync() {
            // First load local ratings
            loadSavedRatings();
            
            // Then attempt to fetch from Firebase
            loadRatingsFromFirebase();
            
            // Add a sync button to the UI
            addSyncButton();
            
            // Set up periodic sync
            setupPeriodicSync();
            
            // Load total ratings from all users
            loadTotalRatings();
            
            // Set up sync before page unload
            window.addEventListener('beforeunload', function() {
                if (pendingSync) {
                    syncRatingsToFirebase();
                }
            });
        }
        
        // Add this function to load total ratings counts from all users
        function loadTotalRatings() {
            const galleryId = getGalleryId();
            if (!galleryId) return;
            
            const db = firebase.firestore();
            
            // First, look for an aggregate counter document
            db.collection('galleryRatingCounts')
                .doc(galleryId)
                .get()
                .then(doc => {
                    if (doc.exists) {
                        // Use the aggregated counts
                        updateTotalRatingsDisplay(doc.data());
                    } else {
                        // Fall back to counting all ratings (less efficient)
                        db.collection('photoRatings')
                            .where('galleryId', '==', galleryId)
                            .get()
                            .then((snapshot) => {
                                if (snapshot.empty) {
                                    console.log("No total ratings found");
                                    return;
                                }
                                
                                // Count ratings by type
                                const totalCounts = {
                                    heart: 0,
                                    thumbsUp: 0,
                                    thinking: 0,
                                    thumbsDown: 0
                                };
                                
                                // Set to track unique users
                                
                                const uniqueUsers = new Set();
                                
                                snapshot.forEach(doc => {
                                    const data = doc.data();
                                    if (totalCounts[data.rating] !== undefined) {
                                        totalCounts[data.rating]++;
                                    }
                                    if (data.userId) {
                                        uniqueUsers.add(data.userId);
                                    }
                                });
                                
                                // Add user count to the results
                                totalCounts.totalUsers = uniqueUsers.size;
                                
                                updateTotalRatingsDisplay(totalCounts);
                            })
                            .catch(error => {
                                console.error("Error loading total ratings:", error);
                            });
                    }
                })
                .catch(error => {
                    console.error("Error loading rating counts:", error);
                });
        }
        
        // Function to create and update the total ratings display
        function updateTotalRatingsDisplay(totalCounts) {
            // Check if the element already exists
            let totalRatingsElem = document.getElementById('totalRatings');
            
            if (!totalRatingsElem) {
                // Create the element if it doesn't exist
                totalRatingsElem = document.createElement('div');
                totalRatingsElem.id = 'totalRatings';
                totalRatingsElem.className = 'total-ratings';
                
                const title = document.createElement('div');
                title.style.fontWeight = 'bold';
                title.style.marginRight = '10px';
                title.textContent = 'Gallery Totals:';
                totalRatingsElem.appendChild(title);
                
                // Create counters for each rating type
                for (const type of ['heart', 'thumbsUp', 'thinking', 'thumbsDown']) {
                    const ratingCount = document.createElement('div');
                    ratingCount.className = 'rating-count';
                    
                    const emoji = document.createElement('span');
                    emoji.textContent = type === 'heart' ? '‚ù§Ô∏è' : 
                                       type === 'thumbsUp' ? 'üëç' : 
                                       type === 'thinking' ? 'ü§î' : 'üëé';
                    
                    const count = document.createElement('span');
                    count.id = `total${type.charAt(0).toUpperCase() + type.slice(1)}Count`;
                    count.textContent = totalCounts[type] || 0;
                    
                    ratingCount.appendChild(emoji);
                    ratingCount.appendChild(count);
                    totalRatingsElem.appendChild(ratingCount);
                }
                
                // Add user count if available
                if (totalCounts.totalUsers) {
                    const userCount = document.createElement('div');
                    userCount.className = 'rating-count';
                    userCount.innerHTML = `<span>üë§</span><span id="totalUserCount">${totalCounts.totalUsers}</span>`;
                    totalRatingsElem.appendChild(userCount);
                }
                
                document.body.appendChild(totalRatingsElem);
            } else {
                // Update existing counters
                document.getElementById('totalHeartCount').textContent = totalCounts.heart || 0;
                document.getElementById('totalThumbsUpCount').textContent = totalCounts.thumbsUp || 0;
                document.getElementById('totalThinkingCount').textContent = totalCounts.thinking || 0;
                document.getElementById('totalThumbsDownCount').textContent = totalCounts.thumbsDown || 0;
                
                // Update user count if available
                const userCountElem = document.getElementById('totalUserCount');
                if (userCountElem && totalCounts.totalUsers) {
                    userCountElem.textContent = totalCounts.totalUsers;
                }
            }
            
            // Show the element
            totalRatingsElem.style.display = 'flex';
        }
        
        // Set up real-time updates for gallery counts
        function setupRealTimeCounters() {
            const galleryId = getGalleryId();
            if (!galleryId) return;
            
            const db = firebase.firestore();
            
            return db.collection('galleryRatingCounts')
                .doc(galleryId)
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        updateTotalRatingsDisplay(doc.data());
                    }
                }, (error) => {
                    console.error("Error with real-time counters:", error);
                });
        }
        
        function getRatingLabel(rating) {
            switch(rating) {
                case 'heart': return "Must Have";
                case 'thumbsUp': return "Would Like to Have";
                case 'thinking': return "Alternative Option";
                case 'thumbsDown': return "Not Interested";
                default: return "";
            }
        }

        
        function createRatingButton(emoji, label, ratingValue, photoId) {
            const btn = document.createElement('button');
            btn.className = 'rating-btn';
            btn.innerHTML = emoji;
            btn.setAttribute('aria-label', label);
            btn.setAttribute('data-rating', ratingValue);
            
            if (photoRatings[photoId] === ratingValue) {
                btn.classList.add('selected');
            }
            
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                
                // Update rating in storage
                setPhotoRating(photoId, ratingValue);
                
                // Update visual selection
                const ratingBtns = document.querySelectorAll('.rating-btn');
                ratingBtns.forEach(b => b.classList.remove('selected'));
                
                // Only add selected class if we didn't remove the rating
                if (photoRatings[photoId] === ratingValue) {
                    btn.classList.add('selected');
                }
            });
            
            return btn;
        }


        // Function to find studio and share information for a gallery
        function findStudioAndShareInfo(galleryId) {
            // If Firebase is available, look up the information
            if (typeof firebase !== 'undefined' && firebase.apps.length) {
                const db = firebase.firestore();
                
                // Find gallery shares for this gallery
                db.collection('galleryShares')
                    .where('galleryId', '==', galleryId)
                    .limit(1)
                    .get()
                    .then(snapshot => {
                        if (!snapshot.empty) {
                            const shareData = snapshot.docs[0].data();
                            const shareId = shareData.shareId;
                            
                            // Find the photographer
                            return db.collection('photographer')
                                .where('uid', '==', shareData.photographerId)
                                .limit(1)
                                .get()
                                .then(photoSnapshot => {
                                    if (!photoSnapshot.empty) {
                                        const photographerData = photoSnapshot.docs[0].data();
                                        const studioName = photographerData.studioName;
                                        
                                        // Redirect with studio name
                                        window.location.href = `/${studioName}/gallery/${shareId}`;
                                    } else {
                                        // Fallback to basic redirect
                                        window.location.href = `/client-gallery.html?share=${shareId}`;
                                    }
                                });
                        } else {
                            showPageError("Gallery access denied. Please use the shared link provided by the photographer.");
                        }
                    })
                    .catch(error => {
                        console.error("Error finding share info:", error);
                        showPageError("Error accessing gallery. Please try again later.");
                    });
            } else {
                showPageError("Gallery access denied. Firebase not initialized.");
            }
        }

        
// Firebase initialization
        (function() {
            // Firebase configuration
            const firebaseConfig = {
                apiKey: "AIzaSyCAl15Yq8Y727PKknJNs0Q8UZbRRbcWkMo",
                authDomain: "snapselect01-eb74c.firebaseapp.com",
                projectId: "snapselect01-eb74c",
                storageBucket: "snapselect01-eb74c.firebasestorage.app",
                messagingSenderId: "749450852067",
                appId: "1:749450852067:web:8b1887075d607b3e91f7d6",
                measurementId: "G-J5XGE71VF6"
            };
            
            // Initialize Firebase
            try {
                if (firebase.apps.length === 0) {
                    firebase.initializeApp(firebaseConfig);
                    console.log("Firebase initialized successfully");
                }
                
                // Update current year in footer
                document.getElementById('currentYear').textContent = new Date().getFullYear();
                
                // Load saved ratings
                loadSavedRatings();
                
                // Make sure ratingSummary is initially hidden if no ratings
                const ratingSummary = document.getElementById('ratingSummary');
                if (ratingSummary) {
                    const totalRatings = Object.values(ratingCounts).reduce((a, b) => a + b, 0);
                    ratingSummary.style.display = totalRatings > 0 ? 'flex' : 'none';
                }
                
                // Setup welcome dashboard event listeners
                setupWelcomeDashboard();
                
                // Check if we should show welcome dashboard
                if (checkWelcomeDashboardPreference()) {
                    // Show welcome dashboard
                    showWelcomeDashboard();
                } else {
                    // Skip welcome dashboard and check access
                    if (checkGalleryAccess()) {
                        loadSharedGallery();
                        // Initialize rating synchronization
                        initRatingSync();
                    }
                }
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showError("Failed to initialize the gallery. Please try again later.");
            }
        })();

        
        // Load shared gallery
        function loadSharedGallery() {
            // Get gallery parameters
            const urlParams = new URLSearchParams(window.location.search);
            
            // Check for direct gallery ID first
            const directGalleryId = urlParams.get('id') || urlParams.get('galleryId');
            if (directGalleryId) {
                console.log("Direct gallery access with ID:", directGalleryId);
                loadGalleryDirect(directGalleryId);
                return;
            }
            
            // Otherwise, look for share ID
            const shareId = urlParams.get('share');
            
            if (!shareId) {
                showPageError("Invalid gallery link. No parameters provided.");
                return;
            }
            
            console.log("Looking for shared gallery with ID:", shareId);
            
            // Set a timeout for loading
            const loadingTimeout = setTimeout(() => {
                if (document.getElementById('loadingIndicator').style.display !== 'none') {
                    showPageError("Gallery is taking too long to load. Please try again later.");
                }
            }, 15000); // 15 seconds timeout
            
            // Get reference to Firestore
            const db = firebase.firestore();
            
            // Check first collection
            db.collection('galleryShares')
                .where('shareId', '==', shareId)
                .get()
                .then(snapshot => {
                    console.log("Query completed for galleryShares, found:", snapshot.size, "documents");
                    
                    if (snapshot.empty) {
                        console.log("No shares found in galleryShares, checking sharedGalleries...");
                        
                        // Try the alternative collection name
                        return db.collection('sharedGalleries')
                            .where('shareId', '==', shareId)
                            .get();
                    }
                    
                    // Clear the timeout since we found data
                    clearTimeout(loadingTimeout);
                    return snapshot;
                })
                .then(snapshot => {
                    if (snapshot.empty) {
                        showPageError("Gallery not found or access has been revoked.");
                        return;
                    }
                    
                    const sharedGallery = snapshot.docs[0].data();
                    console.log("Found shared gallery:", sharedGallery);
                    
                    // Store the actual gallery ID in session storage
                    sessionStorage.setItem('actual_gallery_id', sharedGallery.galleryId);
                    
                    // Hide loading indicator
                    document.getElementById('loadingIndicator').style.display = 'none';
                    
                    if (sharedGallery.passwordProtected) {
                        // Check if we already have access
                        const accessGranted = sessionStorage.getItem(`gallery_access_${shareId}`);
                        if (accessGranted) {
                            // Already authenticated, load gallery
                            loadGalleryContent(sharedGallery.galleryId, sharedGallery.photographerId);
                            return;
                        }
                        
                        // Show password screen
                        document.getElementById('passwordScreen').style.display = 'block';
                        
                        // Update password screen title if we have gallery info
                        updatePasswordScreenTitle(sharedGallery.galleryId);
                        
                        // Focus the password input for accessibility
                        document.getElementById('galleryPassword').focus();
                        
                        // Set up password form submission
                        setupPasswordHandling(sharedGallery, shareId);
                    } else {
                        // No password needed, load gallery directly
                        // First, store access in session storage
                        sessionStorage.setItem(`gallery_access_${shareId}`, 'granted');
                        
                        // Load gallery content
                        loadGalleryContent(sharedGallery.galleryId, sharedGallery.photographerId);
                    }
                })
                .catch(error => {
                    clearTimeout(loadingTimeout);
                    console.error("Error fetching shared gallery:", error);
                    showPageError("Error loading gallery: " + error.message);
                });
        }
// Load gallery photos
        function loadGalleryPhotos(galleryId, db) {
            // Show loading toast
            showToast("Loading photos...", 'info');
            
            db.collection('photos')
                .where('galleryId', '==', galleryId)
                .where('status', '==', 'active')
                .limit(50) // Increased limit for better gallery experience
                .get()
                .then(snapshot => {
                    const photosGrid = document.getElementById('photosGrid');
                    photosGrid.innerHTML = '';
                    
                    if (snapshot.empty) {
                        photosGrid.innerHTML = '<p>No photos in this gallery yet.</p>';
                        return;
                    }
                    
                    // Store all photos in the global array
                    allGalleryPhotos = snapshot.docs.map(doc => doc.data());
                    
                    // Create elements for each photo
                    allGalleryPhotos.forEach(photo => {
                        const photoElement = createPhotoElement(photo);
                        photosGrid.appendChild(photoElement);
                    });
                    
                    // Show success toast
                    showToast("Gallery loaded successfully", 'success');
                    
                    // Initialize rating sync and load total ratings
                    initRatingSync();
                    
                    // Set up real-time updates for gallery counts
                    setupRealTimeCounters();
                })
                .catch(error => {
                    console.error("Error loading photos:", error);
                    showError("Error loading photos: " + error.message);
                });
        }
        
        // The rest of your original functions go here without changes
        // These functions don't interact with the rating system:
        // - createPhotoElement 
        // - stopSlideshow
        // - navigateToPhoto
        // - closeLightbox
        // - toggleSlideshow
        // - openLightbox 
        // - showPageError
        // - showError
        // - showToast
        
        // The rest of your code below, or replace this comment with the rest of your code...
        
        // Create a photo element
        function createPhotoElement(photo) {
            const photoItem = document.createElement('div');
            photoItem.className = 'photo-item';
            
            const photoContainer = document.createElement('div');
            photoContainer.className = 'photo-container';
            photoContainer.style.backgroundImage = `url(${photo.thumbnailUrl || photo.url})`;
            photoContainer.setAttribute('tabindex', '0'); // Make focusable for keyboard navigation
            photoContainer.setAttribute('role', 'img');
            photoContainer.setAttribute('aria-label', photo.name || 'Photo');
            
            const photoDetails = document.createElement('div');
            photoDetails.className = 'photo-details';
            
            const photoName = document.createElement('div');
            photoName.className = 'photo-name';
            photoName.textContent = photo.name || 'Photo';
            
            const photoDate = document.createElement('div');
            photoDate.className = 'photo-date';
            if (photo.uploadedAt) {
                const date = photo.uploadedAt.toDate ? photo.uploadedAt.toDate() : new Date(photo.uploadedAt);
                photoDate.textContent = date.toLocaleDateString();
            }
            
            photoDetails.appendChild(photoName);
            photoDetails.appendChild(photoDate);
            
            photoItem.appendChild(photoContainer);
            photoItem.appendChild(photoDetails);
            
            // Make photo clickable to open lightbox
            photoContainer.addEventListener('click', function() {
                openLightbox(photo);
            });
            
            // Keyboard handler for accessibility
            photoContainer.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    openLightbox(photo);
                }
            });
            
            return photoItem;
        }
        
        // Show page error (full page error)
        function showPageError(message) {
            console.error("Page error:", message);
            
            // Hide loading indicator and other containers
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('passwordScreen').style.display = 'none';
            document.getElementById('galleryContainer').style.display = 'none';
            
            // Show error page
            const errorPage = document.getElementById('errorPage');
            errorPage.style.display = 'block';
            
            // Set error message
            document.getElementById('errorMessage').textContent = message;
            
            // Setup retry button
            document.getElementById('retryBtn').addEventListener('click', function() {
                // Reload the page
                window.location.reload();
            });
        }
        
        // Show error message as toast
        function showError(message) {
            // Show toast notification
            showToast(message, 'error');
        }
        
        // Show toast notification
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            
            // Add aria-live for accessibility
            toast.setAttribute('aria-live', type === 'error' ? 'assertive' : 'polite');
            
            toastContainer.appendChild(toast);
            
            // Remove toast after 4 seconds (a bit longer for better readability)
            setTimeout(() => {
                toast.classList.add('fadeOut');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 4000);
        }
    </script>
</body>
</html>
