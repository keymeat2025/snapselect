
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer" />





    <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    img-src * data: https://*.firebasestorage.app https://firebasestorage.googleapis.com;
    style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com;
    script-src 'self' 'unsafe-inline' https://www.gstatic.com;
    connect-src 'self' https://firestore.googleapis.com https://*.googleapis.com https://*.firebasestorage.app https://firebasestorage.googleapis.com https://*.cloudfunctions.net https://asia-south1-snapselect01-eb74c.cloudfunctions.net;
    font-src 'self' https://cdnjs.cloudflare.com https://use.fontawesome.com;
    ">
    <title>Shared Gallery - SnapSelect</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Your existing CSS styles remain the same */
        /* Basic styles */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        /* ...all your existing CSS... */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* Header */
        header {
            background-color: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 15px 0;
        }
        
        .logo-text {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
        }

        
        /* Password screen */
        .password-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 30px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .password-input {
            width: 100%;
            padding: 12px;
            margin: 15px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        .btn {
            padding: 12px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .error-message {
            color: #e74c3c;
            margin: 10px 0;
            display: none;
        }
        
        /* Gallery container */
        .gallery-container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 20px;
        }
        
        /* Photo grid */
        .photos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .photo-item {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        
        .photo-item:hover {
            transform: translateY(-5px);
        }
        
        .photo-container {
            height: 200px;
            width: 100%;
            background-size: cover;
            background-position: center;
            position: relative;
            cursor: pointer;
        }
        
        .photo-details {
            padding: 12px;
        }
        
        .photo-name {
            font-weight: 500;
            margin-bottom: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .photo-date {
            font-size: 12px;
            color: #777;
        }

        
        /* Toast notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .toast {
            padding: 12px 20px;
            margin-bottom: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            color: white;
            animation: slideIn 0.3s ease;
        }
        
        .toast-success {
            background-color: #27ae60;
        }
        
        .toast-error {
            background-color: #e74c3c;
        }
        
        .toast-info {
            background-color: #3498db;
        }
        
        .toast.fadeOut {
            animation: fadeOut 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        /* Welcome Dashboard Styles */
        .welcome-dashboard {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }
        
        .welcome-container {
            background-color: white;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        
        .welcome-container h1 {
            color: #3498db;
            text-align: center;
            margin-bottom: 25px;
            font-size: 28px;
        }
        
        .welcome-content {
            margin-bottom: 30px;
        }
        
        .welcome-section {
            margin-bottom: 25px;
        }
        
        .welcome-section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 22px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }
        
        .welcome-section p {
            line-height: 1.6;
            color: #555;
        }
        
        .rating-guide {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
        }
        
        .rating-explanation {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .rating-item {
            display: flex;
            align-items: center;
        }
        
        .rating-emoji {
            font-size: 36px;
            margin-right: 15px;
        }
        
        .rating-info h3 {
            margin: 0 0 5px 0;
            font-size: 18px;
            color: #333;
        }
        
        .rating-info p {
            margin: 0;
            font-size: 14px;
            color: #666;
        }
        
        .welcome-actions {
            text-align: center;
        }

        /* Add this CSS to your existing styles to ensure proper layering */

        /* Remove welcome dashboard entirely on client gallery view */
        #welcomeDashboard {
            display: none !important;
        }
        
        /* Ensure password screen is always accessible */
        .password-container {
            position: relative;
            z-index: 2001 !important;
            background-color: white;
        }
        
        #passwordScreen {
            position: relative;
            z-index: 2001 !important;
        }
        
        /* Ensure form inputs are always clickable */
        .password-input,
        .btn {
            position: relative;
            z-index: 2002 !important;
        }
        
        /* Loading indicator should be behind password screen */
        .loading-indicator {
            z-index: 1000;
        }
        
        /* Gallery container normal z-index */
        .gallery-container {
            position: relative;
            z-index: 1;
        }
        
        /* Lightbox should be on top of everything */
        .photo-lightbox {
            z-index: 3000 !important;
        }
        
        /* Toast notifications on top */
        .toast-container {
            z-index: 4000 !important;
        }
        
        /* Rating overlays */
        .rating-container,
        .rating-summary,
        .total-ratings {
            z-index: 999;
        }
        
        /* Sync button */
        .sync-btn {
            z-index: 1000 !important;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
            padding: 12px 30px;
            font-size: 18px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .welcome-skip {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .checkbox {
            margin-right: 8px;
        }

        
        @media (max-width: 768px) {
            .welcome-container {
                padding: 20px;
                width: 95%;
            }
            
            .rating-explanation {
                grid-template-columns: 1fr;
            }
        }
        
        /* Loading spinner */
        .loading-indicator {
            text-align: center;
            margin: 100px auto;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Footer */
        footer {
            margin-top: 50px;
            padding: 20px 0;
            background-color: #f9f9f9;
            text-align: center;
            color: #777;
            font-size: 14px;
        }
        
        /* Accessibility improvements */
        .photo-item:focus-within {
            outline: 3px solid #3498db;
        }
        
        .photo-container:focus {
            outline: none;
            box-shadow: inset 0 0 0 3px #3498db;
        }
        
        /* Error page */
        .error-page {
            text-align: center;
            max-width: 600px;
            margin: 100px auto;
            padding: 30px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none;
        }
        
        .error-icon {
            font-size: 48px;
            color: #e74c3c;
            margin-bottom: 20px;
        }
        
        .retry-btn {
            margin-top: 20px;
        }
        
        /* Studio information */
        .studio-info {
            margin-bottom: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .studio-info h2 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #333;
        }
        
        .studio-info p {
            margin: 5px 0;
            color: #666;
        }
        
        .studio-info .contact {
            margin-top: 15px;
            font-size: 14px;
            color: #777;
        }
                /* Photo lightbox and enhanced features */
        .photo-lightbox {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .lightbox-image-container {
            position: relative;
            height: 70%;
            width: 80%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        .lightbox-image {
            max-height: 100%;
            max-width: 100%;
            object-fit: contain;
            transition: all 0.3s ease;
        }
        
        .lightbox-toolbar {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 15px;
            z-index: 1001;
        }
        
        .modal-button {
            background-color: rgba(255, 255, 255, 0.3);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .modal-button:hover {
            background-color: rgba(255, 255, 255, 0.5);
        }
        
        .modal-nav-button {
            position: absolute;
            top: 30%;
            transform: translateY(-50%);
            background-color: rgba(255, 255, 255, 0.3);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
            z-index: 1001;
        }
        
        .modal-nav-button:hover {
            background-color: rgba(255, 255, 255, 0.5);
        }
        
        .modal-prev {
            left: 20px;
        }
        
        .modal-next {
            right: 20px;
        }
        
        .thumbnails-container {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            height: 90px;
            display: flex;
            overflow-x: auto;
            background-color: rgba(0,0,0,0.7);
            padding: 15px 0;
            justify-content: center;
        }
        
        .thumbnail {
            height: 60px;
            margin: 0 5px;
            border: 2px solid transparent;
            cursor: pointer;
            opacity: 0.6;
            transition: all 0.2s ease;
        }
        
        .thumbnail:hover {
            opacity: 0.9;
            transform: translateY(-3px);
        }
        
        .thumbnail.active {
            border-color: #3498db;
            opacity: 1;
        }
        
        .zoom-controls {
            position: absolute;
            bottom: 70px;
            right: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 1001;
            gap: 5px;
        }
        
        .zoom-btn {
            background-color: rgba(255, 255, 255, 0.3);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            margin: 5px 0;
            font-size: 16px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
        
        .zoom-btn:hover {
            background-color: rgba(255, 255, 255, 0.5);
        }
        
        .rating-container {
          
            position: absolute;
            bottom: 20px;
            right: 20px; /* Changed from center to right */
            display: flex;
            flex-direction: row; /* Changed from column to row */
            gap: 10px;
            background-color: rgba(0, 0, 0, 0.5); /* Reduced opacity */
            padding: 8px 12px !important; /* Smaller padding */
            border-radius: 20px;
            z-index: 1001;
            transform: scale(0.85); /* Overall size reduction */
            transform-origin: bottom right;
            transition: transform 0.2s ease, opacity 0.2s ease;
            opacity: 0.7; /* Start with lower opacity */
        }
        .rating-container:hover {
            transform: scale(1); /* Return to normal size on hover */
            opacity: 1;
        }
        
        .rating-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.2s;
            padding: 5px;
        }
        
        .rating-btn:hover, .rating-btn.selected {
            opacity: 1;
            transform: scale(1.2);
        }
        
        .rating-summary {
            position: fixed;
            top: 20px;
            left: 20px;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 10px 15px;
            border-radius: 8px;
            display: flex;
            gap: 15px;
            z-index: 999;
        }
        
        .rating-count {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .image-watermark {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.2"><text x="10" y="50" font-family="Arial" font-size="10" fill="white" transform="rotate(-45 50 50)">SnapSelect</text></svg>');
            pointer-events: none;
            z-index: 1;
        }
        
        .watermark-text {
            position: absolute;
            bottom: 5px;
            right: 10px;
            color: rgba(255, 255, 255, 0.3);
            font-size: 12px;
            pointer-events: none;
        }
        
        .protection-layer {
            position: absolute;
            inset: 0;
            z-index: 2;
            background-color: transparent;
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        .fadeIn {
            animation: fadeIn 0.3s ease-in-out forwards;
        }
        
        .fadeOut {
            animation: fadeOut 0.3s ease-in-out forwards;
        }
        
        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .modal-button {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
            
            .modal-nav-button {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
            
            .thumbnails-container {
                height: 70px;
            }
            
            .thumbnail {
                height: 40px;
            }
            
            .rating-container {
                bottom: 110px;
                gap: 10px;
            }
            
            .rating-btn {
                font-size: 20px;
            }
            
            .zoom-controls {
                bottom: 70px;
                right: 15px;
            }
        }
        
        /* Add a style for the sync button */
        .sync-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 18px;
        }
        
        /* Add style for the total ratings display */
        .total-ratings {
            position: fixed;
            top: 70px;
            left: 20px;
            background-color: rgba(52, 152, 219, 0.8);
            padding: 10px 15px;
            border-radius: 8px;
            display: flex;
            gap: 15px;
            z-index: 999;
        }
        .rating-status {
            position: fixed;
            top: 20px;
            left: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            z-index: 1002;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            cursor: move;
        }
        
        .lightbox-rating-counter {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .photo-rating-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            z-index: 1002;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        .thumbnail-rating-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 5;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .thumbnail-rating-indicator::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(52, 152, 219, 0.3);
            border-radius: 4px;
            z-index: -1;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.3; }
            50% { opacity: 0.5; }
            100% { opacity: 0.3; }
        }
        
        .rating-btn-container {
        
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            margin: 0 3px; /* Reduced spacing */
            transform: scale(0.85); /* Initial size reduction */
            transition: transform 0.2s ease;
        }

        .rating-btn-container:hover {
            transform: scale(1.1); /* Slight enlargement on hover */
            z-index: 2; /* Bring to front when hovered */
        }
        
        .rating-container {
            display: flex;
            flex-direction: column;
            padding: 15px 25px !important;
        }
        
        .rating-btn {
            position: relative;
            z-index: 1;
            font-size: 20px; /* Smaller font size for emojis */
            opacity: 0.8;
            transition: all 0.2s ease;
        }
        
        .rating-btn.selected {
           
            transform: scale(1.2);
            opacity: 1;
        }
        
        /* 3. Improve the rating button labels */
        .rating-btn-label {
            font-size: 8px; /* Reduced font size */
            color: white;
            max-width: 50px; /* Narrower labels */
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            visibility: hidden;
            opacity: 0;
            height: 0;
            transition: all 0.2s ease;
        }
        
        /* Show label on hover */
        .rating-btn-container:hover .rating-btn-label {
            visibility: visible;
            opacity: 1;
            height: auto;
        }
        
        /* 4. Improve the rating indicator for thumbnails */
        .thumbnail-rating-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 10px;
            z-index: 5;
            display: flex;
            align-items: center;
            gap: 3px;
            transform: scale(0.85); /* Smaller size */
        }
        
        /* 5. Photo rating indicator in lightbox view */
        .photo-rating-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.6); /* Reduced opacity */
            color: white;
            padding: 6px 10px; /* Smaller padding */
            border-radius: 5px;
            z-index: 1002;
            font-size: 12px; /* Smaller font */
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transform: scale(0.9);
            transform-origin: top right;
        }
        
        /* 6. Improve mobile responsiveness */
        @media (max-width: 768px) {
            .rating-container {
                transform: scale(0.75);
                padding: 6px 10px !important;
                bottom: 15px;
                right: 15px;
            }
            
            .rating-btn {
                font-size: 18px;
            }
            
            .rating-btn-label {
                font-size: 7px;
                max-width: 40px;
            }
        }
        /* Add these styles to your existing CSS */
        .thumbnail-rating-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 8px;
            display: none;
            z-index: 5;
            transition: opacity 0.2s ease;
        }
        
        .photo-container:hover .thumbnail-rating-overlay {
            display: block;
        }
        
        .thumbnail-rating-buttons {
            display: flex;
            justify-content: space-around;
        }
        
        .thumbnail-rating-btn {
            background: none;
            border: none;
            font-size: 18px;
            padding: 5px;
            cursor: pointer;
            transition: transform 0.2s ease;
            color: white;
            opacity: 0.8;
        }
        
        .thumbnail-rating-btn:hover {
            transform: scale(1.2);
            opacity: 1;
        }
        
        .thumbnail-rating-btn.selected {
            opacity: 1;
            transform: scale(1.2);
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
        }
        
        .photo-rated {
            box-shadow: 0 0 0 3px #3498db;
        }

        .selection-progress {
            margin-top: 10px;
            font-weight: bold;
            color: white;
            text-align: center;
        }

        .selection-progress {
           
            color: black !important;
            margin-top: 10px;
            font-weight: bold;
            text-align: center;
        }
        .rotation-controls {
            position: absolute;
            bottom: 70px; /* Above zoom controls */
            left: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 1001;
            gap: 5px;
        }
        
        .rotate-btn {
            background-color: rgba(255, 255, 255, 0.3);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 16px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .rotate-btn:hover {
            background-color: rgba(255, 255, 255, 0.5);
        }
        
        .rotation-indicator {
            color: white;
            font-size: 12px;
            text-align: center;
            margin-top: 2px;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 2px 6px;
            border-radius: 3px;
        }
        
        /* Enhanced lightbox image with rotation support */
        .lightbox-image {
            transition: transform 0.3s ease;
            transform-origin: center center;
        }
        
        /* Auto-rotation detection styles */
        .rotation-auto-fix {
            position: absolute;
            top: 80px;
            left: 20px;
            background-color: rgba(255, 193, 7, 0.9);
            color: black;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1002;
            animation: slideIn 0.3s ease;
        }
        
        .rotation-auto-fix button {
            background: none;
            border: none;
            color: #007bff;
            text-decoration: underline;
            cursor: pointer;
            margin-left: 5px;
        }
        
        /* Mobile responsive adjustments */
        @media (max-width: 768px) {
            .rotation-controls {
                bottom: 70px;
                left: 10px;
            }
            
            .rotate-btn {
                width: 35px;
                height: 35px;
                font-size: 14px;
            }
        }

        /* Blue overlay text visibility fixes */
        .submit-snapselections-btn .button-text,
        .submit-snapselections-btn .button-icon {
            z-index: 100 !important;
            position: relative !important;
            color: #333 !important;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.8) !important;
        }
        
        .submit-snapselections-btn .progress-container {
            opacity: 0.6 !important;
            mix-blend-mode: multiply !important;
        }
        
        .submit-snapselections-btn .progress-bar {
            opacity: 0.7 !important;
        }
        
        /* Alternative: Bottom progress indicator */
        .submit-snapselections-btn.alt-progress .progress-container {
            height: 4px !important;
            bottom: 0 !important;
            top: auto !important;
            border-radius: 0 0 23px 23px !important;
        }
        
        /* Ensure studio info is properly layered */
        #studioInfo {
            position: relative !important;
            z-index: 10 !important;
        }
        
        /* Better text contrast */
        .submit-snapselections-btn.ready .button-text,
        .submit-snapselections-btn.ready .button-icon {
            color: #0056b3 !important;
            font-weight: bold !important;
        }
        
        .submit-snapselections-btn.complete .button-text,
        .submit-snapselections-btn.complete .button-icon {
            color: #155724 !important;
            font-weight: bold !important;
        }


        /* SUBMISSION CONFIRMATION VIEW STYLES */
        
        /* 1. Confirmation Badge */
        .confirmation-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: #d4edda;
            color: #155724;
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            border: 1px solid #c3e6cb;
        }
        
        .confirmation-badge i {
            font-size: 18px;
        }
        
        /* 2. Submission Summary Banner */
        .submission-summary-banner {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #28a745;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.1);
        }
        
        .summary-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .summary-icon {
            font-size: 48px;
            color: #28a745;
            line-height: 1;
        }
        
        .summary-content h3 {
            margin: 0 0 8px 0;
            color: #155724;
            font-size: 24px;
            font-weight: 600;
        }
        
        .summary-content p {
            margin: 0;
            color: #6c757d;
            font-size: 16px;
        }
        
        /* 3. Summary Statistics */
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            text-align: center;
            padding: 16px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            transition: transform 0.2s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #28a745;
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* 4. Selection Breakdown */
        .selection-breakdown h4 {
            margin: 0 0 16px 0;
            color: #333;
            font-size: 18px;
        }
        
        .breakdown-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }
        
        .breakdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }
        
        .breakdown-emoji {
            font-size: 20px;
        }
        
        .breakdown-label {
            flex: 1;
            font-weight: 500;
            color: #333;
        }
        
        .breakdown-count {
            font-weight: bold;
            color: #28a745;
            font-size: 18px;
        }
        
        /* 5. Rating Sections */
        .rating-section {
            margin-bottom: 40px;
        }
        
        .rating-section-header {
            margin-bottom: 20px;
        }
        
        .section-title {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }
        
        .section-emoji {
            font-size: 24px;
        }
        
        .section-title h3 {
            margin: 0;
            color: #333;
            font-size: 20px;
            font-weight: 600;
        }
        
        .section-count {
            color: #6c757d;
            font-size: 16px;
            font-weight: normal;
        }
        
        .section-line {
            height: 3px;
            border-radius: 2px;
            width: 100%;
        }
        
        .rating-section-grid {
            margin-top: 0;
        }
        
        /* 6. Confirmation Photo Elements */
        .confirmation-photo {
            position: relative;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .confirmation-photo:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .selection-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 8px;
            pointer-events: none;
        }
        
        .selection-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            color: white;
            padding: 6px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 4px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            z-index: 5;
        }
        
        .badge-emoji {
            font-size: 14px;
        }
        
        .badge-text {
            letter-spacing: 0.5px;
        }
        
        /* 7. View-Only Lightbox */
        .view-only-lightbox {
            /* Same base styles as regular lightbox */
        }
        
        .lightbox-status-indicator {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1003;
        }
        
        .status-badge {
            background: rgba(40, 167, 69, 0.9);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
        }
        
        .status-emoji {
            font-size: 18px;
        }
        
        .status-text {
            font-size: 14px;
            letter-spacing: 0.5px;
        }
        
        /* 8. Contact Photographer Message */
        .contact-photographer-message {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 2px solid #ffc107;
            border-radius: 12px;
            padding: 24px;
            margin-top: 40px;
            display: flex;
            align-items: flex-start;
            gap: 20px;
        }
        
        .contact-icon {
            font-size: 32px;
            color: #856404;
            line-height: 1;
            margin-top: 4px;
        }
        
        .contact-content {
            flex: 1;
        }
        
        .contact-content h4 {
            margin: 0 0 8px 0;
            color: #856404;
            font-size: 18px;
            font-weight: 600;
        }
        
        .contact-content > p {
            margin: 0 0 16px 0;
            color: #856404;
            font-size: 14px;
        }
        
        .contact-info {
            background: rgba(255, 255, 255, 0.7);
            padding: 12px 16px;
            border-radius: 6px;
            border: 1px solid rgba(133, 100, 4, 0.2);
        }
        
        .contact-info p {
            margin: 4px 0;
            font-size: 13px;
            color: #856404;
        }
        
        .contact-info strong {
            font-weight: 600;
        }
        
        /* 9. Mobile Responsiveness */
        @media (max-width: 768px) {
            .submission-summary-banner {
                padding: 16px;
                margin-bottom: 20px;
            }
            
            .summary-header {
                flex-direction: column;
                text-align: center;
                gap: 12px;
                margin-bottom: 16px;
            }
            
            .summary-icon {
                font-size: 36px;
            }
            
            .summary-content h3 {
                font-size: 20px;
            }
            
            .summary-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            
            .breakdown-grid {
                grid-template-columns: 1fr;
            }
            
            .section-title {
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .section-title h3 {
                font-size: 18px;
            }
            
            .contact-photographer-message {
                flex-direction: column;
                padding: 16px;
                gap: 12px;
                text-align: center;
            }
            
            .contact-icon {
                font-size: 24px;
                margin-top: 0;
            }
            
            .lightbox-status-indicator {
                left: 20px;
                right: 20px;
                transform: none;
                top: 15px;
            }
            
            .status-badge {
                padding: 8px 12px;
                font-size: 12px;
                gap: 6px;
            }
            
            .status-emoji {
                font-size: 14px;
            }
        }
        
        @media (max-width: 480px) {
            .summary-stats {
                grid-template-columns: 1fr;
            }
            
            .stat-card {
                padding: 12px;
            }
            
            .stat-number {
                font-size: 20px;
            }
            
            .breakdown-item {
                padding: 8px;
                gap: 8px;
            }
            
            .breakdown-emoji {
                font-size: 16px;
            }
            
            .breakdown-count {
                font-size: 16px;
            }
            
            .selection-badge {
                top: 8px;
                right: 8px;
                padding: 4px 6px;
                font-size: 9px;
            }
            
            .badge-emoji {
                font-size: 12px;
            }
        }
        
        /* 10. Animations */
        @keyframes slideInFromTop {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .submission-summary-banner {
            animation: slideInFromTop 0.6s ease-out;
        }
        
        .rating-section {
            animation: fadeInScale 0.5s ease-out;
        }
        
        .rating-section:nth-child(2) { animation-delay: 0.1s; }
        .rating-section:nth-child(3) { animation-delay: 0.2s; }
        .rating-section:nth-child(4) { animation-delay: 0.3s; }
        .rating-section:nth-child(5) { animation-delay: 0.4s; }
        
        .contact-photographer-message {
            animation: slideInFromTop 0.6s ease-out 0.5s both;
        }
        
        /* 11. Print Styles */
        @media print {
            .lightbox-toolbar,
            .modal-nav-button,
            .contact-photographer-message {
                display: none !important;
            }
            
            .submission-summary-banner {
                break-inside: avoid;
                page-break-inside: avoid;
            }
            
            .rating-section {
                break-inside: avoid;
                page-break-inside: avoid;
            }
            
            .confirmation-photo {
                break-inside: avoid;
                page-break-inside: avoid;
            }
        }
        
        /* 12. High Contrast Mode Support */
        @media (prefers-contrast: high) {
            .submission-summary-banner {
                border-width: 3px;
            }
            
            .selection-badge {
                border: 2px solid rgba(255, 255, 255, 0.8);
            }
            
            .status-badge {
                border: 2px solid rgba(255, 255, 255, 0.8);
            }
            
            .contact-photographer-message {
                border-width: 3px;
            }
        }
        
        /* 13. Reduced Motion Support */
        @media (prefers-reduced-motion: reduce) {
            .confirmation-photo,
            .stat-card {
                transition: none;
            }
            
            .submission-summary-banner,
            .rating-section,
            .contact-photographer-message {
                animation: none;
            }
            
            .confirmation-photo:hover {
                transform: none;
            }
        }
        
        /* 14. Dark Mode Support (if needed) */
        @media (prefers-color-scheme: dark) {
            .submission-summary-banner {
                background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
                border-color: #38a169;
                color: #e2e8f0;
            }
            
            .summary-content h3 {
                color: #68d391;
            }
            
            .stat-card {
                background: #2d3748;
                border-color: #4a5568;
                color: #e2e8f0;
            }
            
            .breakdown-item {
                background: #2d3748;
                border-color: #4a5568;
                color: #e2e8f0;
            }
            
            .contact-photographer-message {
                background: linear-gradient(135deg, #744210 0%, #5a2d0c 100%);
                border-color: #d69e2e;
            }
            
            .contact-info {
                background: rgba(0, 0, 0, 0.3);
                border-color: rgba(214, 158, 46, 0.3);
            }
        }
        
    </style>
</head>
<body>
    <!-- Welcome Dashboard (initially hidden) -->
    <div id="welcomeDashboard" class="welcome-dashboard" style="display: none;">
        <!-- Your existing welcome dashboard HTML remains the same -->
    </div>

    <div id="toastContainer" class="toast-container"></div>
    <div id="ratingSummary" class="rating-summary">
        <div class="rating-title">Your Current Ratings</div>
        <div class="rating-count"><span>‚ù§Ô∏è</span><span id="heartCount">0</span></div>
        <div class="rating-count"><span>üëç</span><span id="thumbsUpCount">0</span></div>
        <div class="rating-count"><span>ü§î</span><span id="thinkingCount">0</span></div>
        <div class="rating-count"><span>üëé</span><span id="thumbsDownCount">0</span></div>
        
        <div class="selection-progress"><span id="totalSelectionsCount">0</span> / <span id="totalPhotosCount">0</span> photos selected</div>
        
    </div>


    <header>
        <div class="container">
            <nav>
                <a href="../../index.html" class="logo">
                    <div class="logo-text">SnapSelect</div>
                </a>
            </nav>
        </div>
    </header>

    <main>
        <!-- Your existing HTML elements remain the same -->
    
        <!-- Loading indicator -->
        <div id="loadingIndicator" class="loading-indicator">
            <div class="spinner"></div>
            <p>Loading gallery...</p>
        </div>
        
        <!-- Error page -->
        <div id="errorPage" class="error-page">
            <div class="error-icon">
                <i class="fas fa-exclamation-circle"></i>
            </div>
            <h2>Something went wrong</h2>
            <p id="errorMessage">We couldn't load the gallery. Please try again later.</p>
            <button id="retryBtn" class="btn retry-btn">Try Again</button>
        </div>
        
        <!-- Password protection screen (initially hidden) -->
        <div id="passwordScreen" class="password-container" style="display: none;">
            <h2 id="passwordGalleryTitle">Protected Gallery</h2>
            <p>This gallery is password protected. Please enter the password to view it.</p>
            <div id="passwordError" class="error-message">Incorrect password. Please try again.</div>
            <form id="passwordForm" onsubmit="return false;">
                <input type="password" id="galleryPassword" class="password-input" placeholder="Enter password" aria-label="Gallery password">
                <button id="submitPasswordBtn" class="btn">View Gallery</button>
            </form>

        </div>
        
        <!-- Gallery container (initially hidden) -->
        <div id="galleryContainer" class="gallery-container" style="display: none;">
            <div id="studioInfo" class="studio-info">
                <h2 id="studioName">Photography Studio</h2>
                <p id="galleryTitle">Shared Gallery</p>
                <div class="contact">
                    <p id="studioContact">Contact information will appear here if available</p>
                </div>
            </div>
            
            <div id="photosGrid" class="photos-grid">
                <!-- Photos will be loaded here -->
            </div>
        </div>
    </main>
    

    <footer>
        <div class="container">
            <p>&copy; <span id="currentYear">2025</span> SnapSelect. All rights reserved.</p>
        </div>
    </footer>
<!-- Firebase SDK Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>
    
    <!-- Inline script to load the gallery -->
    <script>
        // Variable to store all gallery photos and ratings
        let allGalleryPhotos = [];
        let slideshowInterval = null; // For slideshow feature
        let photoRatings = {}; // Store ratings for each photo
        let currentRotation = 0;
        let currentPhotoId = null;
        let ratingCounts = {
            heart: 0,
            thumbsUp: 0,
            thinking: 0,
            thumbsDown: 0
        };
        
        // Firebase synchronization variables
        let syncTimeout = null;
        let syncInterval = null;
        let pendingSync = false;
        let lastSyncTime = null;
        
        // Function to generate or retrieve a user identifier
        function getUserIdentifier() {
          
            // Check if we have a password-based session first
            const galleryId = getGalleryId();
            const urlParams = new URLSearchParams(window.location.search);
            const shareId = urlParams.get('share');
            
            if (galleryId && shareId) {
                // Check for password-based user ID in sessionStorage
                const passwordUserId = sessionStorage.getItem(`user_id_${shareId}`);
                if (passwordUserId) {
                    return passwordUserId;
                }
            }
            
            // Fallback to localStorage method (existing behavior)
            let userId = localStorage.getItem('user_id');
            if (!userId) {
                userId = 'user_' + Math.random().toString(36).substring(2, 15);
                localStorage.setItem('user_id', userId);
            }
            return userId;
        }
        
        // Function to get gallery ID from URL or session storage
        function getGalleryId() {
            const urlParams = new URLSearchParams(window.location.search);
            const shareId = urlParams.get('share');
            const directGalleryId = urlParams.get('id') || urlParams.get('galleryId');
            
            if (directGalleryId) return directGalleryId;
            
            // Try to get from session storage if not in URL
            return sessionStorage.getItem('actual_gallery_id');
        }

        function formatTimestampSafely(timestamp) {
            try {
                let dateObj;
                
                if (timestamp instanceof Date) {
                    dateObj = timestamp;
                } else if (typeof timestamp === 'string') {
                    dateObj = new Date(timestamp);
                } else if (timestamp && typeof timestamp.toDate === 'function') {
                    dateObj = timestamp.toDate();
                } else if (timestamp && timestamp.seconds) {
                    dateObj = new Date(timestamp.seconds * 1000);
                } else {
                    dateObj = new Date();
                }
                
                if (isNaN(dateObj.getTime())) {
                    throw new Error('Invalid date');
                }
                
                return `${dateObj.toLocaleDateString()} at ${dateObj.toLocaleTimeString()}`;
            } catch (error) {
                console.warn('Date formatting error:', error);
                return 'recently';
            }
        }



       

        

 
        
        // Disable right-click
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            return false;
        }, false);

        // Disable keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Prevent Ctrl+S, Ctrl+U, Ctrl+P, Ctrl+Shift+I, F12
            if ((e.ctrlKey && ['s','u','p'].includes(e.key.toLowerCase())) || 
                (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'i') || 
                e.key === 'F12') {
                e.preventDefault();
                return false;
            }
        });

        // Disable drag and drop
        document.addEventListener('dragstart', function(e) {
            e.preventDefault();
            return false;
        });
        
        // Access control for client gallery
        function checkGalleryAccess() {
            // Get gallery parameters
            const urlParams = new URLSearchParams(window.location.search);
            
            // Look for different possible ID parameters
            const galleryId = urlParams.get('id') || urlParams.get('galleryId');
            const shareId = urlParams.get('share');
            
            // If no ID is present, can't proceed
            if (!galleryId && !shareId) {
                showPageError("Invalid gallery link. No gallery ID or share ID provided.");
                return false;
            }
            
            // If we have a direct gallery ID
            if (galleryId) {
                // Check if access has been granted via password
                const accessToken = sessionStorage.getItem(`gallery_access_${galleryId}`);
                
                if (!accessToken) {
                    console.log("Direct gallery access attempted without authentication");
                    // Look for the studio name and share ID
                    try {
                        const actualGalleryId = sessionStorage.getItem('actual_gallery_id') || galleryId;
                        findStudioAndShareInfo(actualGalleryId);
                        return false;
                    } catch (error) {
                        console.error("Error redirecting to password page:", error);
                        showPageError("Authentication error. Please try accessing through the shared link.");
                        return false;
                    }
                }
            }
            
            // If we have a share ID, we'll verify it during regular loading
            return true;
        }

        
        // Rating system functions
   
        
        function updateRatingCounts() {
     
  
    // Reset counts
            ratingCounts = {
                heart: 0,
                thumbsUp: 0,
                thinking: 0,
                thumbsDown: 0
            };
            
            // Count each rating type
            Object.values(photoRatings).forEach(rating => {
                if (rating && ratingCounts[rating] !== undefined) {
                    ratingCounts[rating]++;
                }
            });
            
            console.log("Rating counts:", ratingCounts); // ADD THIS
            //console.log("Photo ratings:", photoRatings); // ADD THIS
            
            // Update display
            document.getElementById('heartCount').textContent = ratingCounts.heart;
            document.getElementById('thumbsUpCount').textContent = ratingCounts.thumbsUp;
            document.getElementById('thinkingCount').textContent = ratingCounts.thinking;
            document.getElementById('thumbsDownCount').textContent = ratingCounts.thumbsDown;
            
            const totalRatings = Object.values(ratingCounts).reduce((a, b) => a + b, 0);
            console.log("Total ratings:", totalRatings); // ADD THIS
            
            document.getElementById('ratingSummary').style.display = totalRatings > 0 ? 'flex' : 'none';
        
            // Update selection progress
            const totalSelections = Object.values(ratingCounts).reduce((a, b) => a + b, 0);
            const totalPhotos = allGalleryPhotos.length;
            document.getElementById('totalSelectionsCount').textContent = totalSelections;
            document.getElementById('totalPhotosCount').textContent = totalPhotos;
            
            console.log(`Selection progress: ${totalSelections} / ${totalPhotos}`); // ADD THIS
            updateSubmitButton();
        }


 
        function setPhotoRating(photoId, rating) {
            // ====== SECURITY LOCKDOWN CHECKS ======
            const galleryId = getGalleryId();
            
            // Check multiple lockdown indicators
            if (window.ratingsDisabled || 
                localStorage.getItem(`gallery_submitted_${galleryId}`) ||
                sessionStorage.getItem(`submission_lockdown_${galleryId}`)) {
                showToast("Cannot modify ratings after submission", 'error');
                console.log('üîí Rating blocked - gallery is locked down');
                return; // STOP HERE - no Firebase operations
            }
            
            // ====== REST OF EXISTING FUNCTION ======
            const userId = getUserIdentifier();
            
            if (!galleryId || !userId) {
                showToast("Error: Missing gallery or user info", 'error');
                return;
            }
        
            const db = firebase.firestore();
            const oldRating = photoRatings[photoId];
            
            // Check if this is a toggle (same rating clicked again)
            if (oldRating === rating) {
                // REMOVE rating - direct Firebase delete
                db.collection('photoRatings')
                    .where('galleryId', '==', galleryId)
                    .where('userId', '==', userId)
                    .where('photoId', '==', photoId)
                    .get()
                    .then(snapshot => {
                        if (!snapshot.empty) {
                            // Delete the document
                            snapshot.docs[0].ref.delete()
                                .then(() => {
                                    // Update local state
                                    delete photoRatings[photoId];
                                    updateLocalUI(photoId, null);
                                    showToast("Rating removed", 'info');
                                    
                                    // Refresh counters
                                    refreshAllCounters();
                                })
                                .catch(error => {
                                    console.error("Error removing rating:", error);
                                    showToast("Error removing rating", 'error');
                                });
                        }
                    });
            } else {
                // ADD/UPDATE rating - direct Firebase write
                const ratingData = {
                    userId: userId,
                    photoId: photoId,
                    galleryId: galleryId,
                    rating: rating,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
        
                // Check for existing rating to update
                db.collection('photoRatings')
                    .where('galleryId', '==', galleryId)
                    .where('userId', '==', userId)
                    .where('photoId', '==', photoId)
                    .get()
                    .then(snapshot => {
                        if (!snapshot.empty) {
                            // Update existing
                            return snapshot.docs[0].ref.update({
                                rating: rating,
                                timestamp: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        } else {
                            // Create new
                            return db.collection('photoRatings').add(ratingData);
                        }
                    })
                    .then(() => {
                        // Update local state
                        photoRatings[photoId] = rating;
                        updateLocalUI(photoId, rating);
                        showToast(`Photo marked as ${getRatingLabel(rating)}`, 'success');
                        
                        // Trigger gallery freeze on first rating
                        if (Object.keys(photoRatings).length === 1) {
                            freezeGalleryOnFirstInteraction(photoId);
                        }
                        
                        // Refresh counters
                        refreshAllCounters();
                    })
                    .catch(error => {
                        console.error("Error saving rating:", error);
                        showToast("Error saving rating", 'error');
                    });
            }
        }

        
        function updateLocalUI(photoId, rating) {
            // Update rating counts
            updateRatingCounts();
            
            // Update lightbox if open
            const lightbox = document.getElementById('photoLightbox');
            if (lightbox) {
                // Update rating buttons
                const ratingButtons = lightbox.querySelectorAll('.rating-btn');
                ratingButtons.forEach(btn => {
                    btn.classList.remove('selected');
                    if (rating && rating === btn.getAttribute('data-rating')) {
                        btn.classList.add('selected');
                    }
                });
                
                // Update rating indicator
                updatePhotoRatingIndicator(photoId, lightbox);
                
                // Update lightbox counters
                updateLightboxCounters();
            }
            
            // Update thumbnail indicators
            updateThumbnailRatingIndicator(photoId, rating);
        }
        
        // 3. NEW: Update lightbox counters
        function updateLightboxCounters() {
            const sessionRatings = {
                heart: 0,
                thumbsUp: 0,
                thinking: 0,
                thumbsDown: 0
            };
            
            // Count current ratings
            for (const photoId in photoRatings) {
                const rating = photoRatings[photoId];
                if (sessionRatings[rating] !== undefined) {
                    sessionRatings[rating]++;
                }
            }
            
            // Update counter displays
            const ratingTypes = ['heart', 'thumbsUp', 'thinking', 'thumbsDown'];
            ratingTypes.forEach(type => {
                const counter = document.getElementById(`lightbox-${type}-count`);
                if (counter) {
                    counter.textContent = sessionRatings[type];
                }
            });
        }
        
        // 4. NEW: Update thumbnail rating indicator
        function updateThumbnailRatingIndicator(photoId, rating) {
            const photoElement = document.querySelector(`.photo-item[data-photo-id="${photoId}"]`);
            if (!photoElement) return;
            
            // Remove existing indicator
            const existingIndicator = photoElement.querySelector('.thumbnail-rating-indicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }
            
            // Remove rated class
            photoElement.classList.remove('photo-rated');
            
            if (rating) {
                // Add new indicator
                const indicator = document.createElement('div');
                indicator.className = 'thumbnail-rating-indicator';
                indicator.innerHTML = `‚úì ${getRatingEmoji(rating)}`;
                indicator.title = getRatingLabel(rating);
                
                photoElement.querySelector('.photo-container').appendChild(indicator);
                photoElement.classList.add('photo-rated');
            }
            
            // Update thumbnail rating buttons
            const thumbnailRatingButtons = photoElement.querySelectorAll('.thumbnail-rating-btn');
            thumbnailRatingButtons.forEach(btn => {
                btn.classList.remove('selected');
                if (rating && rating === btn.getAttribute('data-rating')) {
                    btn.classList.add('selected');
                }
            });
        }
        
        // 5. REPLACE loadRatingsFromFirebase() - Clean version
        function loadRatingsFromFirebase() {
            const userId = getUserIdentifier();
            const galleryId = getGalleryId();
            
            if (!galleryId || !userId) {
                console.log("Cannot load ratings without gallery ID and user ID");
                return;
            }
            
            const db = firebase.firestore();
            
            console.log("Loading ratings from Firebase...");
            
            db.collection('photoRatings')
                .where('galleryId', '==', galleryId)
                .where('userId', '==', userId)
                .get()
                .then((snapshot) => {
                    // Clear existing ratings
                    photoRatings = {};
                    
                    if (!snapshot.empty) {
                        // Load only current user's ratings from Firebase
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            photoRatings[data.photoId] = data.rating;
                        });
                        
                        console.log("Loaded", Object.keys(photoRatings).length, "ratings from Firebase");
                    } else {
                        console.log("No ratings found in Firebase for this user");
                    }
                    
                    // Update UI
                    updateRatingCounts();
                    
                    // Refresh photo grid to show rating indicators
                    refreshPhotoGrid();
                })
                .catch(error => {
                    console.error("Error loading ratings from Firebase:", error);
                });
        }


        // Add this function (it was in the artifact but missing from your file)
     
        
        // 6. REPLACE updateGalleryRatingCounters() - Simple version

        
        // 7. NEW: Simple refresh function
        function refreshAllCounters() {
            // Update individual user counts
            updateRatingCounts();
            
            // Update lightbox counters if open
            updateLightboxCounters();
            
            updateSubmitButton(); 
           
        }
        
        // 8. REPLACE initRatingSync() - Simplified version
        function initRatingSync() {
            console.log("Initializing clean rating system...");
            
            // Load user's ratings from Firebase
            loadRatingsFromFirebase();
            
        

          
          
            
            // Remove localStorage cleanup
            localStorage.removeItem('photoRatings');
            
            console.log("Rating system initialized");
        }

      /*  
      // REPLACE your calculateGalleryTotals() function with this:
        function calculateGalleryTotals() {
            const galleryId = getGalleryId();
            if (!galleryId) return;
            
            const db = firebase.firestore();
            
            console.log("Calculating gallery totals for all users...");
            
            // Simple query - get ALL ratings for this gallery (no orderBy needed)
            db.collection('photoRatings')
                .where('galleryId', '==', galleryId)
                .get()
                .then((snapshot) => {
                    const totals = {
                        heart: 0,
                        thumbsUp: 0,
                        thinking: 0,
                        thumbsDown: 0,
                        totalUsers: 0,
                        totalRatings: 0,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    if (!snapshot.empty) {
                        const uniqueUsers = new Set();
                        
                        // Count all ratings from all users
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            const rating = data.rating;
                            const userId = data.userId;
                            
                            // Count the rating
                            if (totals[rating] !== undefined) {
                                totals[rating]++;
                                totals.totalRatings++;
                            }
                            
                            // Track unique users
                            if (userId) {
                                uniqueUsers.add(userId);
                            }
                        });
                        
                        totals.totalUsers = uniqueUsers.size;
                        
                        console.log("Gallery totals calculated:", totals);
                    } else {
                        console.log("No ratings found in gallery");
                    }
                    
              
                    
                    // Save to galleries document
                    db.collection('galleries')
                        .doc(galleryId)
                        .update({
                            ratingTotals: totals
                        })
                        .then(() => {
                            console.log("Rating totals saved to galleries collection!");
                        })
                        .catch(error => console.error("Error saving totals:", error));
                })
                .catch(error => {
                    console.error("Error calculating totals:", error);
                });
        }

        */


     
     
        
   
        
    // Function to freeze gallery on first client interaction
        function freezeGalleryOnFirstInteraction(photoId) {
            try {
                const galleryId = getGalleryId();
                const userId = getUserIdentifier();
                
                if (!galleryId) return;
                
                const db = firebase.firestore();
                
                // First check if gallery is already frozen
                db.collection('galleries').doc(galleryId).get()
                    .then(doc => {
                        if (!doc.exists) return;
                        
                        const gallery = doc.data();
                        if (gallery.clientInteractionStarted) {
                            // Already frozen, nothing to do
                            return;
                        }
                        
                        // Update gallery with freeze status
                        return db.collection('galleries').doc(galleryId).update({
                            clientInteractionStarted: true,
                            clientInteractionStartedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            freezeStatus: "frozen",
                            interactingClientId: userId
                        });
                    })
                    .then(() => {
                        console.log("Gallery frozen after first rating");
                        
                        // Show a freeze notification to the client
                        const toast = document.createElement('div');
                        toast.className = 'toast toast-info freeze-notification';
                        toast.innerHTML = `
                            <div class="freeze-icon"><i class="fas fa-snowflake"></i></div>
                            <div class="freeze-message">
                                <strong>Gallery Protected</strong>
                                <p>Your selections are now being protected. The photographer cannot modify this gallery while you are making selections.</p>
                            </div>
                        `;
                        
                        const toastContainer = document.getElementById('toastContainer');
                        if (toastContainer) {
                            toastContainer.appendChild(toast);
                            
                            // Keep freeze notification visible longer (8 seconds)
                            setTimeout(() => {
                                toast.classList.add('fadeOut');
                                setTimeout(() => {
                                    toast.remove();
                                }, 500);
                            }, 8000);
                        }
                    })
                    .catch(error => {
                        console.error("Error freezing gallery:", error);
                    });
            } catch (error) {
                console.error("Error in freezeGalleryOnFirstInteraction:", error);
            }
        }


        // New function to refresh the photo grid
        function refreshPhotoGrid() {
            const photosGrid = document.getElementById('photosGrid');
            if (!photosGrid || !allGalleryPhotos || allGalleryPhotos.length === 0) return;
            
            // Clear the grid
            photosGrid.innerHTML = '';
            
            // Re-create all photo elements
            allGalleryPhotos.forEach(photo => {
                const photoElement = createPhotoElement(photo);
                photosGrid.appendChild(photoElement);
            });
        }
           // Modified scheduleSyncToFirebase to just set the flag without scheduling
               
        

        // ROTATION SYSTEM FUNCTIONS
        function initializeRotationSystem() {
            console.log("Rotation system ready");
        }
        
        function savePhotoRotation(photoId, angle) {
            const galleryId = getGalleryId();
            if (!galleryId) return;
            
            const storageKey = `photo_rotations_${galleryId}`;
            let rotations = JSON.parse(localStorage.getItem(storageKey) || '{}');
            
            if (angle === 0) {
                delete rotations[photoId];
            } else {
                rotations[photoId] = angle;
            }
            
            localStorage.setItem(storageKey, JSON.stringify(rotations));
        }
        
        function loadPhotoRotation(photoId) {
            const galleryId = getGalleryId();
            if (!galleryId) return 0;
            
            const storageKey = `photo_rotations_${galleryId}`;
            const rotations = JSON.parse(localStorage.getItem(storageKey) || '{}');
            return rotations[photoId] || 0;
        }
        
        function rotateImage(degrees) {
            currentRotation += degrees;
            if (currentRotation >= 360) currentRotation -= 360;
            if (currentRotation < 0) currentRotation += 360;
            
            const img = document.querySelector('.lightbox-image');
            if (img) {
                const currentZoom = getCurrentZoomLevel();
                img.style.transform = `scale(${currentZoom}) rotate(${currentRotation}deg)`;
            }
            
            document.getElementById('rotationIndicator').textContent = `${currentRotation}¬∞`;
            
            if (currentPhotoId) {
                savePhotoRotation(currentPhotoId, currentRotation);
            }
        }
        
        function resetRotation() {
            currentRotation = 0;
            const img = document.querySelector('.lightbox-image');
            if (img) {
                const currentZoom = getCurrentZoomLevel();
                img.style.transform = `scale(${currentZoom}) rotate(0deg)`;
            }
            document.getElementById('rotationIndicator').textContent = '0¬∞';
            
            if (currentPhotoId) {
                savePhotoRotation(currentPhotoId, 0);
            }
        }
        
        function getCurrentZoomLevel() {
            const img = document.querySelector('.lightbox-image');
            if (img && img.style.transform) {
                const scaleMatch = img.style.transform.match(/scale\(([^)]+)\)/);
                return scaleMatch ? parseFloat(scaleMatch[1]) : 1;
            }
            return 1;
        }
        
        function createRotationControls(photoId) {
            currentPhotoId = photoId;
            currentRotation = loadPhotoRotation(photoId);
            
            const rotationControls = document.createElement('div');
            rotationControls.className = 'rotation-controls';
            
            const rotateLeftBtn = document.createElement('button');
            rotateLeftBtn.className = 'rotate-btn';
            rotateLeftBtn.innerHTML = '<i class="fas fa-undo"></i>';
            rotateLeftBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                rotateImage(-90);
            });
            
            const rotateRightBtn = document.createElement('button');
            rotateRightBtn.className = 'rotate-btn';
            rotateRightBtn.innerHTML = '<i class="fas fa-redo"></i>';
            rotateRightBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                rotateImage(90);
            });
            
            const resetBtn = document.createElement('button');
            resetBtn.className = 'rotate-btn';
            resetBtn.innerHTML = '<i class="fas fa-refresh"></i>';
            resetBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                resetRotation();
            });
            
            const indicator = document.createElement('div');
            indicator.className = 'rotation-indicator';
            indicator.id = 'rotationIndicator';
            indicator.textContent = `${currentRotation}¬∞`;
            
            rotationControls.appendChild(rotateLeftBtn);
            rotationControls.appendChild(rotateRightBtn);
            rotationControls.appendChild(resetBtn);
            rotationControls.appendChild(indicator);
            
            return rotationControls;
        }
        
        function getRatingLabel(rating) {
            switch(rating) {
                case 'heart': return "Must Have";
                case 'thumbsUp': return "Would Like to Have";
                case 'thinking': return "Alternative Option";
                case 'thumbsDown': return "Not Interested";
                default: return "";
            }
        }

        
        
        function createRatingButton(emoji, label, ratingValue, photoId) {
            // Create a container for the button and its label
            const btnContainer = document.createElement('div');
            btnContainer.className = 'rating-btn-container';
            btnContainer.style.display = 'flex';
            btnContainer.style.flexDirection = 'column';
            btnContainer.style.alignItems = 'center';
            btnContainer.style.gap = '3px';
            
            // Create the button itself (same as before)
            const btn = document.createElement('button');
            btn.className = 'rating-btn';
            btn.innerHTML = emoji;
            btn.setAttribute('aria-label', label);
            btn.setAttribute('data-rating', ratingValue);
            
            // Check if this is the currently selected rating
            const isSelected = photoRatings[photoId] === ratingValue;
            if (isSelected) {
                btn.classList.add('selected');
            }
            
            // Create a label element that shows when selected
            const ratingLabel = document.createElement('div');
            ratingLabel.className = 'rating-btn-label';
            ratingLabel.textContent = label;
            ratingLabel.style.fontSize = '10px';
            ratingLabel.style.color = 'white';
            ratingLabel.style.maxWidth = '60px';
            ratingLabel.style.textAlign = 'center';
            ratingLabel.style.overflow = 'hidden';
            ratingLabel.style.textOverflow = 'ellipsis';
            ratingLabel.style.whiteSpace = 'nowrap';
            
            // Only show the label for the currently selected rating
            ratingLabel.style.visibility = isSelected ? 'visible' : 'hidden';
            ratingLabel.style.opacity = isSelected ? '1' : '0';
            ratingLabel.style.height = isSelected ? 'auto' : '0';
            ratingLabel.style.transition = 'all 0.2s ease';
            
            // Add a selection indicator (checkmark)
            const selectionIndicator = document.createElement('div');
            selectionIndicator.className = 'rating-selection-indicator';
            selectionIndicator.innerHTML = '‚úì';
            selectionIndicator.style.fontSize = '12px';
            selectionIndicator.style.color = '#4CAF50';
            selectionIndicator.style.fontWeight = 'bold';
            selectionIndicator.style.position = 'absolute';
            selectionIndicator.style.top = '-8px';
            selectionIndicator.style.right = '-8px';
            selectionIndicator.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
            selectionIndicator.style.borderRadius = '50%';
            selectionIndicator.style.width = '20px';
            selectionIndicator.style.height = '20px';
            selectionIndicator.style.display = 'flex';
            selectionIndicator.style.alignItems = 'center';
            selectionIndicator.style.justifyContent = 'center';
            selectionIndicator.style.opacity = isSelected ? '1' : '0';
            selectionIndicator.style.transition = 'opacity 0.2s ease';
            
            // Add event handler to button
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                
                // Update rating in storage
                setPhotoRating(photoId, ratingValue);
                
                // Update visual selection of all buttons
                const allRatingBtnContainers = document.querySelectorAll('.rating-btn-container');
                allRatingBtnContainers.forEach(container => {
                    const containerButton = container.querySelector('.rating-btn');
                    const containerLabel = container.querySelector('.rating-btn-label');
                    const containerIndicator = container.querySelector('.rating-selection-indicator');
                    
                    const isThisButtonSelected = photoRatings[photoId] === containerButton.getAttribute('data-rating');
                    
                    // Update button selection state
                    if (isThisButtonSelected) {
                        containerButton.classList.add('selected');
                        containerLabel.style.visibility = 'visible';
                        containerLabel.style.opacity = '1';
                        containerLabel.style.height = 'auto';
                        containerIndicator.style.opacity = '1';
                    } else {
                        containerButton.classList.remove('selected');
                        containerLabel.style.visibility = 'hidden';
                        containerLabel.style.opacity = '0';
                        containerLabel.style.height = '0';
                        containerIndicator.style.opacity = '0';
                    }
                });
            });
            
            // Add elements to container
            btnContainer.appendChild(btn);
            btnContainer.appendChild(selectionIndicator);
            btnContainer.appendChild(ratingLabel);
            
            // Position buttons container
            btnContainer.style.position = 'relative';
            
            return btnContainer;
        }

        
        function modifyRatingContainer(ratingContainer, photoId) {
            // Clear existing content
            ratingContainer.innerHTML = '';
            
            // Make the container bigger to accommodate labels
            ratingContainer.style.padding = '15px 25px';
            
            // Add a title to the rating section
            const ratingTitle = document.createElement('div');
           // ratingTitle.textContent = 'Rate this photo:';
            ratingTitle.style.color = 'white';
            ratingTitle.style.marginBottom = '10px';
            ratingTitle.style.width = '100%';
            ratingTitle.style.textAlign = 'center';
            ratingTitle.style.fontSize = '14px';
            ratingContainer.appendChild(ratingTitle);
            
            // Create a flex container for the buttons
            const buttonsContainer = document.createElement('div');
            buttonsContainer.style.display = 'flex';
            buttonsContainer.style.gap = '20px';
            buttonsContainer.style.justifyContent = 'center';
            
            // Create rating buttons with their labels
            const heartBtn = createRatingButton('‚ù§Ô∏è', 'Must Have', 'heart', photoId);
            const thumbsUpBtn = createRatingButton('üëç', 'Would Like', 'thumbsUp', photoId);
            const thinkingBtn = createRatingButton('ü§î', 'Alternative', 'thinking', photoId);
            const thumbsDownBtn = createRatingButton('üëé', 'Not Interested', 'thumbsDown', photoId);
            
            buttonsContainer.appendChild(heartBtn);
            buttonsContainer.appendChild(thumbsUpBtn);
            buttonsContainer.appendChild(thinkingBtn);
            buttonsContainer.appendChild(thumbsDownBtn);
            
            ratingContainer.appendChild(buttonsContainer);
        }
        
        function enhanceRatingUI(ratingContainer, photoId) {
 
            // Check if ratings are disabled
            if (window.ratingsDisabled) {
                console.log('üîí Skipping rating UI creation - ratings disabled');
                
                // Show read-only rating if photo has one
                if (photoRatings[photoId]) {
                    const currentRating = photoRatings[photoId];
                    ratingContainer.innerHTML = `
                        <div style="text-align: center; color: white; padding: 10px;">
                            <div style="font-size: 24px; margin-bottom: 5px;">
                                ${getRatingEmoji(currentRating)}
                            </div>
                            <div style="font-size: 12px;">
                                ${getRatingLabel(currentRating)} (Locked)
                            </div>
                        </div>
                    `;
                } else {
                    ratingContainer.innerHTML = `
                        <div style="text-align: center; color: white; padding: 10px; font-size: 12px;">
                            Rating disabled after submission
                        </div>
                    `;
                }
                return; // Don't create interactive buttons
            }
            
            // Original function continues here for non-locked galleries
            modifyRatingContainer(ratingContainer, photoId);
            
            ratingContainer.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            ratingContainer.style.borderRadius = '20px';
            ratingContainer.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.3)';
        }


        // Function to find studio and share information for a gallery
        function findStudioAndShareInfo(galleryId) {
            // If Firebase is available, look up the information
            if (typeof firebase !== 'undefined' && firebase.apps.length) {
                const db = firebase.firestore();
                
                // Find gallery shares for this gallery
                db.collection('galleryShares')
                    .where('galleryId', '==', galleryId)
                    .limit(1)
                    .get()
                    .then(snapshot => {
                        if (!snapshot.empty) {
                            const shareData = snapshot.docs[0].data();
                            const shareId = shareData.shareId;
                            
                            // Find the photographer
                            return db.collection('photographer')
                                .where('uid', '==', shareData.photographerId)
                                .limit(1)
                                .get()
                                .then(photoSnapshot => {
                                    if (!photoSnapshot.empty) {
                                        const photographerData = photoSnapshot.docs[0].data();
                                        const studioName = photographerData.studioName;
                                        
                                        // Redirect with studio name
                                        window.location.href = `/${studioName}/gallery/${shareId}`;
                                    } else {
                                        // Fallback to basic redirect
                                        window.location.href = `/client-gallery.html?share=${shareId}`;
                                    }
                                });
                        } else {
                            showPageError("Gallery access denied. Please use the shared link provided by the photographer.");
                        }
                    })
                    .catch(error => {
                        console.error("Error finding share info:", error);
                        showPageError("Error accessing gallery. Please try again later.");
                    });
            } else {
                showPageError("Gallery access denied. Firebase not initialized.");
            }
        }

        
// Firebase initialization
        (function() {
            // Firebase configuration
            const firebaseConfig = {
                apiKey: "AIzaSyCAl15Yq8Y727PKknJNs0Q8UZbRRbcWkMo",
                authDomain: "snapselect01-eb74c.firebaseapp.com",
                projectId: "snapselect01-eb74c",
                storageBucket: "snapselect01-eb74c.firebasestorage.app",
                messagingSenderId: "749450852067",
                appId: "1:749450852067:web:8b1887075d607b3e91f7d6",
                measurementId: "G-J5XGE71VF6"
            };
            
            // Initialize Firebase
          
            try {
                if (firebase.apps.length === 0) {
                    firebase.initializeApp(firebaseConfig);
                    console.log("Firebase initialized successfully");
                }
                
                // ADD THIS LINE - Initialize Firebase Functions region
                if (firebase && firebase.functions) {
                    firebase.app().functions("asia-south1");
                }
    
    // ... rest of your existing code
                
                // Update current year in footer
                document.getElementById('currentYear').textContent = new Date().getFullYear();
              
                
                // Make sure ratingSummary is initially hidden if no ratings
                const ratingSummary = document.getElementById('ratingSummary');
                if (ratingSummary) {
                    const totalRatings = Object.values(ratingCounts).reduce((a, b) => a + b, 0);
                    ratingSummary.style.display = totalRatings > 0 ? 'flex' : 'none';
                }
                
                const welcomeDashboard = document.getElementById('welcomeDashboard');
                if (welcomeDashboard) {
                    welcomeDashboard.style.display = 'none';
                }
                
                // Check gallery access and load
                if (checkGalleryAccess()) {
                    loadSharedGallery();
                    // Initialize rating synchronization
                    initRatingSync();
                    initializeRotationSystem(); 
                    initSubmitSnapSelections();
                    initSubmitSnapSelectionsPhase2();
                    checkExistingSubmissionWithFirebase();
                    checkExistingSubmissionWithConfirmation();
                    
                }
                
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showError("Failed to initialize the gallery. Please try again later.");
            }
        })();

        
        // Load shared gallery
        function loadSharedGallery() {
            // Get gallery parameters
            const urlParams = new URLSearchParams(window.location.search);
            
            // Check for direct gallery ID first
            const directGalleryId = urlParams.get('id') || urlParams.get('galleryId');
            if (directGalleryId) {
                console.log("Direct gallery access with ID:", directGalleryId);
                loadGalleryDirect(directGalleryId);
                return;
            }
            
            // Otherwise, look for share ID
            const shareId = urlParams.get('share');
            
            if (!shareId) {
                showPageError("Invalid gallery link. No parameters provided.");
                return;
            }
            
            console.log("Looking for shared gallery with ID:", shareId);
            
            // Set a timeout for loading
            const loadingTimeout = setTimeout(() => {
                if (document.getElementById('loadingIndicator').style.display !== 'none') {
                    showPageError("Gallery is taking too long to load. Please try again later.");
                }
            }, 15000); // 15 seconds timeout
            
            // Get reference to Firestore
            const db = firebase.firestore();
            
            // Check first collection
            db.collection('galleryShares')
                .where('shareId', '==', shareId)
                .get()
                .then(snapshot => {
                    console.log("Query completed for galleryShares, found:", snapshot.size, "documents");
                    
                    if (snapshot.empty) {
                        console.log("No shares found in galleryShares, checking sharedGalleries...");
                        
                        // Try the alternative collection name
                        return db.collection('sharedGalleries')
                            .where('shareId', '==', shareId)
                            .get();
                    }
                    
                    // Clear the timeout since we found data
                    clearTimeout(loadingTimeout);
                    return snapshot;
                })
                .then(snapshot => {
                    if (snapshot.empty) {
                        showPageError("Gallery not found or access has been revoked.");
                        return;
                    }
                    
                    const sharedGallery = snapshot.docs[0].data();
                    console.log("Found shared gallery:", sharedGallery);
                    
                    // Store the actual gallery ID in session storage
                    sessionStorage.setItem('actual_gallery_id', sharedGallery.galleryId);
                    
                    // Hide loading indicator
                    document.getElementById('loadingIndicator').style.display = 'none';
                    
                    if (sharedGallery.passwordProtected) {
                        // Check if we already have access
                        const accessGranted = sessionStorage.getItem(`gallery_access_${shareId}`);
                        if (accessGranted) {
                            // Already authenticated, load gallery
                            loadGalleryContent(sharedGallery.galleryId, sharedGallery.photographerId);
                            return;
                        }
                        
                        // Show password screen
                        document.getElementById('passwordScreen').style.display = 'block';
                        
                        // Update password screen title if we have gallery info
                        updatePasswordScreenTitle(sharedGallery.galleryId);
                        
                        // Focus the password input for accessibility
                        document.getElementById('galleryPassword').focus();
                        
                        // Set up password form submission
                        setupPasswordHandling(sharedGallery, shareId);
                    } else {
                     
                        // No password needed, load gallery directly
                        // First, store access in session storage
                        sessionStorage.setItem(`gallery_access_${shareId}`, 'granted');
                        
                        // Generate consistent user ID from gallery ID only (for non-password galleries)
                        const consistentUserId = 'user_' + btoa('gallery_' + sharedGallery.galleryId).replace(/[^a-zA-Z0-9]/g, '').substring(0, 15);
                        sessionStorage.setItem(`user_id_${shareId}`, consistentUserId);
                        
                        // Load gallery content
                        loadGalleryContent(sharedGallery.galleryId, sharedGallery.photographerId);
                    }
                })
                .catch(error => {
                    clearTimeout(loadingTimeout);
                    console.error("Error fetching shared gallery:", error);
                    showPageError("Error loading gallery: " + error.message);
                });
        }



        
        // Setup password handling
        function setupPasswordHandling(sharedGallery, shareId) {
            // Function to handle password submission
            const handlePasswordSubmit = function(e) {
                // Prevent default form submission if an event was passed
                if (e) e.preventDefault();
                
                const password = document.getElementById('galleryPassword').value;
                const passwordError = document.getElementById('passwordError');
                
                // Hide previous errors
                passwordError.style.display = 'none';
                
                if (!password) {
                    passwordError.textContent = 'Please enter a password.';
                    passwordError.style.display = 'block';
                    return;
                }
                
                if (password === sharedGallery.password) {
         
                    // Password correct, store access token in session storage
                    sessionStorage.setItem(`gallery_access_${shareId}`, 'granted');
                    
                    // Generate consistent user ID from password + gallery combination
                    const consistentUserId = 'user_' + btoa(password + '_' + sharedGallery.galleryId).replace(/[^a-zA-Z0-9]/g, '').substring(0, 15);
                    sessionStorage.setItem(`user_id_${shareId}`, consistentUserId);
                    
                    // Load the gallery
                    loadGalleryContent(sharedGallery.galleryId, sharedGallery.photographerId);

                } else {
                    // Show error
                    passwordError.textContent = 'Incorrect password. Please try again.';
                    passwordError.style.display = 'block';
                    
                    // Clear the password field
                    document.getElementById('galleryPassword').value = '';
                    document.getElementById('galleryPassword').focus();
                }
            };
            
            // Set up button click handler
            document.getElementById('submitPasswordBtn').addEventListener('click', handlePasswordSubmit);
            
            // Set up form submit handler - this will handle Enter key submission too
            document.getElementById('passwordForm').addEventListener('submit', handlePasswordSubmit);
        }



            
        function loadGalleryContent(galleryId, photographerId) {
            console.log("Loading gallery content for ID:", galleryId);
            
            // Hide password screen if visible
            document.getElementById('passwordScreen').style.display = 'none';
            
            // Show gallery container
            document.getElementById('galleryContainer').style.display = 'block';
            
            // Get reference to Firestore
            const db = firebase.firestore();
            
            // Get gallery details with additional security check
            db.collection('galleries').doc(galleryId)
                .get()
                .then(doc => {
                    if (!doc.exists) {
                        showPageError("Gallery not found.");
                        return;
                    }
                    
                    const gallery = doc.data();
                    console.log("Gallery details:", gallery);
                    
                    // Security check: Verify the gallery belongs to the correct photographer
                    if (photographerId && gallery.photographerId !== photographerId) {
                        showPageError("Gallery access error: Photographer mismatch.");
                        return;
                    }
                    
                    // Set gallery title
                    document.getElementById('galleryTitle').textContent = gallery.name || 'Shared Gallery';
                    
                    // Get photographer details
                    loadPhotographerDetails(gallery.photographerId);
                    
                    // Load photos with added security
                    loadGalleryPhotos(galleryId, db);
                })
                .catch(error => {
                    console.error("Error loading gallery details:", error);
                    showPageError("Error loading gallery details: " + error.message);
                });
        }

        // Load photographer details
        function loadPhotographerDetails(photographerId) {
            if (!photographerId) {
                console.log("No photographer ID provided");
                return;
            }
            
            const db = firebase.firestore();
            
            // Try to find the photographer in the collection
            db.collection('photographer')
                .where('uid', '==', photographerId)
                .limit(1)
                .get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        console.log("No photographer found with ID:", photographerId);
                        return;
                    }
                    
                    const photographerData = snapshot.docs[0].data();
                    console.log("Photographer details:", photographerData);
                    
                    // Update studio information
                    const studioNameElement = document.getElementById('studioName');
                    if (studioNameElement) {
                        studioNameElement.textContent = photographerData.studioName || photographerData.ownerName || 'Photography Studio';
                    }
                    
                    // Update contact information
                    const studioContactElement = document.getElementById('studioContact');
                    if (studioContactElement) {
                        let contactText = "";
                        
                        if (photographerData.ownerName) {
                            contactText += `${photographerData.ownerName}`;
                        }
                        
                        if (photographerData.ownerEmail) {
                            contactText += ` | Email: ${photographerData.ownerEmail}`;
                        }
                        
                        if (photographerData.ownerNumber) {
                            contactText += ` | Phone: ${photographerData.ownerNumber}`;
                        }
                        
                        if (photographerData.studioAddress) {
                            contactText += ` | Address: ${photographerData.studioAddress}`;
                            
                            if (photographerData.studioPincode) {
                                contactText += `, ${photographerData.studioPincode}`;
                            }
                        }
                        
                        studioContactElement.textContent = contactText || 'No contact information available';
                    }
                })
                .catch(error => {
                    console.error("Error loading photographer details:", error);
                });
        }
        function updatePasswordScreenTitle(galleryId) {
            try {
                const db = firebase.firestore();
                
                db.collection('galleries').doc(galleryId)
                    .get()
                    .then(doc => {
                        if (doc.exists) {
                            const gallery = doc.data();
                            const titleElement = document.getElementById('passwordGalleryTitle');
                            if (titleElement && gallery.name) {
                                titleElement.textContent = gallery.name;
                            }
                        }
                    })
                    .catch(error => {
                        console.error("Error fetching gallery for password screen:", error);
                    });
            } catch (error) {
                console.error("Error updating password screen title:", error);
            }
        }
// Load gallery photos

        function loadGalleryPhotos(galleryId, db) {
            // Show loading toast
            showToast("Loading photos...", 'info');
            
            // Create a photo counter element
            const counterElement = document.createElement('div');
            counterElement.id = 'photo-counter';
            counterElement.className = 'photo-count-display';
            counterElement.style.backgroundColor = 'white';
            counterElement.style.padding = '10px 15px';
            counterElement.style.marginBottom = '20px';
            counterElement.style.borderRadius = '8px';
            counterElement.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
            counterElement.style.textAlign = 'center';
            counterElement.innerHTML = '<strong>Loading photos...</strong>';
            
            const photosGrid = document.getElementById('photosGrid');
            photosGrid.innerHTML = '';
            
            // Add the counter at the top of the gallery (before the photos grid)
            photosGrid.parentNode.insertBefore(counterElement, photosGrid);
            
            // Remove the .limit(50) to fetch ALL photos
            db.collection('photos')
                .where('galleryId', '==', galleryId)
                .where('status', '==', 'active')
                // No limit here - will fetch all photos in the gallery
                .get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        counterElement.innerHTML = '<p>No photos in this gallery yet.</p>';
                        return;
                    }
                    
                    // Store all photos in the global array
                    allGalleryPhotos = snapshot.docs.map(doc => doc.data());
                    const totalCount = allGalleryPhotos.length;
                    
                    // Update the counter with total photo count
                    counterElement.innerHTML = `<strong>Total Photos: ${totalCount}</strong>`;
                    
                    // If there are many photos, use batched rendering for better performance
                    if (totalCount > 100) {
                        // Show first batch immediately, then render the rest
                        showToast(`Loading ${totalCount} photos in batches...`, 'info');
                        renderPhotosBatch(allGalleryPhotos, photosGrid, 0, 50);
                    } else {
                        // For smaller galleries, render all at once
                        allGalleryPhotos.forEach(photo => {
                            const photoElement = createPhotoElement(photo);
                            photosGrid.appendChild(photoElement);
                        });
                        
                        // Show success toast
                        showToast(`Gallery loaded with ${totalCount} photos`, 'success');
                    }
                    
                    // Initialize rating sync and load total ratings
                    initRatingSync();
                    
                    // Set up real-time updates for gallery counts
                
                })
                .catch(error => {
                    console.error("Error loading photos:", error);
                    showError("Error loading photos: " + error.message);
                });
        }

        // FUNCTION 2: Add this new function for batch rendering (for large galleries)
        function renderPhotosBatch(photos, container, startIndex, batchSize) {
            // Create a fragment for better performance
            const fragment = document.createDocumentFragment();
            
            // Calculate end index (not exceeding array length)
            const endIndex = Math.min(startIndex + batchSize, photos.length);
            
            // Create elements for this batch
            for (let i = startIndex; i < endIndex; i++) {
                const photoElement = createPhotoElement(photos[i]);
                fragment.appendChild(photoElement);
            }
            
            // Add all elements at once
            container.appendChild(fragment);
            
            // If there are more photos to render, schedule the next batch
            if (endIndex < photos.length) {
                // Use setTimeout to avoid freezing the browser
                setTimeout(() => {
                    // Show progress
                    showToast(`Loading photos: ${endIndex} of ${photos.length}`, 'info');
                    // Process next batch
                    renderPhotosBatch(photos, container, endIndex, batchSize);
                }, 50); // Small delay to keep UI responsive
            } else {
                // All photos loaded
                showToast(`All ${photos.length} photos loaded successfully`, 'success');
            }
        }
        
        // FUNCTION 3: Optional enhancement for showToast to better handle progress messages
        function showToast(message, type = 'info', isProgress = false) {
            const toastContainer = document.getElementById('toastContainer');
            
            // For progress messages, update existing one if present
            if (isProgress) {
                const existingProgress = document.querySelector('.toast-progress');
                if (existingProgress) {
                    existingProgress.textContent = message;
                    return;
                }
            }
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            if (isProgress) {
                toast.className += ' toast-progress';
            }
            toast.textContent = message;
            
            // Add aria-live for accessibility
            toast.setAttribute('aria-live', type === 'error' ? 'assertive' : 'polite');
            
            toastContainer.appendChild(toast);
            
            // Remove non-progress toasts after 4 seconds
            if (!isProgress) {
                setTimeout(() => {
                    toast.classList.add('fadeOut');
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.remove();
                        }
                    }, 300);
                }, 4000);
            }
        }

        
            
        // Function to stop slideshow
        function stopSlideshow() {
            if (slideshowInterval) {
                clearInterval(slideshowInterval);
                slideshowInterval = null;
            }
        }
                // New function to update rating indicator
        function updatePhotoRatingIndicator(photoId, lightbox) {
            // Remove existing indicator if present
            const existingIndicator = lightbox.querySelector('.photo-rating-indicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }
            
            // Create new indicator if this photo has a rating
            if (photoRatings[photoId]) {
                const currentRating = photoRatings[photoId];
                
                // Create the indicator element
                const indicator = document.createElement('div');
                indicator.className = 'photo-rating-indicator';
                
                // Position it in the top-right corner of the image container
                indicator.style.position = 'absolute';
                indicator.style.top = '20px';
                indicator.style.right = '20px';
                indicator.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
                indicator.style.color = 'white';
                indicator.style.padding = '8px 12px';
                indicator.style.borderRadius = '5px';
                indicator.style.zIndex = '1002';
                indicator.style.fontSize = '14px';
                indicator.style.display = 'flex';
                indicator.style.alignItems = 'center';
                indicator.style.gap = '5px';
                indicator.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.3)';
                
                // Add a checkmark
                const checkmark = document.createElement('span');
                checkmark.innerHTML = '‚úì';
                checkmark.style.color = '#4CAF50';
                checkmark.style.fontWeight = 'bold';
                
                // Add the emoji for the rating
                const emoji = document.createElement('span');
                emoji.textContent = getRatingEmoji(currentRating);
                
                // Add the label
                const label = document.createElement('span');
                label.textContent = getRatingLabel(currentRating);
                
                // Add elements to indicator
                indicator.appendChild(checkmark);
                indicator.appendChild(emoji);
                indicator.appendChild(label);
                
                // Add to lightbox
                const imageContainer = lightbox.querySelector('.lightbox-image-container');
                imageContainer.appendChild(indicator);
            }
        }

        // New helper function for ratings
        function getRatingEmoji(rating) {
            switch(rating) {
                case 'heart': return '‚ù§Ô∏è';
                case 'thumbsUp': return 'üëç';
                case 'thinking': return 'ü§î';
                case 'thumbsDown': return 'üëé';
                default: return '';
            }
        }
        
    // Modified version of navigateToPhoto to show rating indicator
        function navigateToPhoto(index, lightbox, imageContainer) {
            if (index < 0 || index >= allGalleryPhotos.length) return;
            
            // Update current image with fade effect
            const currentImg = lightbox.querySelector('.lightbox-image');
            currentImg.classList.remove('fadeIn');
            currentImg.classList.add('fadeOut');
            
            // Reset zoom level
            currentImg.style.transform = 'scale(1)';
            lightbox.querySelector('.zoom-level-text').textContent = '100%';
            
            setTimeout(() => {
                // Update image source
                const newPhoto = allGalleryPhotos[index];
                currentImg.src = newPhoto.url;
                currentImg.dataset.index = index;
                currentImg.alt = newPhoto.name || 'Gallery photo';
                
                // The photo ID for ratings
                const photoId = newPhoto.id || newPhoto.url;
                // ADD THESE 10 LINES RIGHT HERE:
                currentPhotoId = photoId;
                currentRotation = loadPhotoRotation(photoId);
                setTimeout(() => {
                    const img = document.querySelector('.lightbox-image');
                    if (img) {
                        const currentZoom = getCurrentZoomLevel();
                        img.style.transform = `scale(${currentZoom}) rotate(${currentRotation}deg)`;
                    }
                    const indicator = document.getElementById('rotationIndicator');
                    if (indicator) indicator.textContent = `${currentRotation}¬∞`;
                }, 50);
                
                // Update caption if exists
                const caption = imageContainer.querySelector('.photo-caption');
                if (caption) {
                    caption.textContent = newPhoto.name || '';
                }
                
                // Update active thumbnail
                const thumbnailsContainer = lightbox.querySelector('.thumbnails-container');
                const thumbnails = thumbnailsContainer.querySelectorAll('.thumbnail');
                thumbnails.forEach((thumb, i) => {
                    if (i === index) {
                        thumb.classList.add('active');
                        thumb.scrollIntoView({ behavior: 'smooth', inline: 'center' });
                    } else {
                        thumb.classList.remove('active');
                    }
                });
                
                // Update navigation buttons
                const prevButton = lightbox.querySelector('.modal-prev');
                const nextButton = lightbox.querySelector('.modal-next');
                
                if (prevButton) {
                    prevButton.remove();
                }
                
                if (nextButton) {
                    nextButton.remove();
                }
                
                // Add prev button if not first photo
                if (index > 0) {
                    const newPrevButton = document.createElement('button');
                    newPrevButton.className = 'modal-nav-button modal-prev';
                    newPrevButton.innerHTML = '<i class="fas fa-chevron-left"></i>';
                    newPrevButton.setAttribute('aria-label', 'Previous photo');
                    newPrevButton.addEventListener('click', function(e) {
                        e.stopPropagation();
                        navigateToPhoto(index - 1, lightbox, imageContainer);
                    });
                    imageContainer.appendChild(newPrevButton);
                }
                
                // Add next button if not last photo
                if (index < allGalleryPhotos.length - 1) {
                    const newNextButton = document.createElement('button');
                    newNextButton.className = 'modal-nav-button modal-next';
                    newNextButton.innerHTML = '<i class="fas fa-chevron-right"></i>';
                    newNextButton.setAttribute('aria-label', 'Next photo');
                    newNextButton.addEventListener('click', function(e) {
                        e.stopPropagation();
                        navigateToPhoto(index + 1, lightbox, imageContainer);
                    });
                    imageContainer.appendChild(newNextButton);
                }
                
                // Update rating buttons
                const ratingButtons = lightbox.querySelectorAll('.rating-btn');
                ratingButtons.forEach(btn => {
                    btn.classList.remove('selected');
                    if (photoRatings[photoId] === btn.getAttribute('data-rating')) {
                        btn.classList.add('selected');
                    }
                });
                
                // NEW: Update the rating indicator above the image
                updatePhotoRatingIndicator(photoId, lightbox);
                
                // Update the rating UI
                const ratingContainer = lightbox.querySelector('.rating-container');
                if (ratingContainer) {
                    enhanceRatingUI(ratingContainer, photoId);
                }
                // Fade in the new image
                currentImg.classList.remove('fadeOut');
                currentImg.classList.add('fadeIn');
            }, 300);
        }
        
        // Close the lightbox
        function closeLightbox() {
    
            // Stop any running slideshow
            stopSlideshow();
            
        
            
            const lightbox = document.getElementById('photoLightbox');
            if (lightbox) {
                lightbox.classList.add('fadeOut');
                setTimeout(() => {
                    document.body.removeChild(lightbox);
                }, 300);
            }
        }
        
        // Toggle slideshow
        function toggleSlideshow(slideshowButton, lightbox) {
            const slideshowIcon = slideshowButton.querySelector('i');
            
            if (slideshowInterval) {
                // Stop slideshow
                stopSlideshow();
                slideshowIcon.className = 'fas fa-play';
                slideshowButton.setAttribute('aria-label', 'Start slideshow');
            } else {
                // Start slideshow
                slideshowIcon.className = 'fas fa-pause';
                slideshowButton.setAttribute('aria-label', 'Pause slideshow');
                
                slideshowInterval = setInterval(() => {
                    const currentImg = lightbox.querySelector('.lightbox-image');
                    const currentIndex = parseInt(currentImg.dataset.index);
                    const imageContainer = lightbox.querySelector('.lightbox-image-container');
                    
                    if (currentIndex < allGalleryPhotos.length - 1) {
                        navigateToPhoto(currentIndex + 1, lightbox, imageContainer);
                    } else {
                        navigateToPhoto(0, lightbox, imageContainer); // Loop back to first image
                    }
                }, 3000); // Change image every 3 seconds
            }
        }

                // Open lightbox with enhanced features
    
        
        // Modified version of openLightbox to add rating indicator at top
        function openLightbox(photo) {
            // Stop any running slideshow
            stopSlideshow();
            
            // Find current photo index
            const currentIndex = allGalleryPhotos.findIndex(p => 
                p.url === photo.url || (p.id && p.id === photo.id)
            );
            
            // The photo ID for ratings
            const photoId = photo.id || photo.url;
            
            // Create lightbox container
            const lightbox = document.createElement('div');
            lightbox.className = 'photo-lightbox';
            lightbox.id = 'photoLightbox';
            lightbox.tabIndex = 0; // Make it focusable
            
            // Add rating status indicator to the top-left corner
            const ratingStatus = document.createElement('div');
            ratingStatus.className = 'rating-status';
            ratingStatus.id = 'lightboxRatingStatus';
            ratingStatus.style.position = 'fixed';
            ratingStatus.style.top = '20px';
            ratingStatus.style.left = '20px';
            ratingStatus.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
            ratingStatus.style.color = 'white';
            ratingStatus.style.padding = '10px 15px';
            ratingStatus.style.borderRadius = '5px';
            ratingStatus.style.zIndex = '1002';
            ratingStatus.style.fontSize = '14px';
            ratingStatus.style.display = 'flex';
            ratingStatus.style.alignItems = 'center';
            ratingStatus.style.gap = '10px';
            
            // Create counters for each rating type
            const ratingTypes = [
                { name: 'heart', emoji: '‚ù§Ô∏è', label: 'Must Have' },
                { name: 'thumbsUp', emoji: 'üëç', label: 'Would Like to Have' },
                { name: 'thinking', emoji: 'ü§î', label: 'Alternative Option' },
                { name: 'thumbsDown', emoji: 'üëé', label: 'Not Interested' }
            ];
            
            // Add title to the rating status
            const statusTitle = document.createElement('span');
            statusTitle.textContent = 'Your Ratings:';
            statusTitle.style.fontWeight = 'bold';
            statusTitle.style.marginRight = '5px';
            ratingStatus.appendChild(statusTitle);
            
            // Count existing ratings
            const sessionRatings = {
                heart: 0,
                thumbsUp: 0,
                thinking: 0,
                thumbsDown: 0
            };
            
            // Count existing ratings
            for (const photoId in photoRatings) {
                const rating = photoRatings[photoId];
                if (sessionRatings[rating] !== undefined) {
                    sessionRatings[rating]++;
                }
            }
            
            // Create and add counters
            ratingTypes.forEach(type => {
                const counter = document.createElement('div');
                counter.className = 'lightbox-rating-counter';
                counter.style.display = 'flex';
                counter.style.alignItems = 'center';
                counter.style.gap = '5px';
                
                const emoji = document.createElement('span');
                emoji.textContent = type.emoji;
                
                const count = document.createElement('span');
                count.id = `lightbox-${type.name}-count`;
                count.textContent = sessionRatings[type.name];
                
                counter.appendChild(emoji);
                counter.appendChild(count);
                ratingStatus.appendChild(counter);
            });
            
            // Add to lightbox
            lightbox.appendChild(ratingStatus);
            // Add to lightbox
            lightbox.appendChild(ratingStatus);
            makeDraggable(ratingStatus);  // ADD THIS LINE
            
            // Add a toolbar for controls (EXISTING CODE)
            const toolbar = document.createElement('div');
            toolbar.className = 'lightbox-toolbar';
            
            // Slideshow button (EXISTING CODE)
            const slideshowButton = document.createElement('button');
            slideshowButton.className = 'modal-button';
            slideshowButton.innerHTML = '<i class="fas fa-play"></i>';
            slideshowButton.setAttribute('aria-label', 'Start slideshow');
            slideshowButton.addEventListener('click', function(e) {
                e.stopPropagation();
                toggleSlideshow(slideshowButton, lightbox);
            });
            toolbar.appendChild(slideshowButton);
        
            // Download button (EXISTING CODE)
            const downloadButton = document.createElement('button');
            downloadButton.className = 'modal-button';
            downloadButton.innerHTML = '<i class="fas fa-download"></i>';
            downloadButton.setAttribute('aria-label', 'Download photo');
            downloadButton.addEventListener('click', function(e) {
                e.stopPropagation();
                
                // Create a download link
                const link = document.createElement('a');
                link.href = photo.url;
                link.download = photo.name || 'photo.jpg';
                link.target = '_blank';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
            toolbar.appendChild(downloadButton);
            
            // Close button (EXISTING CODE)
            const closeButton = document.createElement('button');
            closeButton.className = 'modal-button';
            closeButton.innerHTML = '<i class="fas fa-times"></i>';
            closeButton.setAttribute('aria-label', 'Close');
            closeButton.addEventListener('click', function(e) {
                e.stopPropagation();
                closeLightbox();
            });
            toolbar.appendChild(closeButton);
            // ADD THIS SINGLE LINE HERE:
            //addSubmitButtonToLightbox(toolbar);
            
            lightbox.appendChild(toolbar);
            
            // Create image container (EXISTING CODE)
            const imageContainer = document.createElement('div');
            imageContainer.className = 'lightbox-image-container';
            
            // Current zoom level (EXISTING CODE)
            let zoomLevel = 1;
            
            // Create zoom controls (EXISTING CODE)
            const zoomControls = document.createElement('div');
            zoomControls.className = 'zoom-controls';
            
            const zoomInBtn = document.createElement('button');
            zoomInBtn.className = 'zoom-btn';
            zoomInBtn.innerHTML = '<i class="fas fa-search-plus"></i>';
            zoomInBtn.setAttribute('aria-label', 'Zoom in');
            
            const zoomOutBtn = document.createElement('button');
            zoomOutBtn.className = 'zoom-btn';
            zoomOutBtn.innerHTML = '<i class="fas fa-search-minus"></i>';
            zoomOutBtn.setAttribute('aria-label', 'Zoom out');
            
            const zoomLevelDisplay = document.createElement('div');
            zoomLevelDisplay.style.color = 'white';
            zoomLevelDisplay.style.textAlign = 'center';
            zoomLevelDisplay.style.marginTop = '5px';
            zoomLevelDisplay.className = 'zoom-level-text';
            zoomLevelDisplay.textContent = '100%';
            
            // Add zoom handlers (EXISTING CODE)
            zoomInBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                if (zoomLevel < 3) { // Max zoom 3x
                    zoomLevel += 0.25;
                    const img = lightbox.querySelector('.lightbox-image');
                    //img.style.transform = `scale(${zoomLevel})`;
                    //img.style.transform = `scale(${zoomLevel}) translate(${currentX}px, ${currentY}px)`;
                    img.style.transform = `scale(${zoomLevel}) translate(${currentX}px, ${currentY}px) rotate(${currentRotation}deg)`;
                    zoomLevelDisplay.textContent = `${Math.round(zoomLevel * 100)}%`;
                }
            });
            
            zoomOutBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                if (zoomLevel > 0.5) { // Min zoom 0.5x
                    zoomLevel -= 0.25;
                    const img = lightbox.querySelector('.lightbox-image');
                    //img.style.transform = `scale(${zoomLevel})`;
                    //img.style.transform = `scale(${zoomLevel}) translate(${currentX}px, ${currentY}px)`;
                    img.style.transform = `scale(${zoomLevel}) translate(${currentX}px, ${currentY}px) rotate(${currentRotation}deg)`;
                    zoomLevelDisplay.textContent = `${Math.round(zoomLevel * 100)}%`;
                }
            });
            
            zoomControls.appendChild(zoomInBtn);
            zoomControls.appendChild(zoomOutBtn);
            zoomControls.appendChild(zoomLevelDisplay);
            
            // Create the main image with protection (EXISTING CODE)
            const img = document.createElement('img');
            img.className = 'lightbox-image fadeIn';
            img.src = photo.url;

            // ADD THESE LINES HERE - Mouse Zoom Controls
            let isDragging = false;
            let startX = 0, startY = 0, currentX = 0, currentY = 0;
            
            // Mouse wheel zoom
            imageContainer.addEventListener('wheel', function(e) {
                e.preventDefault();
                const rect = img.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                
                if (e.deltaY < 0) {
                    // Zoom in
                    if (zoomLevel < 3) zoomLevel += 0.25;
                } else {
                    // Zoom out
                    if (zoomLevel > 0.5) zoomLevel -= 0.25;
                }
                
                //img.style.transform = `scale(${zoomLevel}) translate(${currentX}px, ${currentY}px)`;
                img.style.transform = `scale(${zoomLevel}) translate(${currentX}px, ${currentY}px) rotate(${currentRotation}deg)`;
                zoomLevelDisplay.textContent = `${Math.round(zoomLevel * 100)}%`;
            });
            
            // Click and drag pan
            img.addEventListener('mousedown', function(e) {
                isDragging = true;
                startX = e.clientX - currentX;
                startY = e.clientY - currentY;
                imageContainer.style.cursor = 'grabbing';
            });

            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
            
            // ADD these two functions instead:
            function handleMouseMove(e) {
                if (!isDragging) return;
                currentX = e.clientX - startX;
                currentY = e.clientY - startY;
                img.style.transform = `scale(${zoomLevel}) translate(${currentX}px, ${currentY}px) rotate(${currentRotation}deg)`;
            }
            
            function handleMouseUp() {
                if (isDragging) {
                    isDragging = false;
                    imageContainer.style.cursor = 'grab';
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleMouseUp);
                }
            }
            
            img.addEventListener('mouseup', function() {
                isDragging = false;
                imageContainer.style.cursor = 'grab';
            });

            
            img.dataset.index = currentIndex;
            img.alt = photo.name || 'Gallery photo';
            img.draggable = false;
            img.crossOrigin = "anonymous";


            
            // Add watermark overlay (EXISTING CODE)
            const watermarkOverlay = document.createElement('div');
            watermarkOverlay.className = 'image-watermark';
            imageContainer.appendChild(watermarkOverlay);
            
            // Add watermark text (EXISTING CODE)
            const watermarkText = document.createElement('div');
            watermarkText.className = 'watermark-text';
            watermarkText.textContent = 'SnapSelect ¬© 2025';
            imageContainer.appendChild(watermarkText);
            
            // Add protection layer (EXISTING CODE)
            const protectionLayer = document.createElement('div');
            protectionLayer.className = 'protection-layer';
            protectionLayer.addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent closing when clicking on protection layer
            });
            imageContainer.appendChild(protectionLayer);
            
            // Add navigation buttons (EXISTING CODE)
            if (currentIndex > 0) {
                const prevButton = document.createElement('button');
                prevButton.className = 'modal-nav-button modal-prev';
                prevButton.innerHTML = '<i class="fas fa-chevron-left"></i>';
                prevButton.setAttribute('aria-label', 'Previous photo');
                prevButton.addEventListener('click', function(e) {
                    e.stopPropagation();
                    navigateToPhoto(currentIndex - 1, lightbox, imageContainer);
                });
                imageContainer.appendChild(prevButton);
            }
            
            if (currentIndex < allGalleryPhotos.length - 1) {
                const nextButton = document.createElement('button');
                nextButton.className = 'modal-nav-button modal-next';
                nextButton.innerHTML = '<i class="fas fa-chevron-right"></i>';
                nextButton.setAttribute('aria-label', 'Next photo');
                nextButton.addEventListener('click', function(e) {
                    e.stopPropagation();
                    navigateToPhoto(currentIndex + 1, lightbox, imageContainer);
                });
                imageContainer.appendChild(nextButton);
            }
            
            // Add caption if available (EXISTING CODE)
            if (photo.name) {
                const caption = document.createElement('div');
                caption.className = 'photo-caption';
                caption.style.position = 'absolute';
                caption.style.bottom = '160px'; // Above ratings and thumbnails
                caption.style.left = '0';
                caption.style.width = '100%';
                caption.style.textAlign = 'center';
                caption.style.color = 'white';
                caption.style.padding = '10px';
                caption.style.backgroundColor = 'rgba(0,0,0,0.5)';
                caption.textContent = photo.name;
                caption.style.overflow = 'hidden';
                caption.style.textOverflow = 'ellipsis';
                caption.style.whiteSpace = 'normal';
                caption.style.maxWidth = '100%';
                imageContainer.appendChild(caption);
            }
            
          // Replace with this new code:
            // Add rating container (MODIFIED)
            const ratingContainer = document.createElement('div');
            ratingContainer.className = 'rating-container';
            
            // Use our enhanced UI - this one function does all the work
            enhanceRatingUI(ratingContainer, photoId);
            
            imageContainer.appendChild(img);
            imageContainer.appendChild(ratingContainer);
            imageContainer.appendChild(zoomControls);
            const rotationControls = createRotationControls(photoId);
            imageContainer.appendChild(rotationControls);
            lightbox.appendChild(imageContainer);
            
            // Add thumbnails container (EXISTING CODE)
            const thumbnailsContainer = document.createElement('div');
            thumbnailsContainer.className = 'thumbnails-container';
            
            // Add thumbnails for all photos (EXISTING CODE)
            allGalleryPhotos.forEach((p, index) => {
                const thumb = document.createElement('img');
                thumb.className = 'thumbnail';
                thumb.src = p.thumbnailUrl || p.url;
                thumb.draggable = false;
                if (index === currentIndex) {
                    thumb.classList.add('active');
                }
                thumb.addEventListener('click', function(e) {
                    e.stopPropagation();
                    navigateToPhoto(index, lightbox, imageContainer);
                });
                thumbnailsContainer.appendChild(thumb);
            });
            
            lightbox.appendChild(thumbnailsContainer);
            
            // Add touch swipe functionality for mobile (EXISTING CODE)
            let touchStartX = 0;
            let touchEndX = 0;
            
            lightbox.addEventListener('touchstart', function(e) {
                touchStartX = e.changedTouches[0].screenX;
            });
            
            lightbox.addEventListener('touchend', function(e) {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            });
            
            
            function handleSwipe() {
           
                const swipeThreshold = 50;
                if (touchEndX < touchStartX - swipeThreshold && currentIndex < allGalleryPhotos.length - 1) {
                    // Swipe left - next photo
                    navigateToPhoto(currentIndex + 1, lightbox, imageContainer);
                } else if (touchEndX > touchStartX + swipeThreshold && currentIndex > 0) {
                    // Swipe right - previous photo
                    navigateToPhoto(currentIndex - 1, lightbox, imageContainer);
                }
            }
            
            // Handle keyboard navigation (EXISTING CODE)
            lightbox.addEventListener('keydown', function(e) {
                switch (e.key) {
                    case 'Escape':
                        closeLightbox();
                        break;
                    case 'ArrowLeft':
                        if (currentIndex > 0) {
                            navigateToPhoto(currentIndex - 1, lightbox, imageContainer);
                        }
                        break;
                    case 'ArrowRight':
                        if (currentIndex < allGalleryPhotos.length - 1) {
                            navigateToPhoto(currentIndex + 1, lightbox, imageContainer);
                        }
                        break;
                    case ' ': // Space bar
                        toggleSlideshow(slideshowButton, lightbox);
                        break;
                    case '+':
                        // Zoom in
                        if (zoomLevel < 3) {
                            zoomLevel += 0.25;
                            img.style.transform = `scale(${zoomLevel})`;
                            zoomLevelDisplay.textContent = `${Math.round(zoomLevel * 100)}%`;
                        }
                        break;
                    case '-':
                        // Zoom out
                        if (zoomLevel > 0.5) {
                            zoomLevel -= 0.25;
                            img.style.transform = `scale(${zoomLevel})`;
                            zoomLevelDisplay.textContent = `${Math.round(zoomLevel * 100)}%`;
                        }
                        break;
                }
            });
            
            // Close when clicking on the background (but not on controls) (EXISTING CODE)
            lightbox.addEventListener('click', function(e) {
                if (e.target === lightbox) {
                    closeLightbox();
                }
            });
            
            // Add lightbox to page (EXISTING CODE)
            document.body.appendChild(lightbox);
            
            // Focus for keyboard navigation (EXISTING CODE)
            lightbox.focus();
            
            // Scroll the active thumbnail into view (EXISTING CODE)
            const activeThumb = thumbnailsContainer.querySelector('.thumbnail.active');
            if (activeThumb) {
                activeThumb.scrollIntoView({ behavior: 'smooth', inline: 'center' });
            }
        }
        
        // The rest of your original functions go here without changes
        // These functions don't interact with the rating system:
        // - createPhotoElement 
        // - stopSlideshow
        // - navigateToPhoto
        // - closeLightbox
        // - toggleSlideshow
        // - openLightbox 
        // - showPageError
        // - showError
        // - showToast
        
        // The rest of your code below, or replace this comment with the rest of your code...
        
        // Create a photo element

        function createPhotoElement(photo) {
      
            const photoItem = document.createElement('div');
            photoItem.className = 'photo-item';
            
            // Store photo ID as data attribute for easier reference
            const photoId = photo.id || photo.url;
            photoItem.setAttribute('data-photo-id', photoId);
            
            const photoContainer = document.createElement('div');
            photoContainer.className = 'photo-container';
            photoContainer.style.backgroundImage = `url(${photo.thumbnailUrl || photo.url})`;
            photoContainer.setAttribute('tabindex', '0'); // Make focusable for keyboard navigation
            photoContainer.setAttribute('role', 'img');
            photoContainer.setAttribute('aria-label', photo.name || 'Photo');
            
            // Add rating indicator if this photo has been rated
            if (photoRatings[photoId]) {
                const ratingIndicator = document.createElement('div');
                ratingIndicator.className = 'thumbnail-rating-indicator';
                
                // Add a checkmark and emoji based on the rating
                const currentRating = photoRatings[photoId];
                ratingIndicator.innerHTML = `‚úì ${getRatingEmoji(currentRating)}`;
                
                // Add tooltip to show full rating text on hover
                ratingIndicator.title = getRatingLabel(currentRating);
                
                // Add to photo container
                photoContainer.appendChild(ratingIndicator);
                
                // Add a class to highlight rated photos
                photoItem.classList.add('photo-rated');
            }
            
            // Create thumbnail rating overlay
            const ratingOverlay = document.createElement('div');
            ratingOverlay.className = 'thumbnail-rating-overlay';
            
            const ratingButtons = document.createElement('div');
            ratingButtons.className = 'thumbnail-rating-buttons';
            
            // Add rating buttons with same options as lightbox
            const ratingOptions = [
                { emoji: '‚ù§Ô∏è', label: 'Must Have', value: 'heart' },
                { emoji: 'üëç', label: 'Would Like', value: 'thumbsUp' },
                { emoji: 'ü§î', label: 'Alternative', value: 'thinking' },
                { emoji: 'üëé', label: 'Not Interested', value: 'thumbsDown' }
            ];
            
            ratingOptions.forEach(option => {
                const button = document.createElement('button');
                button.className = 'thumbnail-rating-btn';
                button.innerHTML = option.emoji;
                button.title = option.label;
                button.setAttribute('data-rating', option.value);
                
                // Mark as selected if this is the current rating
                if (photoRatings[photoId] === option.value) {
                    button.classList.add('selected');
                }
                
                // Add click handler to rate photo directly from thumbnail
                button.addEventListener('click', function(e) {
                    e.stopPropagation(); // Prevent opening lightbox
                    setPhotoRating(photoId, option.value);
                    
                    // Update selection state of buttons
                    ratingButtons.querySelectorAll('.thumbnail-rating-btn').forEach(btn => {
                        btn.classList.remove('selected');
                    });
                    
                    // If we just toggled off the rating, don't select anything
                    if (photoRatings[photoId] === option.value) {
                        button.classList.add('selected');
                    }
                });
                
                ratingButtons.appendChild(button);
            });
            
            ratingOverlay.appendChild(ratingButtons);
            photoContainer.appendChild(ratingOverlay);
            
            const photoDetails = document.createElement('div');
            photoDetails.className = 'photo-details';
            
            const photoName = document.createElement('div');
            photoName.className = 'photo-name';
            photoName.textContent = photo.name || 'Photo';
            
            const photoDate = document.createElement('div');
            photoDate.className = 'photo-date';
            if (photo.uploadedAt) {
                const date = photo.uploadedAt.toDate ? photo.uploadedAt.toDate() : new Date(photo.uploadedAt);
                photoDate.textContent = date.toLocaleDateString();
            }
            
            photoDetails.appendChild(photoName);
            photoDetails.appendChild(photoDate);
            
            photoItem.appendChild(photoContainer);
            photoItem.appendChild(photoDetails);
            
            // Make photo clickable to open lightbox
            photoContainer.addEventListener('click', function() {
                openLightbox(photo);
            });
            
            // Keyboard handler for accessibility
            photoContainer.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    openLightbox(photo);
                }
            });
            
            return photoItem;
        }
        
        // Show page error (full page error)
        function showPageError(message) {
            console.error("Page error:", message);
            
            // Hide loading indicator and other containers
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('passwordScreen').style.display = 'none';
            document.getElementById('galleryContainer').style.display = 'none';
            
            // Show error page
            const errorPage = document.getElementById('errorPage');
            errorPage.style.display = 'block';
            
            // Set error message
            document.getElementById('errorMessage').textContent = message;
            
            // Setup retry button
            document.getElementById('retryBtn').addEventListener('click', function() {
                // Reload the page
                window.location.reload();
            });
        }
        
        // Show error message as toast
        function showError(message) {
            // Show toast notification
            showToast(message, 'error');
        }
        
        // Show toast notification
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            
            // Add aria-live for accessibility
            toast.setAttribute('aria-live', type === 'error' ? 'assertive' : 'polite');
            
            toastContainer.appendChild(toast);
            
            // Remove toast after 4 seconds (a bit longer for better readability)
            setTimeout(() => {
                toast.classList.add('fadeOut');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 4000);
        }



        // DRAGGABLE SYSTEM
        let dragState = { isDragging: false, startX: 0, startY: 0, element: null };
        
        function makeDraggable(element) {
            element.style.cursor = 'move';
            element.addEventListener('mousedown', function(e) {
                e.preventDefault();
                dragState.isDragging = true;
                dragState.element = element;
                const rect = element.getBoundingClientRect();
                dragState.startX = e.clientX - rect.left;
                dragState.startY = e.clientY - rect.top;
                element.style.opacity = '0.8';
            });
        }
        
        document.addEventListener('mousemove', function(e) {
            if (!dragState.isDragging) return;
            let newX = e.clientX - dragState.startX;
            let newY = e.clientY - dragState.startY;
            newX = Math.max(0, Math.min(window.innerWidth - dragState.element.offsetWidth, newX));
            newY = Math.max(0, Math.min(window.innerHeight - dragState.element.offsetHeight, newY));
            dragState.element.style.left = newX + 'px';
            dragState.element.style.top = newY + 'px';
        });
        
        document.addEventListener('mouseup', function() {
            if (dragState.isDragging) {
                dragState.isDragging = false;
                dragState.element.style.opacity = '1';
                dragState.element = null;
            }
        });

        // ===== SUBMIT SNAPSELECTIONS - PHASE 1 =====
        
        // 1. Calculate submission progress percentage
        function calculateSubmissionProgress() {
            const totalPhotos = allGalleryPhotos.length;
            const ratedPhotos = Object.keys(photoRatings).length;
            
            if (totalPhotos === 0) return 0;
            
            const percentage = Math.round((ratedPhotos / totalPhotos) * 100);
            return Math.min(percentage, 100); // Cap at 100%
        }
        
        // 2. Update submit button based on progress
        function updateSubmitButton() {
            const submitBtn = document.getElementById('submitSnapSelectionsBtn');
            if (!submitBtn) return;
            
            const progress = calculateSubmissionProgress();
            const totalPhotos = allGalleryPhotos.length;
            const ratedPhotos = Object.keys(photoRatings).length;
            
            // Update progress bar
            const progressBar = submitBtn.querySelector('.progress-bar');
            if (progressBar) {
                progressBar.style.width = `${progress}%`;
            }
            
            // Update text
            const buttonText = submitBtn.querySelector('.button-text');
            if (buttonText) {
                if (progress === 0) {
                    buttonText.textContent = 'Submit SnapSelections';
                } else {
                    buttonText.textContent = `Submit SnapSelections (${ratedPhotos}/${totalPhotos})`;
                }
            }
            
            // Update button state and styling
            submitBtn.className = 'submit-snapselections-btn';
            
            if (progress === 0) {
                // No progress state
                submitBtn.classList.add('no-progress');
                submitBtn.disabled = true;
                progressBar.style.backgroundColor = '#ccc';
            } else if (progress < 80) {
                // In progress state
                submitBtn.classList.add('in-progress');
                submitBtn.disabled = true;
                progressBar.style.backgroundColor = '#ff9500'; // Orange
            } else if (progress < 100) {
                // Ready state (80-99%)
                submitBtn.classList.add('ready');
                submitBtn.disabled = false;
                progressBar.style.backgroundColor = '#007bff'; // Blue
                
                // Add gentle pulse effect
                if (!submitBtn.classList.contains('pulse-added')) {
                    submitBtn.style.animation = 'gentle-pulse 2s infinite';
                    submitBtn.classList.add('pulse-added');
                }
            } else {
                // Complete state (100%)
                submitBtn.classList.add('complete');
                submitBtn.disabled = false;
                progressBar.style.backgroundColor = '#28a745'; // Green
                
                // Add completion highlight
                if (!submitBtn.classList.contains('complete-animation-done')) {
                    submitBtn.style.animation = 'completion-highlight 1s ease-out';
                    submitBtn.classList.add('complete-animation-done');
                }
            }
            
            // Update tooltip
            updateSubmitButtonTooltip(submitBtn, progress, ratedPhotos, totalPhotos);

            // Apply blue overlay fixes after button updates
            setTimeout(() => {
                fixBlueOverlayTextIssue();
            }, 100);
        }
        
        // 3. Update button tooltip based on state
        function updateSubmitButtonTooltip(button, progress, ratedPhotos, totalPhotos) {
            if (progress === 0) {
                button.title = 'Start rating photos to enable submission';
            } else if (progress < 80) {
                const remaining = Math.ceil(totalPhotos * 0.8) - ratedPhotos;
                button.title = `Rate ${remaining} more photos to enable submission (${progress}% complete)`;
            } else if (progress < 100) {
                button.title = `Ready to submit! You've rated ${progress}% of photos`;
            } else {
                button.title = 'All photos rated - Click to submit your selections';
            }
        }
        
     

        // 4. Create the submit button element - UPDATED to place in studio info
        function createSubmitSnapSelectionsButton() {
            // Check if button already exists
            if (document.getElementById('submitSnapSelectionsBtn')) return;
            
            // Wait for studio info to be available
            const waitForStudioInfo = () => {
                const studioInfo = document.getElementById('studioInfo');
                if (!studioInfo) {
                    // Studio info not ready yet, try again in 500ms
                    setTimeout(waitForStudioInfo, 500);
                    return;
                }
                
                // Create the submit button
                const submitBtn = document.createElement('button');
                submitBtn.id = 'submitSnapSelectionsBtn';
                submitBtn.className = 'submit-snapselections-btn no-progress';
                submitBtn.disabled = true;
                
                // Create button structure
                submitBtn.innerHTML = `
                    <div class="progress-container">
                        <div class="progress-bar"></div>
                    </div>
                    <i class="fas fa-paper-plane button-icon"></i>
                    <span class="button-text">Submit SnapSelections</span>
                `;
                
                // Add click handler
                submitBtn.addEventListener('click', function() {
                    if (!submitBtn.disabled) {
                        console.log('Submit button clicked..');
                        showSubmissionModal();
                    }
                });
                
                // MODIFIED: Place button in studio info section instead of fixed position
                // Make studio info container flexbox for right alignment
                studioInfo.style.display = 'flex';
                studioInfo.style.justifyContent = 'space-between';
                studioInfo.style.alignItems = 'flex-start';
                studioInfo.style.gap = '20px';
                
                // Create left content container for text
                const leftContent = document.createElement('div');
                leftContent.className = 'studio-left-content';
                leftContent.style.flex = '1';
                
                // Move all existing content to left container
                const existingContent = Array.from(studioInfo.children);
                existingContent.forEach(child => {
                    leftContent.appendChild(child);
                });
                
                // Create right container for button
                const rightContainer = document.createElement('div');
                rightContainer.className = 'studio-right-container';
                rightContainer.style.display = 'flex';
                rightContainer.style.alignItems = 'center';
                rightContainer.style.minWidth = 'auto';
                
                // Style button for new location
                submitBtn.style.position = 'static';
                submitBtn.style.top = 'auto';
                submitBtn.style.right = 'auto';
                submitBtn.style.margin = '0';
                submitBtn.style.transform = 'scale(0.9)'; // Slightly smaller
                submitBtn.style.whiteSpace = 'nowrap';
                
                // Add button to right container
                rightContainer.appendChild(submitBtn);
                
                // Add both containers to studio info
                studioInfo.appendChild(leftContent);
                studioInfo.appendChild(rightContainer);
                
                // Initial update
                updateSubmitButton();
                // Apply fixes after button creation
                setTimeout(() => {
                    fixBlueOverlayTextIssue();
                    console.log('Blue overlay fixes applied to submit button');
                }, 500);
                
                console.log('Submit button created and placed in studio info section');
            };
            
            // Start waiting for studio info
            waitForStudioInfo();
        }
            
 
        // 5. Add CSS styles for the button - UPDATED for studio info placement
        function addSubmitButtonStyles() {
            // Check if styles already added
            if (document.getElementById('submitSnapSelectionsStyles')) return;
            
            const style = document.createElement('style');
            style.id = 'submitSnapSelectionsStyles';
            style.textContent = `
                .submit-snapselections-btn {
                    background: #f8f9fa;
                    color: #666;
                    border: 2px solid #e9ecef;
                    border-radius: 25px;
                    padding: 12px 20px;
                    cursor: not-allowed;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    font-size: 14px;
                    font-weight: 600;
                    transition: all 0.3s ease;
                    min-width: 220px;
                    position: relative;
                    overflow: hidden;
                }
                
                .submit-snapselections-btn .progress-container {
                    position: absolute;
                    left: 0;
                    top: 0;
                    height: 100%;
                    width: 100%;
                    background: rgba(255,255,255,0.9);
                    overflow: hidden;
                    border-radius: 23px;
                }
                
                .submit-snapselections-btn .progress-bar {
                    height: 100%;
                    width: 0%;
                    background-color: #ccc;
                    transition: all 0.4s ease;
                    border-radius: 23px;
                }
                
                .submit-snapselections-btn .button-icon,
                .submit-snapselections-btn .button-text {
                    position: relative;
                    z-index: 2;
                }
                
                .submit-snapselections-btn.ready {
                    cursor: pointer;
                    color: #007bff;
                    border-color: #007bff;
                }
                
                .submit-snapselections-btn.ready:hover {
                    background: #e3f2fd;
                    transform: translateY(-1px);
                    box-shadow: 0 4px 12px rgba(0,123,255,0.3);
                }
                
                .submit-snapselections-btn.complete {
                    cursor: pointer;
                    color: #28a745;
                    border-color: #28a745;
                }
                
                .submit-snapselections-btn.complete:hover {
                    background: #e8f5e8;
                    transform: translateY(-1px);
                    box-shadow: 0 4px 12px rgba(40,167,69,0.3);
                }
                
                @keyframes gentle-pulse {
                    0%, 100% { transform: scale(1); }
                    50% { transform: scale(1.02); }
                }
                
                @keyframes completion-highlight {
                    0% { box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
                    50% { box-shadow: 0 0 20px rgba(40,167,69,0.6); }
                    100% { box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
                }
                
                /* Studio info layout styles */
                .studio-left-content {
                    flex: 1;
                }
                
                .studio-right-container {
                    display: flex;
                    align-items: center;
                }
                
                /* Mobile responsiveness */
                @media (max-width: 768px) {
                    #studioInfo {
                        flex-direction: column !important;
                        gap: 15px !important;
                    }
                    
                    .studio-right-container {
                        width: 100%;
                        justify-content: center;
                    }
                    
                    .submit-snapselections-btn {
                        min-width: 200px;
                        font-size: 12px;
                        padding: 10px 16px;
                        transform: scale(1) !important;
                    }
                }
                
                @media (max-width: 480px) {
                    .submit-snapselections-btn {
                        min-width: 180px;
                        font-size: 11px;
                        padding: 8px 12px;
                    }
                }
            `;
            
            document.head.appendChild(style);
        }
        
        // 6. Initialize the submit button system
        function initSubmitSnapSelections() {
            console.log('Initializing Submit SnapSelections - Phase 1');
            
            // Add CSS styles
            addSubmitButtonStyles();
            
            // Create the button
            createSubmitSnapSelectionsButton();
            
            console.log('Submit SnapSelections button created and ready');
        }

        // ===== SUBMIT SNAPSELECTIONS - PHASE 2 =====
        // Confirmation Modal with Password Verification
        
        // 1. Create submission confirmation modal
        function createSubmissionModal() {
            const modal = document.createElement('div');
            modal.id = 'submissionModal';
            modal.className = 'submission-modal-overlay';
            
            const modalContent = document.createElement('div');
            modalContent.className = 'submission-modal-content';
            
            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2><i class="fas fa-paper-plane"></i> Submit Your SnapSelections</h2>
                    <button class="modal-close-btn" onclick="closeSubmissionModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="modal-body">
                    <div class="submission-summary">
                        <h3>Selection Summary</h3>
                        <div class="summary-stats">
                            <div class="stat-item">
                                <span class="stat-label">Total Photos:</span>
                                <span id="modal-total-photos">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Photos Rated:</span>
                                <span id="modal-rated-photos">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Completion:</span>
                                <span id="modal-completion">0%</span>
                            </div>
                        </div>
                        
                        <div class="rating-breakdown">
                            <div class="breakdown-item">
                                <span class="breakdown-emoji">‚ù§Ô∏è</span>
                                <span class="breakdown-label">Must Have</span>
                                <span id="modal-heart-count" class="breakdown-count">0</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-emoji">üëç</span>
                                <span class="breakdown-label">Would Like to Have</span>
                                <span id="modal-thumbsup-count" class="breakdown-count">0</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-emoji">ü§î</span>
                                <span class="breakdown-label">Alternative Option</span>
                                <span id="modal-thinking-count" class="breakdown-count">0</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-emoji">üëé</span>
                                <span class="breakdown-label">Not Interested</span>
                                <span id="modal-thumbsdown-count" class="breakdown-count">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="submission-warning">
                        <div class="warning-box">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p><strong>Important:</strong> Once submitted, your selections cannot be changed. Please review your choices carefully.</p>
                        </div>
                    </div>
                    
                    <div class="password-verification">
                        <h3>Confirm Submission</h3>
                        <p>Enter the gallery password to confirm your submission:</p>
                        <div class="password-input-group">
                            <input type="password" id="modal-password" class="modal-password-input" 
                                   placeholder="Enter gallery password" autocomplete="current-password">
                            <button type="button" class="password-toggle-btn" onclick="togglePasswordVisibility()">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div id="modal-password-error" class="password-error-message"></div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button class="modal-btn modal-btn-cancel" onclick="closeSubmissionModal()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button class="modal-btn modal-btn-submit" onclick="processSubmission()" disabled>
                        <i class="fas fa-paper-plane"></i> 
                        <span class="submit-btn-text">Submit SnapSelections</span>
                        <div class="submit-btn-spinner" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                    </button>
                </div>
            `;
            
            modal.appendChild(modalContent);
            return modal;
        }
        
        // 2. Show submission modal with current data
        function showSubmissionModal() {
            // Check if modal already exists
            let modal = document.getElementById('submissionModal');
            if (!modal) {
                modal = createSubmissionModal();
                document.body.appendChild(modal);
            }
            
            // Update modal with current data
            updateModalData();
            
            // Show modal with animation
            modal.style.display = 'flex';
            setTimeout(() => {
                modal.classList.add('modal-show');
                // Focus password input for accessibility
                document.getElementById('modal-password').focus();
            }, 10);
            
            // Set up password input validation
            setupPasswordValidation();
        }
        
        // 3. Update modal with current rating data
        function updateModalData() {
            const totalPhotos = allGalleryPhotos.length;
            const ratedPhotos = Object.keys(photoRatings).length;
            const completion = Math.round((ratedPhotos / totalPhotos) * 100);
            
            // Update summary stats
            document.getElementById('modal-total-photos').textContent = totalPhotos;
            document.getElementById('modal-rated-photos').textContent = ratedPhotos;
            document.getElementById('modal-completion').textContent = `${completion}%`;
            
            // Count ratings by type
            const counts = { heart: 0, thumbsUp: 0, thinking: 0, thumbsDown: 0 };
            Object.values(photoRatings).forEach(rating => {
                if (counts[rating] !== undefined) {
                    counts[rating]++;
                }
            });
            
            // Update rating breakdown
            document.getElementById('modal-heart-count').textContent = counts.heart;
            document.getElementById('modal-thumbsup-count').textContent = counts.thumbsUp;
            document.getElementById('modal-thinking-count').textContent = counts.thinking;
            document.getElementById('modal-thumbsdown-count').textContent = counts.thumbsDown;
        }
        
        // 4. Setup password validation
        function setupPasswordValidation() {
            const passwordInput = document.getElementById('modal-password');
            const submitBtn = document.querySelector('.modal-btn-submit');
            const errorDiv = document.getElementById('modal-password-error');
            
            // Clear previous error
            errorDiv.textContent = '';
            errorDiv.style.display = 'none';
            
            // Reset submit button
            submitBtn.disabled = true;
            submitBtn.querySelector('.submit-btn-text').textContent = 'Submit SnapSelections';
            
            // Add input validation
            passwordInput.addEventListener('input', function() {
                const hasPassword = passwordInput.value.trim().length > 0;
                submitBtn.disabled = !hasPassword;
                
                // Clear error when user types
                if (errorDiv.style.display !== 'none') {
                    errorDiv.style.display = 'none';
                }
            });
            
            // Handle Enter key in password field
            passwordInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !submitBtn.disabled) {
                    processSubmission();
                }
            });
        }
        
        // 5. Toggle password visibility
        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('modal-password');
            const toggleBtn = document.querySelector('.password-toggle-btn i');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleBtn.className = 'fas fa-eye-slash';
            } else {
                passwordInput.type = 'password';
                toggleBtn.className = 'fas fa-eye';
            }
        }
        
        // 6. Process the submission
        function processSubmission() {
            const passwordInput = document.getElementById('modal-password');
            const password = passwordInput.value.trim();
            const errorDiv = document.getElementById('modal-password-error');
            const submitBtn = document.querySelector('.modal-btn-submit');
            
            if (!password) {
                showPasswordError('Please enter the gallery password.');
                return;
            }
            
            // Show loading state
            setSubmitButtonLoading(true);
            
            // Get the original gallery password for verification
            const urlParams = new URLSearchParams(window.location.search);
            const shareId = urlParams.get('share');
            
            if (!shareId) {
                showPasswordError('Unable to verify password. Please refresh and try again.');
                setSubmitButtonLoading(false);
                return;
            }
            
            // Verify password against the gallery
            verifyGalleryPassword(password, shareId)
                .then(isValid => {
                    if (isValid) {
                        // Password correct - proceed to Phase 3 (actual submission)
                        console.log('Password verified! Proceeding to submission...');
                        
                        // For now, show success (Phase 3 will handle actual Firebase submission)
                        processActualSubmission();
                    } else {
                        showPasswordError('Incorrect password. Please try again.');
                        setSubmitButtonLoading(false);
                        passwordInput.focus();
                    }
                })
                .catch(error => {
                    console.error('Password verification error:', error);
                    showPasswordError('Error verifying password. Please try again.');
                    setSubmitButtonLoading(false);
                });
        }
        
        // 7. Verify gallery password
        async function verifyGalleryPassword(enteredPassword, shareId) {
            try {
                const db = firebase.firestore();
                
                // Get the gallery shares to find the correct password
                const snapshot = await db.collection('galleryShares')
                    .where('shareId', '==', shareId)
                    .limit(1)
                    .get();
                
                if (snapshot.empty) {
                    // Try alternative collection
                    const altSnapshot = await db.collection('sharedGalleries')
                        .where('shareId', '==', shareId)
                        .limit(1)
                        .get();
                    
                    if (altSnapshot.empty) {
                        return false;
                    }
                    
                    const galleryData = altSnapshot.docs[0].data();
                    return galleryData.password === enteredPassword;
                }
                
                const galleryData = snapshot.docs[0].data();
                return galleryData.password === enteredPassword;
            } catch (error) {
                console.error('Error verifying password:', error);
                return false;
            }
        }
        
        // 8. Show password error
        function showPasswordError(message) {
            const errorDiv = document.getElementById('modal-password-error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            // Add shake animation
            errorDiv.style.animation = 'shake 0.5s ease-in-out';
            setTimeout(() => {
                errorDiv.style.animation = '';
            }, 500);
        }
        
        // 9. Set submit button loading state
     
        function setSubmitButtonLoading(isLoading) {
            const submitBtn = document.querySelector('.modal-btn-submit') || 
                             document.getElementById('submitSnapSelectionsBtn') ||
                             document.querySelector('.submit-snapselections-btn');
            
            if (!submitBtn) {
                console.warn('‚ö†Ô∏è Submit button not found - skipping loading state update');
                return;
            }
            
            const textSpan = submitBtn.querySelector('.submit-btn-text');
            const spinner = submitBtn.querySelector('.submit-btn-spinner');
            
            if (isLoading) {
                submitBtn.disabled = true;
                if (textSpan) textSpan.style.display = 'none';
                if (spinner) spinner.style.display = 'inline-flex';
            } else {
                submitBtn.disabled = false;
                if (textSpan) textSpan.style.display = 'inline';
                if (spinner) spinner.style.display = 'none';
            }
        }
     
        
        // 11. Close submission modal
        function closeSubmissionModal() {
            const modal = document.getElementById('submissionModal');
            if (modal) {
                modal.classList.remove('modal-show');
                setTimeout(() => {
                    modal.style.display = 'none';
                    // Reset modal content if it was changed to success state
                    if (modal.querySelector('.success-content')) {
                        modal.remove();
                    }
                }, 300);
            }
        }
        
        // 12. Add submit button to lightbox toolbar (CORRECTED PLACEMENT)
        function addSubmitButtonToLightbox(toolbar) {
            // Check if button already exists in this lightbox
            if (toolbar.querySelector('.lightbox-submit-btn')) return;
            
            const progress = calculateSubmissionProgress();
            
            // Only show if user has made some progress (at least 80%)
            if (progress < 80) return;
            
            const submitBtn = document.createElement('button');
            submitBtn.className = 'modal-button lightbox-submit-btn';
            submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
            submitBtn.setAttribute('aria-label', 'Submit SnapSelections');
            submitBtn.title = `Submit your selections (${progress}% complete)`;
            
            // Add click handler
            submitBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                showSubmissionModal();
            });
            
            // Add to toolbar (before close button)
            const closeButton = toolbar.querySelector('.modal-button:last-child');
            if (closeButton) {
                toolbar.insertBefore(submitBtn, closeButton);
            } else {
                toolbar.appendChild(submitBtn);
            }
        }
        
        // 13. Add CSS styles for the modal
        function addSubmissionModalStyles() {
            if (document.getElementById('submissionModalStyles')) return;
            
            const style = document.createElement('style');
            style.id = 'submissionModalStyles';
            style.textContent = `
                /* Submission Modal Styles */
                .submission-modal-overlay {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.8);
                    z-index: 5000;
                    display: none;
                    justify-content: center;
                    align-items: center;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                }
                
                .submission-modal-overlay.modal-show {
                    opacity: 1;
                }
                
                .submission-modal-content {
                    background: white;
                    border-radius: 12px;
                    width: 90%;
                    max-width: 600px;
                    max-height: 90vh;
                    overflow-y: auto;
                    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                    transform: scale(0.9);
                    transition: transform 0.3s ease;
                }
                
                .modal-show .submission-modal-content {
                    transform: scale(1);
                }
                
                .modal-header {
                    padding: 24px 24px 0 24px;
                    border-bottom: 1px solid #e9ecef;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }
                
                .modal-header h2 {
                    margin: 0;
                    color: #333;
                    font-size: 24px;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                }
                
                .modal-close-btn {
                    background: none;
                    border: none;
                    font-size: 20px;
                    color: #666;
                    cursor: pointer;
                    padding: 8px;
                    border-radius: 50%;
                    transition: background-color 0.2s;
                }
                
                .modal-close-btn:hover {
                    background-color: #f8f9fa;
                    color: #333;
                }
                
                .modal-body {
                    padding: 24px;
                }
                
                .submission-summary h3 {
                    margin: 0 0 16px 0;
                    color: #333;
                    font-size: 18px;
                }
                
                .summary-stats {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                    gap: 16px;
                    margin-bottom: 24px;
                    padding: 16px;
                    background-color: #f8f9fa;
                    border-radius: 8px;
                }
                
                .stat-item {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }
                
                .stat-label {
                    font-weight: 600;
                    color: #555;
                }
                
                .rating-breakdown {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                    gap: 12px;
                    margin-bottom: 24px;
                }
                
                .breakdown-item {
                    display: flex;
                    align-items: center;
                    padding: 12px;
                    background-color: #fff;
                    border: 1px solid #e9ecef;
                    border-radius: 6px;
                    gap: 10px;
                }
                
                .breakdown-emoji {
                    font-size: 20px;
                }
                
                .breakdown-label {
                    flex: 1;
                    font-weight: 500;
                }
                
                .breakdown-count {
                    font-weight: bold;
                    color: #007bff;
                    font-size: 18px;
                }
                
                .warning-box {
                    display: flex;
                    align-items: flex-start;
                    gap: 12px;
                    padding: 16px;
                    background-color: #fff3cd;
                    border: 1px solid #ffeaa7;
                    border-radius: 6px;
                    margin-bottom: 24px;
                }
                
                .warning-box i {
                    color: #856404;
                    font-size: 20px;
                    margin-top: 2px;
                }
                
                .warning-box p {
                    margin: 0;
                    color: #856404;
                }
                
                .password-verification h3 {
                    margin: 0 0 12px 0;
                    color: #333;
                }
                
                .password-input-group {
                    position: relative;
                    margin: 12px 0;
                }
                
                .modal-password-input {
                    width: 100%;
                    padding: 12px 40px 12px 12px;
                    border: 2px solid #e9ecef;
                    border-radius: 6px;
                    font-size: 16px;
                    transition: border-color 0.2s;
                    box-sizing: border-box;
                }
                
                .modal-password-input:focus {
                    border-color: #007bff;
                    outline: none;
                }
                
                .password-toggle-btn {
                    position: absolute;
                    right: 8px;
                    top: 50%;
                    transform: translateY(-50%);
                    background: none;
                    border: none;
                    color: #666;
                    cursor: pointer;
                    padding: 8px;
                }
                
                .password-error-message {
                    color: #dc3545;
                    font-size: 14px;
                    margin-top: 8px;
                    display: none;
                }
                
                .modal-footer {
                    padding: 0 24px 24px 24px;
                    display: flex;
                    gap: 12px;
                    justify-content: flex-end;
                }
                
                .modal-btn {
                    padding: 12px 24px;
                    border: none;
                    border-radius: 6px;
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.2s;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                }
                
                .modal-btn-cancel {
                    background-color: #6c757d;
                    color: white;
                }
                
                .modal-btn-cancel:hover {
                    background-color: #5a6268;
                }
                
                .modal-btn-submit {
                    background-color: #28a745;
                    color: white;
                }
                
                .modal-btn-submit:hover:not(:disabled) {
                    background-color: #218838;
                }
                
                .modal-btn-submit:disabled {
                    background-color: #6c757d;
                    cursor: not-allowed;
                }
                
                .submit-btn-spinner {
                    display: none;
                }
                
                /* Success state */
                .success-content {
                    text-align: center;
                    padding: 48px 24px;
                }
                
                .success-icon {
                    font-size: 64px;
                    color: #28a745;
                    margin-bottom: 24px;
                }
                
                .success-details {
                    background-color: #f8f9fa;
                    padding: 16px;
                    border-radius: 6px;
                    margin: 24px 0;
                }
                
                .modal-btn-primary {
                    background-color: #007bff;
                    color: white;
                    margin: 0 auto;
                }
                
                .modal-btn-primary:hover {
                    background-color: #0056b3;
                }
                
                /* Animations */
                @keyframes shake {
                    0%, 100% { transform: translateX(0); }
                    25% { transform: translateX(-5px); }
                    75% { transform: translateX(5px); }
                }
                
                /* Mobile responsiveness */
                @media (max-width: 768px) {
                    .submission-modal-content {
                        width: 95%;
                    }
                    
                    .modal-header, .modal-body, .modal-footer {
                        padding: 16px;
                    }
                    
                    .summary-stats {
                        grid-template-columns: 1fr;
                    }
                    
                    .rating-breakdown {
                        grid-template-columns: 1fr;
                    }
                    
                    .modal-footer {
                        flex-direction: column;
                    }
                }
            `;
            
            document.head.appendChild(style);
        }
        
        // 14. Initialize Phase 2
        function initSubmitSnapSelectionsPhase2() {
            console.log('Initializing Submit SnapSelections - Phase 2');
            
            // Add modal styles
            addSubmissionModalStyles();
            
            console.log('Phase 2 modal system ready');
        }





        // Function to fix blue overlay hiding text behind it
        function fixBlueOverlayTextIssue() {
            console.log('üîç Looking for blue overlay text visibility issues...');
            
            // Find the submit button
            const submitBtn = document.getElementById('submitSnapSelectionsBtn') || 
                             document.querySelector('.submit-snapselections-btn');
            
            if (!submitBtn) {
                console.log('‚ùå Submit button not found');
                return false;
            }
            
            console.log('‚úÖ Found submit button:', submitBtn);
            
            // Method 1: Fix z-index layering
            const studioInfo = document.getElementById('studioInfo');
            if (studioInfo) {
                studioInfo.style.zIndex = '10';
                studioInfo.style.position = 'relative';
                console.log('‚úÖ Fixed studio info z-index');
            }
            
            // Method 2: Fix progress bar opacity
            const progressContainer = submitBtn.querySelector('.progress-container');
            if (progressContainer) {
                progressContainer.style.opacity = '0.8';
                console.log('‚úÖ Reduced progress container opacity');
            }
            
            // Method 3: Ensure text is above overlay
            const buttonText = submitBtn.querySelector('.button-text');
            const buttonIcon = submitBtn.querySelector('.button-icon');
            
            if (buttonText) {
                buttonText.style.zIndex = '10';
                buttonText.style.position = 'relative';
                buttonText.style.color = '#333';
                buttonText.style.fontWeight = 'bold';
                console.log('‚úÖ Fixed button text visibility');
            }
            
            if (buttonIcon) {
                buttonIcon.style.zIndex = '10';
                buttonIcon.style.position = 'relative';
                buttonIcon.style.color = '#333';
                console.log('‚úÖ Fixed button icon visibility');
            }
            
            // Method 4: Adjust progress bar background
            const progressBar = submitBtn.querySelector('.progress-bar');
            if (progressBar) {
                progressBar.style.opacity = '0.7';
                console.log('‚úÖ Reduced progress bar opacity');
            }
            
            // Method 5: Add text shadow for better visibility
            if (buttonText) {
                buttonText.style.textShadow = '1px 1px 2px rgba(255,255,255,0.8)';
            }
            
            console.log('‚úÖ Blue overlay text visibility fixed!');
            return true;
        }
        
        // Alternative approach - make progress bar less intrusive
        function makeProgressBarSubtle() {
            console.log('üîß Making progress bar more subtle...');
            
            const submitBtn = document.getElementById('submitSnapSelectionsBtn') || 
                             document.querySelector('.submit-snapselections-btn');
            
            if (!submitBtn) {
                console.log('‚ùå Submit button not found');
                return false;
            }
            
            const progressContainer = submitBtn.querySelector('.progress-container');
            const progressBar = submitBtn.querySelector('.progress-bar');
            
            if (progressContainer) {
                // Make progress container a border instead of fill
                progressContainer.style.background = 'transparent';
                progressContainer.style.border = '2px solid rgba(0,123,255,0.3)';
                progressContainer.style.borderRadius = '25px';
            }
            
            if (progressBar) {
                // Make progress bar a thin line at bottom
                progressBar.style.height = '3px';
                progressBar.style.bottom = '2px';
                progressBar.style.top = 'auto';
                progressBar.style.borderRadius = '0 0 23px 23px';
                progressBar.style.opacity = '0.8';
            }
            
            console.log('‚úÖ Progress bar made more subtle');
            return true;
        }
        
        // Method to change button styling completely
        function improveButtonStyling() {
            console.log('üé® Improving button styling...');
            
            const submitBtn = document.getElementById('submitSnapSelectionsBtn') || 
                             document.querySelector('.submit-snapselections-btn');
            
            if (!submitBtn) {
                console.log('‚ùå Submit button not found');
                return false;
            }
            
            // Option 1: Use background gradient instead of overlay
            submitBtn.style.background = 'linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)';
            submitBtn.style.border = '2px solid #007bff';
            
            // Ensure text is always visible
            const buttonText = submitBtn.querySelector('.button-text');
            const buttonIcon = submitBtn.querySelector('.button-icon');
            
            if (buttonText) {
                buttonText.style.color = '#007bff';
                buttonText.style.fontWeight = '600';
                buttonText.style.zIndex = '100';
                buttonText.style.position = 'relative';
            }
            
            if (buttonIcon) {
                buttonIcon.style.color = '#007bff';
                buttonIcon.style.zIndex = '100';
                buttonIcon.style.position = 'relative';
            }
            
            // Hide the progress overlay completely and use border color instead
            const progressContainer = submitBtn.querySelector('.progress-container');
            if (progressContainer) {
                progressContainer.style.display = 'none';
            }
            
            // Show progress through border color changes
            const progress = calculateSubmissionProgress();
            if (progress >= 80) {
                submitBtn.style.borderColor = '#28a745';
                submitBtn.style.background = 'linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%)';
                if (buttonText) buttonText.style.color = '#28a745';
                if (buttonIcon) buttonIcon.style.color = '#28a745';
            }
            
            console.log('‚úÖ Button styling improved');
            return true;
        }




        // ===== PHASE 3: REAL SUBMISSION FUNCTIONS =====

        // 1. MAIN SUBMISSION HANDLER
   
  // REPLACE this function in your client gallery HTML:
       
        
        async function processActualSubmission() {
 
            try {
                console.log('üöÄ Starting secure submission...');
                
                // Prepare data without authentication
                const payload = {
                    galleryId: getGalleryId(),
                    userToken: getUserIdentifier(),
                    ratings: { ...photoRatings },
                    userAgent: navigator.userAgent,
                    currentUrl: window.location.href
                };
                
                console.log('üì¶ Submission payload:', payload);
                
                // FIXED: Use the same pattern as your working dashboard
                const functions = firebase.app().functions('asia-south1');
                const submitSelections = functions.httpsCallable('submitClientSelections');
                
                console.log('‚òÅÔ∏è Calling Cloud Function...');
                const result = await submitSelections(payload);
                
                console.log('‚úÖ Cloud Function response:', result);
                
                if (result.data?.success) {
                    const submissionData = {
                        submissionId: result.data.submissionId || result.data.data.submissionId,
                        ratedPhotos: result.data.data?.ratedPhotos || Object.keys(photoRatings).length,
                        totalPhotos: result.data.data?.totalPhotos || allGalleryPhotos.length,
                        completionPercentage: result.data.data?.completionPercentage || calculateSubmissionProgress(),
                        submittedAt: new Date(), // FIX: Always use current date instead of server timestamp
                        galleryId: getGalleryId(),
                        userId: getUserIdentifier()
                    };
                    
                    console.log('üìã Processed submission data:', submissionData);
                    
                    completeGalleryLockdown(submissionData, submissionData.submissionId);
                    showRealSubmissionSuccess(submissionData, submissionData.submissionId);
                } else {
                    throw new Error(result.data?.message || 'Invalid server response');
                }
                
            } catch (error) {
                console.error('‚ùå Submission failed:', error);
                
                let errorMessage = 'Submission failed';
                if (error.code === 'already-exists') {
                    errorMessage = 'Your selections have already been submitted for this gallery';
                } else if (error.code === 'not-found') {
                    errorMessage = 'Gallery not found - please check your link';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                showSubmissionError(errorMessage);
                
                try {
                    setSubmitButtonLoading(false);
                } catch (btnError) {
                    console.warn('Could not reset submit button:', btnError);
                }
            }
        }
            
        // ADD this authentication helper:
        function ensureFirebaseAuth() {
            return new Promise((resolve, reject) => {
                const auth = firebase.auth();
                
                if (auth.currentUser) {
                    resolve(auth.currentUser);
                    return;
                }
                
                auth.signInAnonymously()
                    .then(resolve)
                    .catch(reject);
            });
        }
        
        // 2. COLLECT SUBMISSION DATA
        function collectCurrentSubmissionData() {
            const galleryId = getGalleryId();
            const userId = getUserIdentifier();
            
            // Count ratings by type
            const ratingCounts = {
                heart: 0,
                thumbsUp: 0,
                thinking: 0,
                thumbsDown: 0
            };
            
            // Count each rating type
            Object.values(photoRatings).forEach(rating => {
                if (rating && ratingCounts[rating] !== undefined) {
                    ratingCounts[rating]++;
                }
            });
            
            return {
                galleryId: galleryId,
                userId: userId,
                ratings: { ...photoRatings }, // Copy of all photo ratings
                ratingCounts: ratingCounts,
                totalPhotos: allGalleryPhotos.length,
                ratedPhotos: Object.keys(photoRatings).length,
                completionPercentage: Math.round((Object.keys(photoRatings).length / allGalleryPhotos.length) * 100),
                submittedAt: new Date(),
                userAgent: navigator.userAgent,
                currentUrl: window.location.href
            };
        }
        
        // 3. SAVE TO CLIENTSUBMISSIONS COLLECTION
        async function saveSubmissionToFirebase(submissionData, submissionId) {
            const db = firebase.firestore();
            
            const submissionRecord = {
                submissionId: submissionId,
                galleryId: submissionData.galleryId,
                userId: submissionData.userId,
                
                // Rating data
                ratings: submissionData.ratings,
                ratingCounts: submissionData.ratingCounts,
                
                // Summary stats
                totalPhotos: submissionData.totalPhotos,
                ratedPhotos: submissionData.ratedPhotos,
                completionPercentage: submissionData.completionPercentage,
                
                // Timestamps
                submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
                clientSubmittedAt: firebase.firestore.Timestamp.fromDate(submissionData.submittedAt),
                
                // Metadata
                userAgent: submissionData.userAgent,
                currentUrl: submissionData.currentUrl,
                status: 'submitted'
            };
            
            // Save to clientSubmissions collection
            await db.collection('clientSubmissions').doc(submissionId).set(submissionRecord);
            
            console.log('üìù Saved submission record:', submissionId);
        }
        
        // 4. UPDATE GALLERY STATUS FOR DASHBOARD
        async function updateGalleryStatus(submissionData, submissionId) {
            const db = firebase.firestore();
            const galleryId = submissionData.galleryId;
            
            const galleryUpdate = {
                // Submission status for dashboard filtering
                submissionStatus: 'submitted',
                
                // Rating summary for dashboard display
                clientRatings: submissionData.ratingCounts,
                
                // Progress info for dashboard
                submissionProgress: {
                    totalPhotos: submissionData.totalPhotos,
                    ratedPhotos: submissionData.ratedPhotos,
                    completionPercentage: submissionData.completionPercentage,
                    lastActivity: firebase.firestore.FieldValue.serverTimestamp(),
                    submittedAt: firebase.firestore.FieldValue.serverTimestamp()
                },
                
                // Submission metadata
                submissionData: {
                    submissionId: submissionId,
                    submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    clientUserId: submissionData.userId,
                    isReviewed: false
                },
                
                // Unfreeze for photographer
                freezeStatus: 'unfrozen',
                clientInteractionCompleted: true
            };
            
            // Update galleries collection
            await db.collection('galleries').doc(galleryId).update(galleryUpdate);
            
            console.log('üìä Updated gallery status for dashboard');
        }
        
        // 5. COMPLETE GALLERY LOCKDOWN
        function completeGalleryLockdown(submissionData, submissionId) {
       
            console.log('üîí Enabling gallery lockdown and confirmation view...');
            storeSubmissionDataLocally(submissionData, submissionId);
            transformToConfirmationView(submissionData);
            console.log('‚úÖ Gallery transformed to confirmation view');
        }
        
        // HELPER FUNCTIONS FOR LOCKDOWN
        function storeSubmissionDataLocally(submissionData, submissionId) {
            const galleryId = getGalleryId();
            const storageData = {
                submissionId: submissionId,
                submittedAt: submissionData.submittedAt.toISOString(),
                ratedPhotos: submissionData.ratedPhotos,
                totalPhotos: submissionData.totalPhotos,
                completionPercentage: submissionData.completionPercentage,
                ratingCounts: submissionData.ratingCounts,
                timestamp: Date.now()
            };
            localStorage.setItem(`submission_data_${galleryId}`, JSON.stringify(storageData));
            localStorage.setItem(`gallery_submitted_${galleryId}`, submissionId);
        }
        
        function disableAllRatingInteractions() {
            // Disable thumbnail rating overlays
       
            console.log('üö´ Disabling all rating interactions...');
            
            // Hide thumbnail rating overlays
            document.querySelectorAll('.thumbnail-rating-overlay').forEach(overlay => {
                overlay.style.display = 'none';
            });
            
            // Remove event listeners by cloning elements
            document.querySelectorAll('.rating-btn, .thumbnail-rating-btn').forEach(btn => {
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
                
                // Disable the new button
                newBtn.style.pointerEvents = 'none';
                newBtn.style.opacity = '0.5';
                newBtn.style.cursor = 'not-allowed';
                newBtn.disabled = true;
            });
            
            // Set global flag
            window.ratingsDisabled = true;
            
            console.log('üö´ All rating interactions disabled');
        }
        
      
        function markButtonAsSubmitted(submissionId, timestamp) {
          
            const submitBtn = document.getElementById('submitSnapSelectionsBtn');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.style.cursor = 'not-allowed';
                submitBtn.style.backgroundColor = '#d4edda';
                submitBtn.style.borderColor = '#28a745';
                submitBtn.style.color = '#155724';
                
                // Update button content
                submitBtn.innerHTML = `
                    <i class="fas fa-check-circle" style="color: #28a745;"></i>
                    <span class="button-text">‚úÖ Submitted</span>
                `;
                
                // SAFE timestamp handling using existing function
                const displayDate = formatTimestampSafely(timestamp);
                
                // Update tooltip with safe date
                submitBtn.title = `Submitted ${displayDate}`;
            }
        }
        
        function addSubmissionOverlay(submissionData) {
            // Check if overlay already exists
    
        // Check if overlay already exists
            if (document.getElementById('submissionOverlay')) return;
            
            const overlay = document.createElement('div');
            overlay.id = 'submissionOverlay';
            overlay.className = 'submission-overlay';
            
            // SAFE timestamp formatting
            const submittedTime = formatTimestampSafely(submissionData.submittedAt);
            
            const banner = document.createElement('div');
            banner.className = 'submission-banner';
            banner.innerHTML = `
                <div class="submission-success-icon">‚úÖ</div>
                <div class="submission-message">
                    <h3>Submission Successful!</h3>
                    <p>You have successfully submitted your photo selections.</p>
                </div>
                <div class="submission-details">
                    <div class="detail-item">
                        <strong>Photos Selected:</strong> ${submissionData.ratedPhotos}/${submissionData.totalPhotos}
                    </div>
                    <div class="detail-item">
                        <strong>Submitted:</strong> ${submittedTime}
                    </div>
                    <div class="detail-item">
                        <strong>Completion:</strong> ${submissionData.completionPercentage}%
                    </div>
                </div>
            `;
            
            overlay.appendChild(banner);
            document.body.appendChild(overlay);
            
            // Add click to close
            overlay.addEventListener('click', function() {
                overlay.style.display = 'none';
            });
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 10000);
        }
        
        // 6. GENERATE UNIQUE SUBMISSION ID
        function generateSubmissionId() {
            const timestamp = Date.now();
            const random = Math.random().toString(36).substring(2, 8).toUpperCase();
            return `SUB_${timestamp}_${random}`;
        }
        
        // 7. SHOW REAL SUCCESS (REPLACE FAKE SUCCESS)
        function showRealSubmissionSuccess(submissionData, submissionId) {
            const modalContent = document.querySelector('.submission-modal-content');
            
            modalContent.innerHTML = `
                <div class="success-content">
                    <div class="success-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h2>Submission Successful!</h2>
                    <p>Your photo selections have been submitted successfully.</p>
                    <div class="success-details">
                        <p><strong>Submission ID:</strong> ${submissionId}</p>
                        <p><strong>Photos Selected:</strong> ${submissionData.ratedPhotos}/${submissionData.totalPhotos}</p>
                        <p><strong>Completion:</strong> ${submissionData.completionPercentage}%</p>
                       
                        <p><strong>Submitted:</strong> ${formatTimestampSafely(submissionData.submittedAt)}</p>
                    </div>
                    <div class="success-note">
                        <p><strong>What's Next?</strong><br>
                        Your photographer will be notified of your selections and will contact you about the next steps.</p>
                    </div>
                    <button class="modal-btn modal-btn-primary" onclick="closeSubmissionModal()">
                        <i class="fas fa-check"></i> Close
                    </button>
                </div>
            `;
        }
        
        // 8. SHOW SUBMISSION ERROR
        function showSubmissionError(errorMessage) {
            const modalContent = document.querySelector('.submission-modal-content');
            
            modalContent.innerHTML = `
                <div class="error-content">
                    <div class="error-icon">
                        <i class="fas fa-exclamation-circle"></i>
                    </div>
                    <h2>Submission Failed</h2>
                    <p>There was an error submitting your selections.</p>
                    <div class="error-details">
                        <p><strong>Error:</strong> ${errorMessage}</p>
                    </div>
                    <div class="error-actions">
                        <button class="modal-btn modal-btn-primary" onclick="location.reload()">
                            <i class="fas fa-refresh"></i> Retry
                        </button>
                        <button class="modal-btn modal-btn-secondary" onclick="closeSubmissionModal()">
                            <i class="fas fa-times"></i> Close
                        </button>
                    </div>
                </div>
            `;
        }

        // SUBMISSION CONFIRMATION VIEW IMPLEMENTATION
        
        // 1. Transform gallery to read-only mode after submission
        function transformToConfirmationView(submissionData) {
            console.log('üîÑ Transforming gallery to confirmation view...');
            
            // 1. Update page title and header
            updatePageHeaderForConfirmation(submissionData);
            
            // 2. Add submission summary banner
            addSubmissionSummaryBanner(submissionData);
            
            // 3. Transform photo grid to show selections clearly
            transformPhotoGridForConfirmation();
            
            // 4. Remove all interactive rating elements
            removeAllRatingInteractions();
            
            // 5. Update lightbox for view-only mode
            setupViewOnlyLightbox();
            
            // 6. Add contact message
            addContactPhotographerMessage();
            
            console.log('‚úÖ Gallery transformed to confirmation view');
        }
        
        // 2. Update page header with confirmation status
        function updatePageHeaderForConfirmation(submissionData) {
            // Update page title
            document.title = 'Selection Confirmed - SnapSelect';
            
            // Add confirmation indicator to studio info
            const studioInfo = document.getElementById('studioInfo');
            if (studioInfo) {
                // Add confirmation badge
                const confirmationBadge = document.createElement('div');
                confirmationBadge.className = 'confirmation-badge';
                confirmationBadge.innerHTML = `
                    <i class="fas fa-check-circle"></i>
                    <span>Selections Submitted</span>
                `;
                
                studioInfo.insertBefore(confirmationBadge, studioInfo.firstChild);
            }
        }
        
        // 3. Add submission summary banner at top
        function addSubmissionSummaryBanner(submissionData) {
            const galleryContainer = document.getElementById('galleryContainer');
            const photosGrid = document.getElementById('photosGrid');
            
            const summaryBanner = document.createElement('div');
            summaryBanner.className = 'submission-summary-banner';
            summaryBanner.innerHTML = `
                <div class="summary-header">
                    <div class="summary-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="summary-content">
                        <h3>Your Photo Selections Have Been Submitted</h3>
                        <p>Thank you for submitting your photo selections. Your photographer has been notified.</p>
                    </div>
                </div>
                
                <div class="summary-stats">
                    <div class="stat-card">
                        <div class="stat-number">${submissionData.ratedPhotos}</div>
                        <div class="stat-label">Photos Selected</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${submissionData.totalPhotos}</div>
                        <div class="stat-label">Total Photos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${submissionData.completionPercentage}%</div>
                        <div class="stat-label">Completion</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${formatTimestampSafely(submissionData.submittedAt)}</div>
                        <div class="stat-label">Submitted</div>
                    </div>
                </div>
                
                <div class="selection-breakdown">
                    <h4>Your Selections:</h4>
                    <div class="breakdown-grid">
                        <div class="breakdown-item">
                            <span class="breakdown-emoji">‚ù§Ô∏è</span>
                            <span class="breakdown-label">Must Have</span>
                            <span class="breakdown-count">${getRatingCount('heart')}</span>
                        </div>
                        <div class="breakdown-item">
                            <span class="breakdown-emoji">üëç</span>
                            <span class="breakdown-label">Would Like</span>
                            <span class="breakdown-count">${getRatingCount('thumbsUp')}</span>
                        </div>
                        <div class="breakdown-item">
                            <span class="breakdown-emoji">ü§î</span>
                            <span class="breakdown-label">Alternative</span>
                            <span class="breakdown-count">${getRatingCount('thinking')}</span>
                        </div>
                        <div class="breakdown-item">
                            <span class="breakdown-emoji">üëé</span>
                            <span class="breakdown-label">Not Interested</span>
                            <span class="breakdown-count">${getRatingCount('thumbsDown')}</span>
                        </div>
                    </div>
                </div>
            `;
            
            // Insert before photos grid
            galleryContainer.insertBefore(summaryBanner, photosGrid);
        }
        
        // 4. Transform photo grid to highlight selections
        function transformPhotoGridForConfirmation() {
            console.log('üñºÔ∏è Transforming photo grid for confirmation view...');
            
            // Re-render all photos with selection indicators
            const photosGrid = document.getElementById('photosGrid');
            if (!photosGrid || !allGalleryPhotos) return;
            
            // Clear existing grid
            photosGrid.innerHTML = '';
            
            // Group photos by rating for better organization
            const photosByRating = {
                heart: [],
                thumbsUp: [],
                thinking: [],
                thumbsDown: [],
                unrated: []
            };
            
            allGalleryPhotos.forEach(photo => {
                const photoId = photo.id || photo.url;
                const rating = photoRatings[photoId];
                
                if (rating && photosByRating[rating]) {
                    photosByRating[rating].push(photo);
                } else {
                    photosByRating.unrated.push(photo);
                }
            });
            
            // Create sections for each rating type (only if they have photos)
            const ratingConfig = [
                { key: 'heart', title: 'Must Have Photos', emoji: '‚ù§Ô∏è', color: '#e74c3c' },
                { key: 'thumbsUp', title: 'Would Like to Have', emoji: 'üëç', color: '#3498db' },
                { key: 'thinking', title: 'Alternative Options', emoji: 'ü§î', color: '#f39c12' },
                { key: 'thumbsDown', title: 'Not Interested', emoji: 'üëé', color: '#95a5a6' }
            ];
            
            ratingConfig.forEach(config => {
                const photos = photosByRating[config.key];
                if (photos.length > 0) {
                    createRatingSection(photosGrid, config, photos);
                }
            });
            
            // Add unrated photos at the end if any
            if (photosByRating.unrated.length > 0) {
                createRatingSection(photosGrid, {
                    key: 'unrated',
                    title: 'Other Photos',
                    emoji: 'üì∑',
                    color: '#bdc3c7'
                }, photosByRating.unrated);
            }
        }
        
        // 5. Create rating section for grouped photos
        function createRatingSection(container, config, photos) {
            const section = document.createElement('div');
            section.className = 'rating-section';
            
            const sectionHeader = document.createElement('div');
            sectionHeader.className = 'rating-section-header';
            sectionHeader.innerHTML = `
                <div class="section-title">
                    <span class="section-emoji">${config.emoji}</span>
                    <h3>${config.title}</h3>
                    <span class="section-count">(${photos.length})</span>
                </div>
                <div class="section-line" style="background-color: ${config.color}"></div>
            `;
            
            const sectionGrid = document.createElement('div');
            sectionGrid.className = 'photos-grid rating-section-grid';
            
            // Add photos to this section
            photos.forEach(photo => {
                const photoElement = createConfirmationPhotoElement(photo, config);
                sectionGrid.appendChild(photoElement);
            });
            
            section.appendChild(sectionHeader);
            section.appendChild(sectionGrid);
            container.appendChild(section);
        }
        
        // 6. Create photo element for confirmation view
        function createConfirmationPhotoElement(photo, ratingConfig) {
            const photoItem = document.createElement('div');
            photoItem.className = 'photo-item confirmation-photo';
            
            const photoId = photo.id || photo.url;
            photoItem.setAttribute('data-photo-id', photoId);
            
            const photoContainer = document.createElement('div');
            photoContainer.className = 'photo-container';
            photoContainer.style.backgroundImage = `url(${photo.thumbnailUrl || photo.url})`;
            
            // Add selection indicator overlay
            const selectionOverlay = document.createElement('div');
            selectionOverlay.className = 'selection-overlay';
            selectionOverlay.style.backgroundColor = `${ratingConfig.color}20`; // 20% opacity
            
            const selectionBadge = document.createElement('div');
            selectionBadge.className = 'selection-badge';
            selectionBadge.style.backgroundColor = ratingConfig.color;
            selectionBadge.innerHTML = `
                <span class="badge-emoji">${ratingConfig.emoji}</span>
                <span class="badge-text">SELECTED</span>
            `;
            
            photoContainer.appendChild(selectionOverlay);
            photoContainer.appendChild(selectionBadge);
            
            const photoDetails = document.createElement('div');
            photoDetails.className = 'photo-details';
            
            const photoName = document.createElement('div');
            photoName.className = 'photo-name';
            photoName.textContent = photo.name || 'Photo';
            
            const photoDate = document.createElement('div');
            photoDate.className = 'photo-date';
            if (photo.uploadedAt) {
                const date = photo.uploadedAt.toDate ? photo.uploadedAt.toDate() : new Date(photo.uploadedAt);
                photoDate.textContent = date.toLocaleDateString();
            }
            
            photoDetails.appendChild(photoName);
            photoDetails.appendChild(photoDate);
            
            photoItem.appendChild(photoContainer);
            photoItem.appendChild(photoDetails);
            
            // Make photo clickable for lightbox (view only)
            photoContainer.addEventListener('click', function() {
                openViewOnlyLightbox(photo);
            });
            
            return photoItem;
        }
        
        // 7. Remove all rating interactions
        function removeAllRatingInteractions() {
            console.log('üö´ Removing all rating interactions...');
            
            // Hide rating summary
            const ratingSummary = document.getElementById('ratingSummary');
            if (ratingSummary) {
                ratingSummary.style.display = 'none';
            }
            
            // Remove submit button
            const submitBtn = document.getElementById('submitSnapSelectionsBtn');
            if (submitBtn) {
                submitBtn.style.display = 'none';
            }
            
            // Remove any remaining rating overlays
            document.querySelectorAll('.thumbnail-rating-overlay').forEach(el => el.remove());
            document.querySelectorAll('.rating-btn').forEach(el => el.remove());
            document.querySelectorAll('.thumbnail-rating-btn').forEach(el => el.remove());
            
            // Set global flag
            window.ratingsDisabled = true;
        }
        
        // 8. Setup view-only lightbox
        function setupViewOnlyLightbox() {
            // This will be used by openViewOnlyLightbox function
            window.lightboxMode = 'view-only';
        }
        
        // 9. Open lightbox in view-only mode
        function openViewOnlyLightbox(photo) {
            // Similar to regular lightbox but without rating controls
            const lightbox = document.createElement('div');
            lightbox.className = 'photo-lightbox view-only-lightbox';
            lightbox.id = 'photoLightbox';
            
            // Find current photo index
            const currentIndex = allGalleryPhotos.findIndex(p => 
                p.url === photo.url || (p.id && p.id === photo.id)
            );
            
            const photoId = photo.id || photo.url;
            const photoRating = photoRatings[photoId];
            
            // Add status indicator if photo is selected
            if (photoRating) {
                const statusIndicator = document.createElement('div');
                statusIndicator.className = 'lightbox-status-indicator';
                statusIndicator.innerHTML = `
                    <div class="status-badge">
                        <span class="status-emoji">${getRatingEmoji(photoRating)}</span>
                        <span class="status-text">SELECTED: ${getRatingLabel(photoRating)}</span>
                    </div>
                `;
                lightbox.appendChild(statusIndicator);
            }
            
            // Add toolbar (without rating controls)
            const toolbar = document.createElement('div');
            toolbar.className = 'lightbox-toolbar';
            
            // Close button only
            const closeButton = document.createElement('button');
            closeButton.className = 'modal-button';
            closeButton.innerHTML = '<i class="fas fa-times"></i>';
            closeButton.setAttribute('aria-label', 'Close');
            closeButton.addEventListener('click', function(e) {
                e.stopPropagation();
                closeLightbox();
            });
            toolbar.appendChild(closeButton);
            
            lightbox.appendChild(toolbar);
            
            // Create image container (same as regular lightbox but no rating controls)
            const imageContainer = document.createElement('div');
            imageContainer.className = 'lightbox-image-container';
            
            const img = document.createElement('img');
            img.className = 'lightbox-image fadeIn';
            img.src = photo.url;
            img.dataset.index = currentIndex;
            img.alt = photo.name || 'Gallery photo';
            img.draggable = false;
            
            // Add watermark overlay (same as before)
            const watermarkOverlay = document.createElement('div');
            watermarkOverlay.className = 'image-watermark';
            imageContainer.appendChild(watermarkOverlay);
            
            // Add watermark text (same as before)
            const watermarkText = document.createElement('div');
            watermarkText.className = 'watermark-text';
            watermarkText.textContent = 'SnapSelect ¬© 2025';
            imageContainer.appendChild(watermarkText);
            
            // Add protection layer (same as before)
            const protectionLayer = document.createElement('div');
            protectionLayer.className = 'protection-layer';
            protectionLayer.addEventListener('click', function(e) {
                e.stopPropagation();
            });
            imageContainer.appendChild(protectionLayer);
            
            imageContainer.appendChild(img);
            
            // Add navigation if multiple photos
            if (currentIndex > 0) {
                const prevButton = document.createElement('button');
                prevButton.className = 'modal-nav-button modal-prev';
                prevButton.innerHTML = '<i class="fas fa-chevron-left"></i>';
                prevButton.addEventListener('click', function(e) {
                    e.stopPropagation();
                    navigateToPhotoViewOnly(currentIndex - 1, lightbox, imageContainer);
                });
                imageContainer.appendChild(prevButton);
            }
            
            if (currentIndex < allGalleryPhotos.length - 1) {
                const nextButton = document.createElement('button');
                nextButton.className = 'modal-nav-button modal-next';
                nextButton.innerHTML = '<i class="fas fa-chevron-right"></i>';
                nextButton.addEventListener('click', function(e) {
                    e.stopPropagation();
                    navigateToPhotoViewOnly(currentIndex + 1, lightbox, imageContainer);
                });
                imageContainer.appendChild(nextButton);
            }
            
            lightbox.appendChild(imageContainer);
            
            // Add keyboard navigation
            lightbox.addEventListener('keydown', function(e) {
                switch (e.key) {
                    case 'Escape':
                        closeLightbox();
                        break;
                    case 'ArrowLeft':
                        if (currentIndex > 0) {
                            navigateToPhotoViewOnly(currentIndex - 1, lightbox, imageContainer);
                        }
                        break;
                    case 'ArrowRight':
                        if (currentIndex < allGalleryPhotos.length - 1) {
                            navigateToPhotoViewOnly(currentIndex + 1, lightbox, imageContainer);
                        }
                        break;
                }
            });
            
            // Close on background click
            lightbox.addEventListener('click', function(e) {
                if (e.target === lightbox) {
                    closeLightbox();
                }
            });
            
            document.body.appendChild(lightbox);
            lightbox.focus();
        }
        
        // 10. Navigation for view-only lightbox
        function navigateToPhotoViewOnly(index, lightbox, imageContainer) {
            if (index < 0 || index >= allGalleryPhotos.length) return;
            
            const currentImg = lightbox.querySelector('.lightbox-image');
            currentImg.classList.add('fadeOut');
            
            setTimeout(() => {
                const newPhoto = allGalleryPhotos[index];
                const photoId = newPhoto.id || newPhoto.url;
                const photoRating = photoRatings[photoId];
                
                currentImg.src = newPhoto.url;
                currentImg.dataset.index = index;
                currentImg.alt = newPhoto.name || 'Gallery photo';
                
                // Update status indicator
                const statusIndicator = lightbox.querySelector('.lightbox-status-indicator');
                if (photoRating) {
                    if (!statusIndicator) {
                        const newStatusIndicator = document.createElement('div');
                        newStatusIndicator.className = 'lightbox-status-indicator';
                        lightbox.insertBefore(newStatusIndicator, lightbox.firstChild);
                    }
                    const indicator = lightbox.querySelector('.lightbox-status-indicator');
                    indicator.innerHTML = `
                        <div class="status-badge">
                            <span class="status-emoji">${getRatingEmoji(photoRating)}</span>
                            <span class="status-text">SELECTED: ${getRatingLabel(photoRating)}</span>
                        </div>
                    `;
                } else if (statusIndicator) {
                    statusIndicator.remove();
                }
                
                // Update navigation buttons
                const prevButton = lightbox.querySelector('.modal-prev');
                const nextButton = lightbox.querySelector('.modal-next');
                
                if (prevButton) prevButton.remove();
                if (nextButton) nextButton.remove();
                
                if (index > 0) {
                    const newPrevButton = document.createElement('button');
                    newPrevButton.className = 'modal-nav-button modal-prev';
                    newPrevButton.innerHTML = '<i class="fas fa-chevron-left"></i>';
                    newPrevButton.addEventListener('click', function(e) {
                        e.stopPropagation();
                        navigateToPhotoViewOnly(index - 1, lightbox, imageContainer);
                    });
                    imageContainer.appendChild(newPrevButton);
                }
                
                if (index < allGalleryPhotos.length - 1) {
                    const newNextButton = document.createElement('button');
                    newNextButton.className = 'modal-nav-button modal-next';
                    newNextButton.innerHTML = '<i class="fas fa-chevron-right"></i>';
                    newNextButton.addEventListener('click', function(e) {
                        e.stopPropagation();
                        navigateToPhotoViewOnly(index + 1, lightbox, imageContainer);
                    });
                    imageContainer.appendChild(newNextButton);
                }
                
                currentImg.classList.remove('fadeOut');
                currentImg.classList.add('fadeIn');
            }, 300);
        }
        
        // 11. Add contact photographer message
        function addContactPhotographerMessage() {
            const galleryContainer = document.getElementById('galleryContainer');
            
            const contactMessage = document.createElement('div');
            contactMessage.className = 'contact-photographer-message';
            contactMessage.innerHTML = `
                <div class="contact-icon">
                    <i class="fas fa-phone"></i>
                </div>
                <div class="contact-content">
                    <h4>Need to Make Changes?</h4>
                    <p>If you need to modify your selections, please contact your photographer directly.</p>
                    <div class="contact-info">
                        <p><strong>Studio:</strong> <span id="contact-studio-name">Loading...</span></p>
                        <p><strong>Contact:</strong> <span id="contact-details">Loading...</span></p>
                    </div>
                </div>
            `;
            
            galleryContainer.appendChild(contactMessage);
            
            // Update contact info from studio data
            updateContactInfo();
        }
        
        // 12. Update contact information
        function updateContactInfo() {
            const studioNameElement = document.getElementById('studioName');
            const studioContactElement = document.getElementById('studioContact');
            
            const contactStudioName = document.getElementById('contact-studio-name');
            const contactDetails = document.getElementById('contact-details');
            
            if (studioNameElement && contactStudioName) {
                contactStudioName.textContent = studioNameElement.textContent;
            }
            
            if (studioContactElement && contactDetails) {
                contactDetails.textContent = studioContactElement.textContent;
            }
        }
        
        // Helper functions
        function getRatingCount(ratingType) {
            return Object.values(photoRatings).filter(rating => rating === ratingType).length;
        }
        
        // Modified checkExistingSubmission to use confirmation view
        function checkExistingSubmissionWithConfirmation() {
            const galleryId = getGalleryId();
            const submissionFlag = localStorage.getItem(`gallery_submitted_${galleryId}`);
            
            if (submissionFlag) {
                console.log('üîç Existing submission detected, setting up confirmation view...');
                
                // Get stored submission data
                const storedData = localStorage.getItem(`submission_data_${galleryId}`);
                
                if (storedData) {
                    try {
                        const submissionData = JSON.parse(storedData);
                        
                        // Transform to confirmation view
                        window.ratingsDisabled = true;
                        transformToConfirmationView(submissionData);
                        
                        console.log('‚úÖ Confirmation view activated');
                        return true;
                    } catch (error) {
                        console.warn('Stored submission data corrupted, clearing...');
                        localStorage.removeItem(`submission_data_${galleryId}`);
                        localStorage.removeItem(`gallery_submitted_${galleryId}`);
                    }
                }
            }
            
            return false;
        }


        // Add this function after line 1206 (after getUserIdentifier function)
        async function checkExistingSubmissionWithFirebase() {
            const galleryId = getGalleryId();
            const userId = getUserIdentifier();
            
            // First check localStorage (fast)
            const localSubmission = localStorage.getItem(`gallery_submitted_${galleryId}`);
            if (localSubmission) {
                console.log('‚úÖ Using localStorage submission data');
                return; // Exit early - existing logic will handle this
            }
            
            // If no localStorage, check Firebase (cross-browser sync)
            try {
                const db = firebase.firestore();
                const snapshot = await db.collection('clientSubmissions')
                    .where('galleryId', '==', galleryId)
                    .where('userId', '==', userId)
                    .where('status', '==', 'submitted')
                    .limit(1)
                    .get();
                
                if (!snapshot.empty) {
                    console.log('üîÑ Found submission in Firebase, syncing to localStorage...');
                    const submissionData = snapshot.docs[0].data();
                    
                    // Sync to localStorage for future visits
                    const localData = {
                        submissionId: submissionData.submissionId,
                        submittedAt: submissionData.clientSubmittedAt.toDate().toISOString(),
                        ratedPhotos: submissionData.ratedPhotos,
                        totalPhotos: submissionData.totalPhotos,
                        completionPercentage: submissionData.completionPercentage,
                        ratingCounts: submissionData.ratingCounts,
                        timestamp: Date.now()
                    };
                    
                    localStorage.setItem(`submission_data_${galleryId}`, JSON.stringify(localData));
                    localStorage.setItem(`gallery_submitted_${galleryId}`, submissionData.submissionId);
                    
                    // Trigger confirmation view
                    window.ratingsDisabled = true;
                    transformToConfirmationView(localData);
                    
                    console.log('‚úÖ Cross-browser sync completed');
                }
            } catch (error) {
                console.error('‚ùå Firebase submission check failed:', error);
            }
        }
        
    </script>
</body>
</html>
