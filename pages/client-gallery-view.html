<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer" />

   <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    img-src * data: https://*.firebasestorage.app https://firebasestorage.googleapis.com;
    style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com;
    script-src 'self' 'unsafe-inline' https://www.gstatic.com;
    font-src 'self' https://cdnjs.cloudflare.com;
    connect-src 'self' https://firestore.googleapis.com https://*.googleapis.com https://*.firebasestorage.app https://firebasestorage.googleapis.com;
    font-src 'self' https://cdnjs.cloudflare.com https://use.fontawesome.com;
    ">
    <title>Shared Gallery - SnapSelect</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Basic styles */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* Header */
        header {
            background-color: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 15px 0;
        }
        
        .logo-text {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
        }

        
        /* Password screen */
        .password-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 30px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .password-input {
            width: 100%;
            padding: 12px;
            margin: 15px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        .btn {
            padding: 12px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .error-message {
            color: #e74c3c;
            margin: 10px 0;
            display: none;
        }
        
        /* Gallery container */
        .gallery-container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 20px;
        }
        
        /* Photo grid */
        .photos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .photo-item {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        
        .photo-item:hover {
            transform: translateY(-5px);
        }
        
        .photo-container {
            height: 200px;
            width: 100%;
            background-size: cover;
            background-position: center;
            position: relative;
            cursor: pointer;
        }
        
        .photo-details {
            padding: 12px;
        }
        
        .photo-name {
            font-weight: 500;
            margin-bottom: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .photo-date {
            font-size: 12px;
            color: #777;
        }

        
        /* Toast notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .toast {
            padding: 12px 20px;
            margin-bottom: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            color: white;
            animation: slideIn 0.3s ease;
        }
        
        .toast-success {
            background-color: #27ae60;
        }
        
        .toast-error {
            background-color: #e74c3c;
        }
        
        .toast-info {
            background-color: #3498db;
        }
        
        .toast.fadeOut {
            animation: fadeOut 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        /* Welcome Dashboard Styles */
        .welcome-dashboard {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }
        
        .welcome-container {
            background-color: white;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        
        .welcome-container h1 {
            color: #3498db;
            text-align: center;
            margin-bottom: 25px;
            font-size: 28px;
        }
        
        .welcome-content {
            margin-bottom: 30px;
        }
        
        .welcome-section {
            margin-bottom: 25px;
        }
        
        .welcome-section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 22px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }
        
        .welcome-section p {
            line-height: 1.6;
            color: #555;
        }
        
        .rating-guide {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
        }
        
        .rating-explanation {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .rating-item {
            display: flex;
            align-items: center;
        }
        
        .rating-emoji {
            font-size: 36px;
            margin-right: 15px;
        }
        
        .rating-info h3 {
            margin: 0 0 5px 0;
            font-size: 18px;
            color: #333;
        }
        
        .rating-info p {
            margin: 0;
            font-size: 14px;
            color: #666;
        }
        
        .welcome-actions {
            text-align: center;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
            padding: 12px 30px;
            font-size: 18px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .welcome-skip {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .checkbox {
            margin-right: 8px;
        }

        
        @media (max-width: 768px) {
            .welcome-container {
                padding: 20px;
                width: 95%;
            }
            
            .rating-explanation {
                grid-template-columns: 1fr;
            }
        }
        
        /* Loading spinner */
        .loading-indicator {
            text-align: center;
            margin: 100px auto;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Footer */
        footer {
            margin-top: 50px;
            padding: 20px 0;
            background-color: #f9f9f9;
            text-align: center;
            color: #777;
            font-size: 14px;
        }
        
        /* Accessibility improvements */
        .photo-item:focus-within {
            outline: 3px solid #3498db;
        }
        
        .photo-container:focus {
            outline: none;
            box-shadow: inset 0 0 0 3px #3498db;
        }
        
        /* Error page */
        .error-page {
            text-align: center;
            max-width: 600px;
            margin: 100px auto;
            padding: 30px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none;
        }
        
        .error-icon {
            font-size: 48px;
            color: #e74c3c;
            margin-bottom: 20px;
        }
        
        .retry-btn {
            margin-top: 20px;
        }
        
        /* Studio information */
        .studio-info {
            margin-bottom: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .studio-info h2 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #333;
        }
        
        .studio-info p {
            margin: 5px 0;
            color: #666;
        }
        
        .studio-info .contact {
            margin-top: 15px;
            font-size: 14px;
            color: #777;
        }
                /* Photo lightbox and enhanced features */
        .photo-lightbox {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .lightbox-image-container {
            position: relative;
            height: 70%;
            width: 80%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        .lightbox-image {
            max-height: 100%;
            max-width: 100%;
            object-fit: contain;
            transition: all 0.3s ease;
        }
        
        .lightbox-toolbar {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 15px;
            z-index: 1001;
        }
        
        .modal-button {
            background-color: rgba(255, 255, 255, 0.3);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .modal-button:hover {
            background-color: rgba(255, 255, 255, 0.5);
        }
        
        .modal-nav-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(255, 255, 255, 0.3);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
            z-index: 1001;
        }
        
        .modal-nav-button:hover {
            background-color: rgba(255, 255, 255, 0.5);
        }
        
        .modal-prev {
            left: 20px;
        }
        
        .modal-next {
            right: 20px;
        }
        
        .thumbnails-container {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            height: 90px;
            display: flex;
            overflow-x: auto;
            background-color: rgba(0,0,0,0.7);
            padding: 15px 0;
            justify-content: center;
        }
        
        .thumbnail {
            height: 60px;
            margin: 0 5px;
            border: 2px solid transparent;
            cursor: pointer;
            opacity: 0.6;
            transition: all 0.2s ease;
        }
        
        .thumbnail:hover {
            opacity: 0.9;
            transform: translateY(-3px);
        }
        
        .thumbnail.active {
            border-color: #3498db;
            opacity: 1;
        }
        
        .zoom-controls {
            position: absolute;
            bottom: 130px;
            right: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 1001;
        }
        
        .zoom-btn {
            background-color: rgba(255, 255, 255, 0.3);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            margin: 5px 0;
            font-size: 16px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
        
        .zoom-btn:hover {
            background-color: rgba(255, 255, 255, 0.5);
        }
        
        .rating-container {
            position: absolute;
            bottom: 130px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            background-color: rgba(0,0,0,0.5);
            padding: 10px 20px;
            border-radius: 30px;
            z-index: 1001;
        }
        
        .rating-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.2s;
            padding: 5px;
        }
        
        .rating-btn:hover, .rating-btn.selected {
            opacity: 1;
            transform: scale(1.2);
        }
        
        .rating-summary {
            position: fixed;
            top: 20px;
            left: 20px;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 10px 15px;
            border-radius: 8px;
            display: flex;
            gap: 15px;
            z-index: 999;
        }
        
        .rating-count {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .image-watermark {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.2"><text x="10" y="50" font-family="Arial" font-size="10" fill="white" transform="rotate(-45 50 50)">SnapSelect</text></svg>');
            pointer-events: none;
            z-index: 1;
        }
        
        .watermark-text {
            position: absolute;
            bottom: 5px;
            right: 10px;
            color: rgba(255, 255, 255, 0.3);
            font-size: 12px;
            pointer-events: none;
        }
        
        .protection-layer {
            position: absolute;
            inset: 0;
            z-index: 2;
            background-color: transparent;
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        .fadeIn {
            animation: fadeIn 0.3s ease-in-out forwards;
        }
        
        .fadeOut {
            animation: fadeOut 0.3s ease-in-out forwards;
        }
        
        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .modal-button {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
            
            .modal-nav-button {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
            
            .thumbnails-container {
                height: 70px;
            }
            
            .thumbnail {
                height: 40px;
            }
            
            .rating-container {
                bottom: 110px;
                gap: 10px;
            }
            
            .rating-btn {
                font-size: 20px;
            }
            
            .zoom-controls {
                bottom: 110px;
            }
        }
    </style>
</head>
<body>
    <!-- Welcome Dashboard (initially hidden) -->
    <div id="welcomeDashboard" class="welcome-dashboard" style="display: none;">
        <div class="welcome-container">
            <h1>Welcome to Your Photo Gallery</h1>
            <div class="welcome-content">
                <div class="welcome-section">
                    <h2>How to Use This Gallery</h2>
                    <p>This gallery allows you to view and rate photos. Your ratings help the photographer understand your preferences.</p>
                    <p>Navigate through photos by clicking on thumbnails or using the arrow keys. Zoom in and out for better viewing.</p>
                </div>
                
                <div class="welcome-section rating-guide">
                    <h2>Rating System Guide</h2>
                    <div class="rating-explanation">
                        <div class="rating-item">
                            <div class="rating-emoji">‚ù§Ô∏è</div>
                            <div class="rating-info">
                                <h3>Must Have</h3>
                                <p>Photos you absolutely want to include in your final selection.</p>
                            </div>
                        </div>
                        <div class="rating-item">
                            <div class="rating-emoji">üëç</div>
                            <div class="rating-info">
                                <h3>Would Like to Have</h3>
                                <p>Photos you prefer to include if possible.</p>
                            </div>
                        </div>
                        <div class="rating-item">
                            <div class="rating-emoji">ü§î</div>
                            <div class="rating-info">
                                <h3>Alternative Option</h3>
                                <p>Photos you're considering as secondary choices.</p>
                            </div>
                        </div>
                        <div class="rating-item">
                            <div class="rating-emoji">üëé</div>
                            <div class="rating-info">
                                <h3>Not Interested</h3>
                                <p>Photos you don't want to include.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="welcome-actions">
                <button id="startGalleryBtn" class="btn btn-primary">Begin Viewing Gallery</button>
                <div class="welcome-skip">
                    <input type="checkbox" id="dontShowAgain" class="checkbox">
                    <label for="dontShowAgain">Don't show this again</label>
                </div>
            </div>
        </div>
    </div>

    <div id="toastContainer" class="toast-container"></div>
    <div id="ratingSummary" class="rating-summary" style="display: none;">
        <div class="rating-count"><span>‚ù§Ô∏è</span><span id="heartCount">0</span></div>
        <div class="rating-count"><span>üëç</span><span id="thumbsUpCount">0</span></div>
        <div class="rating-count"><span>ü§î</span><span id="thinkingCount">0</span></div>
        <div class="rating-count"><span>üëé</span><span id="thumbsDownCount">0</span></div>
    </div>


    <header>
        <div class="container">
            <nav>
                <a href="../../index.html" class="logo">
                    <div class="logo-text">SnapSelect</div>
                </a>
            </nav>
        </div>
    </header>

    <main>
        <!-- Loading indicator -->
        <div id="loadingIndicator" class="loading-indicator">
            <div class="spinner"></div>
            <p>Loading gallery...</p>
        </div>
        
        <!-- Error page -->
        <div id="errorPage" class="error-page">
            <div class="error-icon">
                <i class="fas fa-exclamation-circle"></i>
            </div>
            <h2>Something went wrong</h2>
            <p id="errorMessage">We couldn't load the gallery. Please try again later.</p>
            <button id="retryBtn" class="btn retry-btn">Try Again</button>
        </div>
        
        <!-- Password protection screen (initially hidden) -->
        <div id="passwordScreen" class="password-container" style="display: none;">
            <h2 id="passwordGalleryTitle">Protected Gallery</h2>
            <p>This gallery is password protected. Please enter the password to view it.</p>
            <div id="passwordError" class="error-message">Incorrect password. Please try again.</div>
            <input type="password" id="galleryPassword" class="password-input" placeholder="Enter password" aria-label="Gallery password">
            <button id="submitPasswordBtn" class="btn">View Gallery</button>
        </div>
        
        <!-- Gallery container (initially hidden) -->
        <div id="galleryContainer" class="gallery-container" style="display: none;">
            <div id="studioInfo" class="studio-info">
                <h2 id="studioName">Photography Studio</h2>
                <p id="galleryTitle">Shared Gallery</p>
                <div class="contact">
                    <p id="studioContact">Contact information will appear here if available</p>
                </div>
            </div>
            
            <div id="photosGrid" class="photos-grid">
                <!-- Photos will be loaded here -->
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; <span id="currentYear">2025</span> SnapSelect. All rights reserved.</p>
        </div>
    </footer>
<!-- Firebase SDK Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <!-- Inline script to load the gallery -->
    <script>
        // Variable to store all gallery photos and ratings
        let allGalleryPhotos = [];
        let slideshowInterval = null; // For slideshow feature
        let photoRatings = {}; // Store ratings for each photo
        let ratingCounts = {
            heart: 0,
            thumbsUp: 0,
            thinking: 0,
            thumbsDown: 0
        };
        
        // Welcome dashboard functions
        function showWelcomeDashboard() {
            const welcomeDashboard = document.getElementById('welcomeDashboard');
            if (welcomeDashboard) {
                welcomeDashboard.style.display = 'flex';
            }
        }

        function hideWelcomeDashboard() {
            const welcomeDashboard = document.getElementById('welcomeDashboard');
            if (welcomeDashboard) {
                welcomeDashboard.style.display = 'none';
            }
        }

        function checkWelcomeDashboardPreference() {
            // Check if user has opted out of seeing the welcome screen
            return localStorage.getItem('dontShowWelcomeDashboard') !== 'true';
        }

        function setupWelcomeDashboard() {
            const startGalleryBtn = document.getElementById('startGalleryBtn');
            const dontShowAgainCheckbox = document.getElementById('dontShowAgain');
            
            if (startGalleryBtn) {
                startGalleryBtn.addEventListener('click', function() {
                    // Check if "don't show again" is checked
                    if (dontShowAgainCheckbox && dontShowAgainCheckbox.checked) {
                        localStorage.setItem('dontShowWelcomeDashboard', 'true');
                    }
                    
                    // Hide welcome dashboard
                    hideWelcomeDashboard();
                    
                    // Continue with gallery loading
                    if (checkGalleryAccess()) {
                        loadSharedGallery();
                    }
                });
            }
        }
        
        // Disable right-click
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            return false;
        }, false);

        // Disable keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Prevent Ctrl+S, Ctrl+U, Ctrl+P, Ctrl+Shift+I, F12
            if ((e.ctrlKey && ['s','u','p'].includes(e.key.toLowerCase())) || 
                (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'i') || 
                e.key === 'F12') {
                e.preventDefault();
                return false;
            }
        });

        // Disable drag and drop
        document.addEventListener('dragstart', function(e) {
            e.preventDefault();
            return false;
        });
        
        // Access control for client gallery
        function checkGalleryAccess() {
            // Get gallery parameters
            const urlParams = new URLSearchParams(window.location.search);
            
            // Look for different possible ID parameters
            const galleryId = urlParams.get('id') || urlParams.get('galleryId');
            const shareId = urlParams.get('share');
            
            // If no ID is present, can't proceed
            if (!galleryId && !shareId) {
                showPageError("Invalid gallery link. No gallery ID or share ID provided.");
                return false;
            }
            
            // If we have a direct gallery ID
            if (galleryId) {
                // Check if access has been granted via password
                const accessToken = sessionStorage.getItem(`gallery_access_${galleryId}`);
                
                if (!accessToken) {
                    console.log("Direct gallery access attempted without authentication");
                    // Look for the studio name and share ID
                    try {
                        const actualGalleryId = sessionStorage.getItem('actual_gallery_id') || galleryId;
                        findStudioAndShareInfo(actualGalleryId);
                        return false;
                    } catch (error) {
                        console.error("Error redirecting to password page:", error);
                        showPageError("Authentication error. Please try accessing through the shared link.");
                        return false;
                    }
                }
            }
            
            // If we have a share ID, we'll verify it during regular loading
            
            return true;
        }

        
        // Rating system functions
        function loadSavedRatings() {
            try {
                const savedRatings = localStorage.getItem('photoRatings');
                if (savedRatings) {
                    photoRatings = JSON.parse(savedRatings);
                    updateRatingCounts();
                }
            } catch (err) {
                console.error("Error loading saved ratings:", err);
            }
        }
        
        function updateRatingCounts() {
            // Reset counts
            ratingCounts = {
                heart: 0,
                thumbsUp: 0,
                thinking: 0,
                thumbsDown: 0
            };
            
            // Count each rating type
            Object.values(photoRatings).forEach(rating => {
                if (rating) ratingCounts[rating]++;
            });
            
            // Update display
            document.getElementById('heartCount').textContent = ratingCounts.heart;
            document.getElementById('thumbsUpCount').textContent = ratingCounts.thumbsUp;
            document.getElementById('thinkingCount').textContent = ratingCounts.thinking;
            document.getElementById('thumbsDownCount').textContent = ratingCounts.thumbsDown;
            
            // Show summary if we have any ratings
            const totalRatings = Object.values(ratingCounts).reduce((a, b) => a + b, 0);
            document.getElementById('ratingSummary').style.display = totalRatings > 0 ? 'flex' : 'none';
        }
        
        function setPhotoRating(photoId, rating) {
            // If same rating is clicked again, we'll unselect it
            if (photoRatings[photoId] === rating) {
                delete photoRatings[photoId]; // Remove rating
                showToast(`Rating removed`, 'info');
            } else {
                photoRatings[photoId] = rating;
                showToast(`Photo marked as ${getRatingLabel(rating)}`, 'success');
            }
            
            // Save to localStorage
            try {
                localStorage.setItem('photoRatings', JSON.stringify(photoRatings));
            } catch (err) {
                console.error("Error saving ratings:", err);
            }
            
            // Update counts
            updateRatingCounts();
        }
        
        function getRatingLabel(rating) {
            switch(rating) {
                case 'heart': return "Must Have";
                case 'thumbsUp': return "Would Like to Have";
                case 'thinking': return "Alternative Option";
                case 'thumbsDown': return "Not Interested";
                default: return "";
            }
        }
        
        function createRatingButton(emoji, label, ratingValue, photoId) {
            const btn = document.createElement('button');
            btn.className = 'rating-btn';
            btn.innerHTML = emoji;
            btn.setAttribute('aria-label', label);
            btn.setAttribute('data-rating', ratingValue);
            
            if (photoRatings[photoId] === ratingValue) {
                btn.classList.add('selected');
            }
            
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                
                // Update rating in storage
                setPhotoRating(photoId, ratingValue);
                
                // Update visual selection
                const ratingBtns = document.querySelectorAll('.rating-btn');
                ratingBtns.forEach(b => b.classList.remove('selected'));
                
                // Only add selected class if we didn't remove the rating
                if (photoRatings[photoId] === ratingValue) {
                    btn.classList.add('selected');
                }
            });
            
            return btn;
        }


        // Function to find studio and share information for a gallery
        function findStudioAndShareInfo(galleryId) {
            // If Firebase is available, look up the information
            if (typeof firebase !== 'undefined' && firebase.apps.length) {
                const db = firebase.firestore();
                
                // Find gallery shares for this gallery
                db.collection('galleryShares')
                    .where('galleryId', '==', galleryId)
                    .limit(1)
                    .get()
                    .then(snapshot => {
                        if (!snapshot.empty) {
                            const shareData = snapshot.docs[0].data();
                            const shareId = shareData.shareId;
                            
                            // Find the photographer
                            return db.collection('photographer')
                                .where('uid', '==', shareData.photographerId)
                                .limit(1)
                                .get()
                                .then(photoSnapshot => {
                                    if (!photoSnapshot.empty) {
                                        const photographerData = photoSnapshot.docs[0].data();
                                        const studioName = photographerData.studioName;
                                        
                                        // Redirect with studio name
                                        window.location.href = `/${studioName}/gallery/${shareId}`;
                                    } else {
                                        // Fallback to basic redirect
                                        window.location.href = `/client-gallery.html?share=${shareId}`;
                                    }
                                });
                        } else {
                            showPageError("Gallery access denied. Please use the shared link provided by the photographer.");
                        }
                    })
                    .catch(error => {
                        console.error("Error finding share info:", error);
                        showPageError("Error accessing gallery. Please try again later.");
                    });
            } else {
                showPageError("Gallery access denied. Firebase not initialized.");
            }
        }

        // Firebase initialization
        (function() {
            // Firebase configuration
            const firebaseConfig = {
                apiKey: "AIzaSyCAl15Yq8Y727PKknJNs0Q8UZbRRbcWkMo",
                authDomain: "snapselect01-eb74c.firebaseapp.com",
                projectId: "snapselect01-eb74c",
                storageBucket: "snapselect01-eb74c.firebasestorage.app",
                messagingSenderId: "749450852067",
                appId: "1:749450852067:web:8b1887075d607b3e91f7d6",
                measurementId: "G-J5XGE71VF6"
            };
            
            // Initialize Firebase
            try {
                if (firebase.apps.length === 0) {
                    firebase.initializeApp(firebaseConfig);
                    console.log("Firebase initialized successfully");
                }
                
                // Update current year in footer
                document.getElementById('currentYear').textContent = new Date().getFullYear();
                
                // Load saved ratings
                loadSavedRatings();
                
                // Setup welcome dashboard event listeners
                setupWelcomeDashboard();
                
                // Check if we should show welcome dashboard
                if (checkWelcomeDashboardPreference()) {
                    // Show welcome dashboard
                    showWelcomeDashboard();
                } else {
                    // Skip welcome dashboard and check access
                    if (checkGalleryAccess()) {
                        loadSharedGallery();
                    }
                }
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showError("Failed to initialize the gallery. Please try again later.");
            }
        })();

        
        // Load shared gallery
        function loadSharedGallery() {
            // Get gallery parameters
            const urlParams = new URLSearchParams(window.location.search);
            
            // Check for direct gallery ID first
            const directGalleryId = urlParams.get('id') || urlParams.get('galleryId');
            if (directGalleryId) {
                console.log("Direct gallery access with ID:", directGalleryId);
                loadGalleryDirect(directGalleryId);
                return;
            }
            
            // Otherwise, look for share ID
            const shareId = urlParams.get('share');
            
            if (!shareId) {
                showPageError("Invalid gallery link. No parameters provided.");
                return;
            }
            
            console.log("Looking for shared gallery with ID:", shareId);
            
            // Set a timeout for loading
            const loadingTimeout = setTimeout(() => {
                if (document.getElementById('loadingIndicator').style.display !== 'none') {
                    showPageError("Gallery is taking too long to load. Please try again later.");
                }
            }, 15000); // 15 seconds timeout
            
            // Get reference to Firestore
            const db = firebase.firestore();
            
            // Check first collection
            db.collection('galleryShares')
                .where('shareId', '==', shareId)
                .get()
                .then(snapshot => {
                    console.log("Query completed for galleryShares, found:", snapshot.size, "documents");
                    
                    if (snapshot.empty) {
                        console.log("No shares found in galleryShares, checking sharedGalleries...");
                        
                        // Try the alternative collection name
                        return db.collection('sharedGalleries')
                            .where('shareId', '==', shareId)
                            .get();
                    }
                    
                    // Clear the timeout since we found data
                    clearTimeout(loadingTimeout);
                    return snapshot;
                })
                .then(snapshot => {
                    if (snapshot.empty) {
                        showPageError("Gallery not found or access has been revoked.");
                        return;
                    }
                    
                    const sharedGallery = snapshot.docs[0].data();
                    console.log("Found shared gallery:", sharedGallery);
                    
                    // Store the actual gallery ID in session storage
                    sessionStorage.setItem('actual_gallery_id', sharedGallery.galleryId);
                    
                    // Hide loading indicator
                    document.getElementById('loadingIndicator').style.display = 'none';
                    
                    if (sharedGallery.passwordProtected) {
                        // Check if we already have access
                        const accessGranted = sessionStorage.getItem(`gallery_access_${shareId}`);
                        if (accessGranted) {
                            // Already authenticated, load gallery
                            loadGalleryContent(sharedGallery.galleryId, sharedGallery.photographerId);
                            return;
                        }
                        
                        // Show password screen
                        document.getElementById('passwordScreen').style.display = 'block';
                        
                        // Update password screen title if we have gallery info
                        updatePasswordScreenTitle(sharedGallery.galleryId);
                        
                        // Focus the password input for accessibility
                        document.getElementById('galleryPassword').focus();
                        
                        // Set up password form submission
                        setupPasswordHandling(sharedGallery, shareId);
                    } else {
                        // No password needed, load gallery directly
                        // First, store access in session storage
                        sessionStorage.setItem(`gallery_access_${shareId}`, 'granted');
                        
                        // Load gallery content
                        loadGalleryContent(sharedGallery.galleryId, sharedGallery.photographerId);
                    }
                })
                .catch(error => {
                    clearTimeout(loadingTimeout);
                    console.error("Error fetching shared gallery:", error);
                    showPageError("Error loading gallery: " + error.message);
                });
        }

        
        // Update the password screen title with gallery info if available
        function updatePasswordScreenTitle(galleryId) {
            try {
                const db = firebase.firestore();
                
                db.collection('galleries').doc(galleryId)
                    .get()
                    .then(doc => {
                        if (doc.exists) {
                            const gallery = doc.data();
                            const titleElement = document.getElementById('passwordGalleryTitle');
                            if (titleElement && gallery.name) {
                                titleElement.textContent = gallery.name;
                            }
                        }
                    })
                    .catch(error => {
                        console.error("Error fetching gallery for password screen:", error);
                    });
            } catch (error) {
                console.error("Error updating password screen title:", error);
            }
        }
        
        // Load gallery directly with ID
        function loadGalleryDirect(galleryId) {
            console.log("Loading gallery directly with ID:", galleryId);
            
            // Hide loading indicator
            document.getElementById('loadingIndicator').style.display = 'none';
            
            // Load gallery content
            loadGalleryContent(galleryId);
        }
        
        // Setup password handling
        function setupPasswordHandling(sharedGallery, shareId) {
            // Function to handle password submission
            const handlePasswordSubmit = function() {
                const password = document.getElementById('galleryPassword').value;
                const passwordError = document.getElementById('passwordError');
                
                // Hide previous errors
                passwordError.style.display = 'none';
                
                if (!password) {
                    passwordError.textContent = 'Please enter a password.';
                    passwordError.style.display = 'block';
                    return;
                }
                
                if (password === sharedGallery.password) {
                    // Password correct, store access token in session storage
                    sessionStorage.setItem(`gallery_access_${shareId}`, 'granted');
                    
                    // Load the gallery
                    loadGalleryContent(sharedGallery.galleryId, sharedGallery.photographerId);
                } else {
                    // Show error
                    passwordError.textContent = 'Incorrect password. Please try again.';
                    passwordError.style.display = 'block';
                    
                    // Clear the password field
                    document.getElementById('galleryPassword').value = '';
                    document.getElementById('galleryPassword').focus();
                }
            };
            
            // Set up button click handler
            document.getElementById('submitPasswordBtn').addEventListener('click', handlePasswordSubmit);
            
            // Set up enter key handler for password input
            document.getElementById('galleryPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handlePasswordSubmit();
                }
            });
        }
        
        // Load gallery content with additional security
        function loadGalleryContent(galleryId, photographerId) {
            console.log("Loading gallery content for ID:", galleryId);
            
            // Hide password screen if visible
            document.getElementById('passwordScreen').style.display = 'none';
            
            // Show gallery container
            document.getElementById('galleryContainer').style.display = 'block';
            
            // Get reference to Firestore
            const db = firebase.firestore();
            
            // Get gallery details with additional security check
            db.collection('galleries').doc(galleryId)
                .get()
                .then(doc => {
                    if (!doc.exists) {
                        showPageError("Gallery not found.");
                        return;
                    }
                    
                    const gallery = doc.data();
                    console.log("Gallery details:", gallery);
                    
                    // Security check: Verify the gallery belongs to the correct photographer
                    if (photographerId && gallery.photographerId !== photographerId) {
                        showPageError("Gallery access error: Photographer mismatch.");
                        return;
                    }
                    
                    // Set gallery title
                    document.getElementById('galleryTitle').textContent = gallery.name || 'Shared Gallery';
                    
                    // Get photographer details
                    loadPhotographerDetails(gallery.photographerId);
                    
                    // Load photos with added security
                    loadGalleryPhotos(galleryId, db);
                })
                .catch(error => {
                    console.error("Error loading gallery details:", error);
                    showPageError("Error loading gallery details: " + error.message);
                });
        }

        
        // Load photographer details
        function loadPhotographerDetails(photographerId) {
            if (!photographerId) {
                console.log("No photographer ID provided");
                return;
            }
            
            const db = firebase.firestore();
            
            // Try to find the photographer in the new collection name
            db.collection('photographer')
                .where('uid', '==', photographerId)
                .limit(1)
                .get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        console.log("No photographer found with ID:", photographerId);
                        return;
                    }
                    
                    const photographerData = snapshot.docs[0].data();
                    console.log("Photographer details:", photographerData);
                    
                    // Update studio information
                    const studioNameElement = document.getElementById('studioName');
                    if (studioNameElement) {
                        studioNameElement.textContent = photographerData.studioName || photographerData.ownerName || 'Photography Studio';
                    }
                    
                    // Update contact information
                    const studioContactElement = document.getElementById('studioContact');
                    if (studioContactElement) {
                        let contactText = "";
                        
                        if (photographerData.ownerName) {
                            contactText += `${photographerData.ownerName}`;
                        }
                        
                        if (photographerData.ownerEmail) {
                            contactText += ` | Email: ${photographerData.ownerEmail}`;
                        }
                        
                        if (photographerData.ownerNumber) {
                            contactText += ` | Phone: ${photographerData.ownerNumber}`;
                        }
                        
                        if (photographerData.studioAddress) {
                            contactText += ` | Address: ${photographerData.studioAddress}`;
                            
                            if (photographerData.studioPincode) {
                                contactText += `, ${photographerData.studioPincode}`;
                            }
                        }
                        
                        studioContactElement.textContent = contactText || 'No contact information available';
                    }
                })
                .catch(error => {
                    console.error("Error loading photographer details:", error);
                });
        }
        
        // Load gallery photos
        function loadGalleryPhotos(galleryId, db) {
            // Show loading toast
            showToast("Loading photos...", 'info');

            
            db.collection('photos')
                .where('galleryId', '==', galleryId)
                .where('status', '==', 'active')
                .limit(50) // Increased limit for better gallery experience
                .get()
                .then(snapshot => {
                    const photosGrid = document.getElementById('photosGrid');
                    photosGrid.innerHTML = '';
                    
                    if (snapshot.empty) {
                        photosGrid.innerHTML = '<p>No photos in this gallery yet.</p>';
                        return;
                    }
                    
                    // Store all photos in the global array
                    allGalleryPhotos = snapshot.docs.map(doc => doc.data());
                    
                    // Create elements for each photo
                    allGalleryPhotos.forEach(photo => {
                        const photoElement = createPhotoElement(photo);
                        photosGrid.appendChild(photoElement);
                    });
                    
                    // Show success toast
                    showToast("Gallery loaded successfully", 'success');
                })
                .catch(error => {
                    console.error("Error loading photos:", error);
                    showError("Error loading photos: " + error.message);
                });
        }


        
        // Create a photo element
        function createPhotoElement(photo) {
            const photoItem = document.createElement('div');
            photoItem.className = 'photo-item';
            
            const photoContainer = document.createElement('div');
            photoContainer.className = 'photo-container';
            photoContainer.style.backgroundImage = `url(${photo.thumbnailUrl || photo.url})`;
            photoContainer.setAttribute('tabindex', '0'); // Make focusable for keyboard navigation
            photoContainer.setAttribute('role', 'img');
            photoContainer.setAttribute('aria-label', photo.name || 'Photo');
            
            // Add protection layer
            /*const protectionLayer = document.createElement('div');
            protectionLayer.className = 'protection-layer';
            photoContainer.appendChild(protectionLayer);
            */
            
            const photoDetails = document.createElement('div');
            photoDetails.className = 'photo-details';
            
            const photoName = document.createElement('div');
            photoName.className = 'photo-name';
            photoName.textContent = photo.name || 'Photo';
            
            const photoDate = document.createElement('div');
            photoDate.className = 'photo-date';
            if (photo.uploadedAt) {
                const date = photo.uploadedAt.toDate ? photo.uploadedAt.toDate() : new Date(photo.uploadedAt);
                photoDate.textContent = date.toLocaleDateString();
            }
            
            photoDetails.appendChild(photoName);
            photoDetails.appendChild(photoDate);
            
            photoItem.appendChild(photoContainer);
            photoItem.appendChild(photoDetails);
            
            // Make photo clickable to open lightbox
            photoContainer.addEventListener('click', function() {
                openLightbox(photo);
            });
            
            // Keyboard handler for accessibility
            photoContainer.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    openLightbox(photo);
                }
            });
            
            return photoItem;
        }
        
        // Function to stop slideshow
        function stopSlideshow() {
            if (slideshowInterval) {
                clearInterval(slideshowInterval);
                slideshowInterval = null;
            }
        }
        
        // Navigate to a specific photo in the lightbox
        function navigateToPhoto(index, lightbox, imageContainer) {
            if (index < 0 || index >= allGalleryPhotos.length) return;
            
            // Update current image with fade effect
            const currentImg = lightbox.querySelector('.lightbox-image');
            currentImg.classList.remove('fadeIn');
            currentImg.classList.add('fadeOut');
            
            // Reset zoom level
            currentImg.style.transform = 'scale(1)';
            lightbox.querySelector('.zoom-level-text').textContent = '100%';
            
            setTimeout(() => {
                // Update image source
                const newPhoto = allGalleryPhotos[index];
                currentImg.src = newPhoto.url;
                currentImg.dataset.index = index;
                currentImg.alt = newPhoto.name || 'Gallery photo';
                
                // Update caption if exists
                const caption = imageContainer.querySelector('.photo-caption');
                if (caption) {
                    caption.textContent = newPhoto.name || '';
                }
                
                // Update active thumbnail
                const thumbnailsContainer = lightbox.querySelector('.thumbnails-container');
                const thumbnails = thumbnailsContainer.querySelectorAll('.thumbnail');
                thumbnails.forEach((thumb, i) => {
                    if (i === index) {
                        thumb.classList.add('active');
                        thumb.scrollIntoView({ behavior: 'smooth', inline: 'center' });
                    } else {
                        thumb.classList.remove('active');
                    }
                });

                
                // Update navigation buttons
                const prevButton = lightbox.querySelector('.modal-prev');
                const nextButton = lightbox.querySelector('.modal-next');
                
                if (prevButton) {
                    prevButton.remove();
                }
                
                if (nextButton) {
                    nextButton.remove();
                }
                
                // Add prev button if not first photo
                if (index > 0) {
                    const newPrevButton = document.createElement('button');
                    newPrevButton.className = 'modal-nav-button modal-prev';
                    newPrevButton.innerHTML = '<i class="fas fa-chevron-left"></i>';
                    newPrevButton.setAttribute('aria-label', 'Previous photo');
                    newPrevButton.addEventListener('click', function(e) {
                        e.stopPropagation();
                        navigateToPhoto(index - 1, lightbox, imageContainer);
                    });
                    imageContainer.appendChild(newPrevButton);
                }
                
                // Add next button if not last photo
                if (index < allGalleryPhotos.length - 1) {
                    const newNextButton = document.createElement('button');
                    newNextButton.className = 'modal-nav-button modal-next';
                    newNextButton.innerHTML = '<i class="fas fa-chevron-right"></i>';
                    newNextButton.setAttribute('aria-label', 'Next photo');
                    newNextButton.addEventListener('click', function(e) {
                        e.stopPropagation();
                        navigateToPhoto(index + 1, lightbox, imageContainer);
                    });
                    imageContainer.appendChild(newNextButton);
                }
                
                // Update rating buttons
                const photoId = newPhoto.id || newPhoto.url;
                const ratingButtons = lightbox.querySelectorAll('.rating-btn');
                ratingButtons.forEach(btn => {
                    btn.classList.remove('selected');
                    if (photoRatings[photoId] === btn.getAttribute('data-rating')) {
                        btn.classList.add('selected');
                    }
                });
                
                // Fade in the new image
                currentImg.classList.remove('fadeOut');
                currentImg.classList.add('fadeIn');
            }, 300);
        }
        
        // Close the lightbox
        function closeLightbox() {
            stopSlideshow();
            const lightbox = document.getElementById('photoLightbox');
            if (lightbox) {
                lightbox.classList.add('fadeOut');
                setTimeout(() => {
                    document.body.removeChild(lightbox);
                }, 300);
            }
        }
        
        // Toggle slideshow
        function toggleSlideshow(slideshowButton, lightbox) {
            const slideshowIcon = slideshowButton.querySelector('i');
            
            if (slideshowInterval) {
                // Stop slideshow
                stopSlideshow();
                slideshowIcon.className = 'fas fa-play';
                slideshowButton.setAttribute('aria-label', 'Start slideshow');
            } else {
                // Start slideshow
                slideshowIcon.className = 'fas fa-pause';
                slideshowButton.setAttribute('aria-label', 'Pause slideshow');
                
                slideshowInterval = setInterval(() => {
                    const currentImg = lightbox.querySelector('.lightbox-image');
                    const currentIndex = parseInt(currentImg.dataset.index);
                    const imageContainer = lightbox.querySelector('.lightbox-image-container');
                    
                    if (currentIndex < allGalleryPhotos.length - 1) {
                        navigateToPhoto(currentIndex + 1, lightbox, imageContainer);
                    } else {
                        navigateToPhoto(0, lightbox, imageContainer); // Loop back to first image
                    }
                }, 3000); // Change image every 3 seconds
            }
        }

        
        // Open lightbox with enhanced features
        function openLightbox(photo) {
            // Stop any running slideshow
            stopSlideshow();
            
            // Find current photo index
            const currentIndex = allGalleryPhotos.findIndex(p => 
                p.url === photo.url || (p.id && p.id === photo.id)
            );
            
            // The photo ID for ratings
            const photoId = photo.id || photo.url;
            
            // Create lightbox container
            const lightbox = document.createElement('div');
            lightbox.className = 'photo-lightbox';
            lightbox.id = 'photoLightbox';
            lightbox.tabIndex = 0; // Make it focusable
            
            // Add a toolbar for controls
            const toolbar = document.createElement('div');
            toolbar.className = 'lightbox-toolbar';
            
            // Slideshow button
            const slideshowButton = document.createElement('button');
            slideshowButton.className = 'modal-button';
            slideshowButton.innerHTML = '<i class="fas fa-play"></i>';
            slideshowButton.setAttribute('aria-label', 'Start slideshow');
            slideshowButton.addEventListener('click', function(e) {
                e.stopPropagation();
                toggleSlideshow(slideshowButton, lightbox);
            });
            toolbar.appendChild(slideshowButton);

                // Download button
            const downloadButton = document.createElement('button');
            downloadButton.className = 'modal-button';
            downloadButton.innerHTML = '<i class="fas fa-download"></i>';
            downloadButton.setAttribute('aria-label', 'Download photo');
            downloadButton.addEventListener('click', function(e) {
                e.stopPropagation();
                
                // Create a download link
                const link = document.createElement('a');
                link.href = photo.url;
                link.download = photo.name || 'photo.jpg';
                link.target = '_blank';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
            toolbar.appendChild(downloadButton);
            
            // Close button
            const closeButton = document.createElement('button');
            closeButton.className = 'modal-button';
            closeButton.innerHTML = '<i class="fas fa-times"></i>';
            closeButton.setAttribute('aria-label', 'Close');
            closeButton.addEventListener('click', function(e) {
                e.stopPropagation();
                closeLightbox();
            });
            toolbar.appendChild(closeButton);
            
            lightbox.appendChild(toolbar);
            
            // Create image container
            const imageContainer = document.createElement('div');
            imageContainer.className = 'lightbox-image-container';
            
            // Current zoom level
            let zoomLevel = 1;
            
            // Create zoom controls
            const zoomControls = document.createElement('div');
            zoomControls.className = 'zoom-controls';
            
            const zoomInBtn = document.createElement('button');
            zoomInBtn.className = 'zoom-btn';
            zoomInBtn.innerHTML = '<i class="fas fa-search-plus"></i>';
            zoomInBtn.setAttribute('aria-label', 'Zoom in');
            
            const zoomOutBtn = document.createElement('button');
            zoomOutBtn.className = 'zoom-btn';
            zoomOutBtn.innerHTML = '<i class="fas fa-search-minus"></i>';
            zoomOutBtn.setAttribute('aria-label', 'Zoom out');
            
            const zoomLevelDisplay = document.createElement('div');
            zoomLevelDisplay.style.color = 'white';
            zoomLevelDisplay.style.textAlign = 'center';
            zoomLevelDisplay.style.marginTop = '5px';
            zoomLevelDisplay.className = 'zoom-level-text';
            zoomLevelDisplay.textContent = '100%';
            
            // Add zoom handlers
            zoomInBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                if (zoomLevel < 3) { // Max zoom 3x
                    zoomLevel += 0.25;
                    const img = lightbox.querySelector('.lightbox-image');
                    img.style.transform = `scale(${zoomLevel})`;
                    zoomLevelDisplay.textContent = `${Math.round(zoomLevel * 100)}%`;
                }
            });
            
            zoomOutBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                if (zoomLevel > 0.5) { // Min zoom 0.5x
                    zoomLevel -= 0.25;
                    const img = lightbox.querySelector('.lightbox-image');
                    img.style.transform = `scale(${zoomLevel})`;
                    zoomLevelDisplay.textContent = `${Math.round(zoomLevel * 100)}%`;
                }
            });
            
            zoomControls.appendChild(zoomInBtn);
            zoomControls.appendChild(zoomOutBtn);
            zoomControls.appendChild(zoomLevelDisplay);

            
            // Create the main image with protection
            const img = document.createElement('img');
            img.className = 'lightbox-image fadeIn';
            img.src = photo.url;
            img.dataset.index = currentIndex;
            img.alt = photo.name || 'Gallery photo';
            img.draggable = false;
            img.crossOrigin = "anonymous";
            
            // Add watermark overlay
            const watermarkOverlay = document.createElement('div');
            watermarkOverlay.className = 'image-watermark';
            imageContainer.appendChild(watermarkOverlay);
            
            // Add watermark text
            const watermarkText = document.createElement('div');
            watermarkText.className = 'watermark-text';
            watermarkText.textContent = 'SnapSelect ¬© 2025';
            imageContainer.appendChild(watermarkText);
            
            // Add protection layer
            const protectionLayer = document.createElement('div');
            protectionLayer.className = 'protection-layer';
            protectionLayer.addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent closing when clicking on protection layer
            });
            imageContainer.appendChild(protectionLayer);
            
            // Add navigation buttons
            if (currentIndex > 0) {
                const prevButton = document.createElement('button');
                prevButton.className = 'modal-nav-button modal-prev';
                prevButton.innerHTML = '<i class="fas fa-chevron-left"></i>';
                prevButton.setAttribute('aria-label', 'Previous photo');
                prevButton.addEventListener('click', function(e) {
                    e.stopPropagation();
                    navigateToPhoto(currentIndex - 1, lightbox, imageContainer);
                });
                imageContainer.appendChild(prevButton);
            }
            
            if (currentIndex < allGalleryPhotos.length - 1) {
                const nextButton = document.createElement('button');
                nextButton.className = 'modal-nav-button modal-next';
                nextButton.innerHTML = '<i class="fas fa-chevron-right"></i>';
                nextButton.setAttribute('aria-label', 'Next photo');
                nextButton.addEventListener('click', function(e) {
                    e.stopPropagation();
                    navigateToPhoto(currentIndex + 1, lightbox, imageContainer);
                });
                imageContainer.appendChild(nextButton);
            }
            
            // Add caption if available
            if (photo.name) {
                const caption = document.createElement('div');
                caption.className = 'photo-caption';
                caption.style.position = 'absolute';
                caption.style.bottom = '160px'; // Above ratings and thumbnails
                caption.style.left = '0';
                caption.style.width = '100%';
                caption.style.textAlign = 'center';
                caption.style.color = 'white';
                caption.style.padding = '10px';
                caption.style.backgroundColor = 'rgba(0,0,0,0.5)';
                caption.textContent = photo.name;
                caption.style.overflow = 'hidden';
                caption.style.textOverflow = 'ellipsis';
                caption.style.whiteSpace = 'normal';
                caption.style.maxWidth = '100%';
                imageContainer.appendChild(caption);
            }
            
            // Add rating container
            const ratingContainer = document.createElement('div');
            ratingContainer.className = 'rating-container';
            
            // Create rating buttons
            const heartBtn = createRatingButton('‚ù§Ô∏è', 'Must have', 'heart', photoId);
            const thumbsUpBtn = createRatingButton('üëç', 'Would Like to Have', 'thumbsUp', photoId);
            const thinkingBtn = createRatingButton('ü§î', 'Alternative Option', 'thinking', photoId);
            const thumbsDownBtn = createRatingButton('üëé', 'Not Interested', 'thumbsDown', photoId);
            
            ratingContainer.appendChild(heartBtn);
            ratingContainer.appendChild(thumbsUpBtn);
            ratingContainer.appendChild(thinkingBtn);
            ratingContainer.appendChild(thumbsDownBtn);
            
            imageContainer.appendChild(img);
            imageContainer.appendChild(ratingContainer);
            imageContainer.appendChild(zoomControls);
            lightbox.appendChild(imageContainer);

            
            // Add thumbnails container
            const thumbnailsContainer = document.createElement('div');
            thumbnailsContainer.className = 'thumbnails-container';
            
            // Add thumbnails for all photos
            allGalleryPhotos.forEach((p, index) => {
                const thumb = document.createElement('img');
                thumb.className = 'thumbnail';
                thumb.src = p.thumbnailUrl || p.url;
                thumb.draggable = false;
                if (index === currentIndex) {
                    thumb.classList.add('active');
                }
                thumb.addEventListener('click', function(e) {
                    e.stopPropagation();
                    navigateToPhoto(index, lightbox, imageContainer);
                });
                thumbnailsContainer.appendChild(thumb);
            });
            
            lightbox.appendChild(thumbnailsContainer);
            
            // Add touch swipe functionality for mobile
            let touchStartX = 0;
            let touchEndX = 0;
            
            lightbox.addEventListener('touchstart', function(e) {
                touchStartX = e.changedTouches[0].screenX;
            });
            
            lightbox.addEventListener('touchend', function(e) {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            });
            
            function handleSwipe() {
                const swipeThreshold = 50;
                if (touchEndX < touchStartX - swipeThreshold && currentIndex < allGalleryPhotos.length - 1) {
                    // Swipe left - next photo
                    navigateToPhoto(currentIndex + 1, lightbox, imageContainer);
                } else if (touchEndX > touchStartX + swipeThreshold && currentIndex > 0) {
                    // Swipe right - previous photo
                    navigateToPhoto(currentIndex - 1, lightbox, imageContainer);
                }
            }
            
            // Handle keyboard navigation
            lightbox.addEventListener('keydown', function(e) {
                switch (e.key) {
                    case 'Escape':
                        closeLightbox();
                        break;
                    case 'ArrowLeft':
                        if (currentIndex > 0) {
                            navigateToPhoto(currentIndex - 1, lightbox, imageContainer);
                        }
                        break;
                    case 'ArrowRight':
                        if (currentIndex < allGalleryPhotos.length - 1) {
                            navigateToPhoto(currentIndex + 1, lightbox, imageContainer);
                        }
                        break;
                    case ' ': // Space bar
                        toggleSlideshow(slideshowButton, lightbox);
                        break;
                    case '+':
                        // Zoom in
                        if (zoomLevel < 3) {
                            zoomLevel += 0.25;
                            img.style.transform = `scale(${zoomLevel})`;
                            zoomLevelDisplay.textContent = `${Math.round(zoomLevel * 100)}%`;
                        }
                        break;
                    case '-':
                        // Zoom out
                        if (zoomLevel > 0.5) {
                            zoomLevel -= 0.25;
                            img.style.transform = `scale(${zoomLevel})`;
                            zoomLevelDisplay.textContent = `${Math.round(zoomLevel * 100)}%`;
                        }
                        break;
                }
            });
            
            // Close when clicking on the background (but not on controls)
            lightbox.addEventListener('click', function(e) {
                if (e.target === lightbox) {
                    closeLightbox();
                }
            });
            
            // Add lightbox to page
            document.body.appendChild(lightbox);
            
            // Focus for keyboard navigation
            lightbox.focus();
            
            // Scroll the active thumbnail into view
            const activeThumb = thumbnailsContainer.querySelector('.thumbnail.active');
            if (activeThumb) {
                activeThumb.scrollIntoView({ behavior: 'smooth', inline: 'center' });
            }
        }

        
        // Show page error (full page error)
        function showPageError(message) {
            console.error("Page error:", message);
            
            // Hide loading indicator and other containers
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('passwordScreen').style.display = 'none';
            document.getElementById('galleryContainer').style.display = 'none';
            
            // Show error page
            const errorPage = document.getElementById('errorPage');
            errorPage.style.display = 'block';
            
            // Set error message
            document.getElementById('errorMessage').textContent = message;
            
            // Setup retry button
            document.getElementById('retryBtn').addEventListener('click', function() {
                // Reload the page
                window.location.reload();
            });
        }
        
        // Show error message as toast
        function showError(message) {
            // Show toast notification
            showToast(message, 'error');
        }
        
        // Show toast notification
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            
            // Add aria-live for accessibility
            toast.setAttribute('aria-live', type === 'error' ? 'assertive' : 'polite');
            
            toastContainer.appendChild(toast);
            
            // Remove toast after 4 seconds (a bit longer for better readability)
            setTimeout(() => {
                toast.classList.add('fadeOut');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 4000);
        }
    </script>
</body>
</html>
